<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>üåô‚òâ Calendario Lunar y Solar v11.7 FINAL FIX</title>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="Calendario lunar completo con fases exactas, aspectos planetarios, diario personal y agenda. Para Costa Rica UTC-6.">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Luna üåô">
    
    <!-- Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- iOS Icons -->
    <link rel="apple-touch-icon" href="icon-152.png">
    <link rel="apple-touch-icon" sizes="72x72" href="icon-72.png">
    <link rel="apple-touch-icon" sizes="192x192" href="icon-192.png">
    <link rel="apple-touch-icon" sizes="512x512" href="icon-512.png">
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="icon-72.png">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #fff;
            min-height: 100vh;
            padding: 8px;
            overflow-x: hidden;
        }

        .container {
            width: 100%;
            margin: 0 auto;
            padding: 0 20px;
        }

        header {
            text-align: center;
            margin-bottom: 10px;
        }

        h1 {
            font-size: 1.4em;
            margin-bottom: 3px;
            background: linear-gradient(45deg, #f0e68c, #fff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            color: #a8b2d1;
            font-size: 0.75em;
        }

        .navigation {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 6px;
            background: rgba(255, 255, 255, 0.05);
            padding: 8px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
            gap: 8px;
            flex-wrap: nowrap;
        }

        .nav-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            padding: 6px 12px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 0.7em;
            transition: transform 0.2s;
            white-space: nowrap;
        }

        .nav-btn:hover {
            transform: scale(1.05);
        }

        .cycle-info {
            text-align: center;
            flex: 1;
            min-width: 0;
        }

        .cycle-number {
            font-size: 0.9em;
            font-weight: bold;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .cycle-dates {
            color: #a8b2d1;
            font-size: 0.7em;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .current-day-info {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            padding: 4px;
            border-radius: 6px;
            text-align: center;
            margin-bottom: 4px;
        }

        .lunar-weeks {
            display: flex;
            flex-direction: column;
            gap: 2px;
            margin-bottom: 5px;
        }

        .lunar-week {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 4px;
            padding: 4px;
            backdrop-filter: blur(10px);
            border: 1px solid transparent;
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        /* Days container within each week - 8 COLUMNS FOR LUNAR WEEKS */
        .lunar-week > div:not(.week-header) {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 4px;
            width: 100%;
        }

        .lunar-week:hover {
            border-color: rgba(255, 255, 255, 0.2);
        }

        .lunar-week.active {
            border-color: #f0e68c;
            box-shadow: 0 0 10px rgba(240, 230, 140, 0.3);
        }

        .week-header {
            display: flex;
            align-items: center;
            gap: 2px;
            flex-wrap: nowrap;
        }

        .moon-icon {
            font-size: 0.75em;
            filter: drop-shadow(0 0 4px rgba(240, 230, 140, 0.5));
        }

        .week-info {
            display: flex;
            align-items: center;
            gap: 4px;
            flex: 1;
            flex-wrap: nowrap;
            overflow: hidden;
        }

        .week-title-group {
            display: flex;
            align-items: center;
            gap: 3px;
        }

        .week-title {
            font-size: 0.7em;
            font-weight: bold;
            white-space: nowrap;
        }

        .week-duration {
            background: rgba(255, 255, 255, 0.1);
            padding: 1px 4px;
            border-radius: 8px;
            font-size: 0.6em;
            white-space: nowrap;
        }

        .week-details {
            display: none; /* Ocultar detalles para ahorrar espacio */
        }

        .week-dates {
            white-space: nowrap;
        }

        .perfection-time {
            color: #f0e68c;
            font-style: italic;
            white-space: nowrap;
        }

        .zodiac-sign {
            color: #f0e68c;
            white-space: nowrap;
        }

        .days-container {
            display: flex;
            gap: 4px;
            overflow-x: auto;
            padding: 2px 0;
            -webkit-overflow-scrolling: touch;
        }

        .days-container::-webkit-scrollbar {
            height: 3px;
        }

        .days-container::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 2px;
        }

        .days-container::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 2px;
        }

        .day-cell {
            min-width: 100px;
            min-height: 80px;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            justify-content: flex-start;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
            font-size: 0.75em;
            transition: all 0.2s;
            cursor: pointer;
            padding: 6px;
            position: relative;
            overflow: hidden;
        }

        .day-cell:hover {
            background: rgba(255, 255, 255, 0.12);
            transform: scale(1.02);
        }

        .day-cell.today {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-weight: bold;
            box-shadow: 0 0 8px rgba(102, 126, 234, 0.5);
        }

        .day-cell.weekend {
            background: rgba(255, 193, 7, 0.12);
            border: 1px solid rgba(255, 193, 7, 0.3);
        }

        .day-cell.weekend:hover {
            background: rgba(255, 193, 7, 0.22);
            border-color: rgba(255, 193, 7, 0.5);
        }

        .day-cell.weekend.today {
            background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%);
            box-shadow: 0 6px 20px rgba(255, 193, 7, 0.4);
        }
            border: none;
        }

        .day-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            margin-bottom: 3px;
            padding-bottom: 2px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .day-number {
            font-size: 0.95em;
            font-weight: bold;
            line-height: 1;
            flex: 0 0 auto;
        }

        .day-right {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            flex: 0 0 auto;
        }

        .day-date {
            font-size: 0.55em;
            color: rgba(255, 255, 255, 0.6);
            text-align: right;
            line-height: 1;
        }

        .day-weekday {
            font-size: 0.5em;
            color: rgba(255, 255, 255, 0.5);
            margin-top: 0px;
            text-transform: uppercase;
            font-weight: 600;
            letter-spacing: 0.1px;
            line-height: 1;
        }

        .day-cell.weekend .day-weekday {
            color: #667eea;
            font-weight: bold;
        }

        .day-cell.today .day-date,
        .day-cell.today .day-weekday {
            color: rgba(255, 255, 255, 0.9);
        }

        .day-content {
            width: 100%;
            font-size: 0.5em;
            display: flex;
            flex-direction: row;
            gap: 3px;
            overflow: hidden;
            max-height: 28px;
            align-items: flex-start;
            justify-content: space-between;
        }

        .day-event-item {
            background: rgba(0, 0, 0, 0.2);
            padding: 0px 2px;
            border-radius: 2px;
            border-left: 2px solid #667eea;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 1.1;
            font-size: 0.9em;
        }

        .day-event-item.type-reminder {
            border-left-color: #f5576c;
        }

        .day-event-item.type-appointment {
            border-left-color: #f0e68c;
        }

        .day-cell.today .day-event-item {
            background: rgba(255, 255, 255, 0.15);
        }

        .event-time-badge {
            font-size: 0.75em;
            font-weight: bold;
            color: #f0e68c;
            background: rgba(240, 230, 140, 0.15);
            padding: 1px 3px;
            border-radius: 2px;
            margin-right: 3px;
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
        }

        .modal.show {
            display: block;
        }

        .modal-content {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            margin: 5% auto;
            padding: 30px;
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            width: 90%;
            max-width: 700px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            max-height: 85vh;
            overflow-y: auto;
        }

        .modal-content::-webkit-scrollbar {
            width: 8px;
        }

        .modal-content::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
        }

        .modal-content::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .modal-header h2 {
            font-size: 1.5em;
            color: #f0e68c;
        }

        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s;
        }

        .close:hover {
            color: #fff;
        }

        /* Aspects modal specific */
        .aspects-section {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .aspects-section h3 {
            color: #f0e68c;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .aspect-detail {
            background: rgba(0, 0, 0, 0.2);
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 10px;
            border-left: 4px solid;
        }

        .aspect-detail.conjunction {
            border-left-color: #ff6b6b;
        }

        .aspect-detail.sextile {
            border-left-color: #4ecdc4;
        }

        .aspect-detail.square {
            border-left-color: #ff9f43;
        }

        .aspect-detail.trine {
            border-left-color: #5f27cd;
        }

        .aspect-detail.opposition {
            border-left-color: #ee5a6f;
        }

        .aspect-planets {
            font-size: 1.1em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .aspect-description {
            font-size: 0.9em;
            color: #a8b2d1;
        }

        .journal-section {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 10px;
        }

        .journal-section h3 {
            color: #f0e68c;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .journal-textarea {
            width: 100%;
            min-height: 150px;
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 12px;
            color: #fff;
            font-family: inherit;
            font-size: 0.95em;
            resize: vertical;
            line-height: 1.6;
        }

        .journal-textarea:focus {
            outline: none;
            border-color: #667eea;
            background: rgba(0, 0, 0, 0.3);
        }

        .journal-textarea::placeholder {
            color: rgba(255, 255, 255, 0.4);
        }

        .journal-meta {
            margin-top: 10px;
            font-size: 0.85em;
            color: #a8b2d1;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .auto-save-indicator {
            color: #4ecdc4;
        }

        /* Events modal specific */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #a8b2d1;
            font-size: 0.9em;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: #fff;
            font-size: 1em;
            font-family: inherit;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            background: rgba(255, 255, 255, 0.08);
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 25px;
        }

        .btn {
            flex: 1;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s;
            font-weight: 600;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .btn-danger {
            background: linear-gradient(135deg, #f5576c 0%, #f093fb 100%);
            color: white;
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(245, 87, 108, 0.4);
        }

        .events-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .event-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #667eea;
        }

        .event-item.type-reminder {
            border-left-color: #f5576c;
        }

        .event-item.type-appointment {
            border-left-color: #f0e68c;
        }

        .event-title {
            font-weight: bold;
            font-size: 1.1em;
            margin-bottom: 5px;
        }

        .event-time {
            color: #a8b2d1;
            font-size: 0.85em;
            margin-bottom: 5px;
        }

        .event-description {
            color: #ccc;
            font-size: 0.9em;
            margin-top: 5px;
        }

        .event-actions {
            margin-top: 10px;
            display: flex;
            gap: 10px;
        }

        .event-actions button {
            padding: 5px 12px;
            font-size: 0.85em;
        }

        .no-events, .no-aspects {
            text-align: center;
            color: #a8b2d1;
            padding: 30px;
            font-style: italic;
        }

        .legend {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 15px;
            margin-top: 30px;
        }

        .legend h3 {
            margin-bottom: 15px;
        }

        .legend-items {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .legend-icon {
            font-size: 1.5em;
        }

        .aspects-legend {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .aspect-legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(255, 255, 255, 0.05);
            padding: 8px;
            border-radius: 6px;
            font-size: 0.85em;
        }

        .aspect-color-bar {
            width: 3px;
            height: 30px;
            border-radius: 2px;
        }

        @media (max-width: 768px) {
            body {
                padding: 5px;
            }
            
            header {
                margin-bottom: 8px;
            }
            
            header > div {
                flex-direction: column !important;
                gap: 8px !important;
            }
            
            header > div > div:first-child {
                display: none !important; /* Hide left spacer on mobile */
            }
            
            header > div > div:last-child {
                justify-content: center !important; /* Center flags on mobile */
                width: 100% !important;
                flex: none !important;
            }
            
            /* Make language flags and notification button smaller on mobile */
            #notificationBtn, #langES, #langEN {
                font-size: 1em !important;
                padding: 4px 8px !important;
            }
            
            h1 {
                font-size: 1.1em;
                margin-bottom: 3px;
            }
            
            .subtitle {
                font-size: 0.65em;
            }
            
            /* Solar calendar mobile - allow horizontal scroll */
            body.solar-mode #solarWeeks {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            body.solar-mode .lunar-week {
                min-width: 800px; /* Force horizontal scroll for 10 columns */
            }
            
            body.solar-mode .lunar-week > div:not(.week-header) {
                display: grid !important;
                grid-template-columns: repeat(10, 1fr) !important;
            }
            
            body.solar-mode .day-cell {
                min-width: 75px;
                min-height: 70px;
            }
            
            body.solar-mode .day-cell.weekend {
                background: rgba(212, 175, 55, 0.15);
                border: 1px solid rgba(212, 175, 55, 0.3);
            }
            
            body.solar-mode .day-cell.weekend:hover {
                background: rgba(212, 175, 55, 0.25);
                border-color: rgba(212, 175, 55, 0.5);
            }

            .navigation {
                flex-direction: row;
                justify-content: center;
                align-items: center;
                gap: 8px;
                padding: 6px 8px;
                margin-bottom: 4px;
                flex-wrap: nowrap;
            }
            
            .nav-btn {
                padding: 5px 10px;
                font-size: 0.65em;
                flex-shrink: 0;
            }
            
            .cycle-info {
                flex: 0 1 auto;
                min-width: 0;
            }
            
            .cycle-number {
                font-size: 0.8em;
                white-space: nowrap;
            }
            
            .cycle-dates {
                font-size: 0.65em;
                white-space: nowrap;
            }
            
            .current-day-info {
                padding: 4px;
                margin-bottom: 4px;
            }

            .week-header {
                flex-direction: row;
                align-items: center;
                gap: 2px;
            }

            .week-info {
                flex-direction: row;
                align-items: center;
                gap: 2px;
                flex: 1;
            }

            .week-title {
                font-size: 0.65em;
            }

            .week-details {
                display: none;
            }
            
            .moon-icon {
                font-size: 0.7em;
            }

            .days-container {
                gap: 4px;
            }

            .lunar-week > div:not(.week-header) {
                grid-template-columns: repeat(8, 1fr);
                gap: 2px;
            }

            .day-cell {
                min-width: 60px;
                min-height: 65px;
                font-size: 0.7em;
                padding: 4px;
            }
            
            .day-number {
                font-size: 1em;
            }
            
            .day-date {
                font-size: 0.65em;
            }
            
            .day-weekday {
                font-size: 0.55em;
            }
            
            .day-content {
                max-height: 28px;
                font-size: 0.5em;
            }
            
            .lunar-weeks {
                gap: 2px;
                margin-bottom: 5px;
            }
            
            .lunar-week {
                padding: 2px 4px;
                gap: 2px;
            }

            .modal-content {
                width: 95%;
                margin: 10% auto;
                max-height: 90vh;
            }
        }
        
        /* ============================================ */
        /* TEMA SOLAR - Dorado C√°lido                  */
        /* ============================================ */
        body.solar-mode {
            background: linear-gradient(135deg, #2D1B00 0%, #3D2A0F 100%);
        }
        
        body.solar-mode .lunar-week {
            background: rgba(61, 42, 15, 0.4);
            border-left-color: #D4AF37 !important;
        }
        
        body.solar-mode .lunar-week > div:not(.week-header) {
            grid-template-columns: repeat(10, 1fr) !important;
        }
        
        body.solar-mode .day-cell {
            background: rgba(61, 42, 15, 0.6);
            border: 1px solid rgba(212, 175, 55, 0.2);
        }
        
        body.solar-mode .day-cell:hover {
            background: rgba(61, 42, 15, 0.8);
            border-color: rgba(212, 175, 55, 0.4);
            box-shadow: 0 4px 12px rgba(212, 175, 55, 0.3);
        }
        
        body.solar-mode .day-cell.today {
            background: rgba(212, 175, 55, 0.25);
            border: 2px solid #D4AF37;
            box-shadow: 0 0 20px rgba(212, 175, 55, 0.5);
        }
        
        body.solar-mode .day-number {
            color: #D4AF37;
        }
        
        body.solar-mode .day-date,
        body.solar-mode .day-weekday {
            color: #FFF8DC;
        }
        
        body.solar-mode .subtitle {
            color: #C19A6B;
        }
        
        body.solar-mode .navigation {
            background: rgba(212, 175, 55, 0.1);
        }
        
        body.solar-mode .nav-btn {
            background: linear-gradient(135deg, #D4AF37 0%, #C19A6B 100%);
        }
        
        body.solar-mode .week-header {
            background: rgba(212, 175, 55, 0.15);
        }
        
        body.solar-mode .moon-icon {
            color: #D4AF37;
            text-shadow: 0 0 10px rgba(212, 175, 55, 0.5);
        }
        
        body.solar-mode h1 {
            background: linear-gradient(45deg, #D4AF37, #FFF8DC);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        /* Planet buttons hover effect */
        .planet-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(255, 255, 255, 0.3);
        }
        
        .planet-btn:active {
            transform: scale(0.98);
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div style="display: flex; justify-content: space-between; align-items: start;">
                <div style="flex: 1;"></div>
                <div style="flex: 1; text-align: center;">
                    <h1 id="calendarTitle">üåô Calendario Lunar Astrol√≥gico</h1>
                    <p class="subtitle">Ciclo natural de la Luna ‚Ä¢ Aspectos Planetarios ‚Ä¢ Diario Personal</p>
                </div>
                <!-- Language Flags -->
                <div style="flex: 1; display: flex; justify-content: flex-end; gap: 8px; padding: 5px;">
                    <button id="notificationBtn" onclick="toggleNotifications()" style="background: transparent; border: 2px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 6px 10px; cursor: pointer; font-size: 1.2em; transition: all 0.3s; opacity: 0.5;" title="Activar notificaciones">
                        üîî
                    </button>
                    <button id="langES" style="background: transparent; border: 2px solid rgba(255,255,255,0.3); border-radius: 8px; padding: 8px 12px; cursor: pointer; font-size: 1.5em; transition: all 0.3s; box-shadow: 0 2px 8px rgba(0,0,0,0.2);">
                        üá™üá∏
                    </button>
                    <button id="langEN" style="background: transparent; border: 2px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 8px 12px; cursor: pointer; font-size: 1.5em; transition: all 0.3s; opacity: 0.5;">
                        üá∫üá∏
                    </button>
                </div>
            </div>
            
            <!-- Toggle Lunar/Solar -->
            <div style="display: flex; gap: 10px; justify-content: center; margin-top: 15px;">
                <button id="lunarModeBtn" onclick="switchToLunarMode()" style="padding: 10px 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; border-radius: 25px; color: white; font-weight: bold; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 15px rgba(102,126,234,0.4);">
                    üåô Lunar
                </button>
                <button id="solarModeBtn" onclick="switchToSolarMode()" style="padding: 10px 20px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 25px; color: rgba(255,255,255,0.6); font-weight: bold; cursor: pointer; transition: all 0.3s;">
                    ‚òâ Solar
                </button>
            </div>
        </header>

        <div class="navigation" id="lunarNavigation">
            <button class="nav-btn" onclick="previousCycle()">‚Üê Ciclo Anterior</button>
            <div class="cycle-info">
                <div class="cycle-number" id="cycleNumber">Ciclo Lunar</div>
                <div class="cycle-dates" id="cycleDates"></div>
            </div>
            <button class="nav-btn" onclick="nextCycle()">Ciclo Siguiente ‚Üí</button>
        </div>

        <div class="current-day-info" id="currentDayInfo"></div>

        <div class="lunar-weeks" id="lunarWeeks"></div>

        <div class="legend">
            <h3 id="planetaryAspectsTitle">ü™ê Aspectos Planetarios 2026</h3>
            <p id="planetaryAspectsSubtitle" style="font-size: 0.9em; color: #a8b2d1; margin-bottom: 15px;">
                Haz click en un planeta para ver todos sus aspectos durante el a√±o
            </p>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-bottom: 20px;">
                <button onclick="showPlanetAspects('Sol', '‚òâ', '#FFD700')" class="planet-btn" style="background: rgba(255, 215, 0, 0.2); border: 2px solid #FFD700; color: #FFD700; padding: 12px; border-radius: 10px; cursor: pointer; font-size: 1em; font-weight: bold; transition: all 0.3s;">
                    <span id="planetBtn-Sol">‚òâ Sol</span>
                </button>
                <button onclick="showPlanetAspects('Mercurio', '‚òø', '#f39c12')" class="planet-btn" style="background: rgba(243, 156, 18, 0.2); border: 2px solid #f39c12; color: #f39c12; padding: 12px; border-radius: 10px; cursor: pointer; font-size: 1em; font-weight: bold; transition: all 0.3s;">
                    <span id="planetBtn-Mercurio">‚òø Mercurio</span>
                </button>
                <button onclick="showPlanetAspects('Venus', '‚ôÄ', '#e91e63')" class="planet-btn" style="background: rgba(233, 30, 99, 0.2); border: 2px solid #e91e63; color: #e91e63; padding: 12px; border-radius: 10px; cursor: pointer; font-size: 1em; font-weight: bold; transition: all 0.3s;">
                    <span id="planetBtn-Venus">‚ôÄ Venus</span>
                </button>
                <button onclick="showPlanetAspects('Marte', '‚ôÇ', '#ff6b6b')" class="planet-btn" style="background: rgba(255, 107, 107, 0.2); border: 2px solid #ff6b6b; color: #ff6b6b; padding: 12px; border-radius: 10px; cursor: pointer; font-size: 1em; font-weight: bold; transition: all 0.3s;">
                    <span id="planetBtn-Marte">‚ôÇ Marte</span>
                </button>
                <button onclick="showPlanetAspects('J√∫piter', '‚ôÉ', '#9b59b6')" class="planet-btn" style="background: rgba(155, 89, 182, 0.2); border: 2px solid #9b59b6; color: #9b59b6; padding: 12px; border-radius: 10px; cursor: pointer; font-size: 1em; font-weight: bold; transition: all 0.3s;">
                    <span id="planetBtn-J√∫piter">‚ôÉ J√∫piter</span>
                </button>
                <button onclick="showPlanetAspects('Saturno', '‚ôÑ', '#3498db')" class="planet-btn" style="background: rgba(52, 152, 219, 0.2); border: 2px solid #3498db; color: #3498db; padding: 12px; border-radius: 10px; cursor: pointer; font-size: 1em; font-weight: bold; transition: all 0.3s;">
                    <span id="planetBtn-Saturno">‚ôÑ Saturno</span>
                </button>
                <button onclick="showPlanetAspects('Urano', '‚ôÖ', '#1abc9c')" class="planet-btn" style="background: rgba(26, 188, 156, 0.2); border: 2px solid #1abc9c; color: #1abc9c; padding: 12px; border-radius: 10px; cursor: pointer; font-size: 1em; font-weight: bold; transition: all 0.3s;">
                    <span id="planetBtn-Urano">‚ôÖ Urano</span>
                </button>
                <button onclick="showPlanetAspects('Neptuno', '‚ôÜ', '#5dade2')" class="planet-btn" style="background: rgba(93, 173, 226, 0.2); border: 2px solid #5dade2; color: #5dade2; padding: 12px; border-radius: 10px; cursor: pointer; font-size: 1em; font-weight: bold; transition: all 0.3s;">
                    <span id="planetBtn-Neptuno">‚ôÜ Neptuno</span>
                </button>
                <button onclick="showPlanetAspects('Plut√≥n', '‚ôá', '#7f8c8d')" class="planet-btn" style="background: rgba(127, 140, 141, 0.2); border: 2px solid #7f8c8d; color: #7f8c8d; padding: 12px; border-radius: 10px; cursor: pointer; font-size: 1em; font-weight: bold; transition: all 0.3s;">
                    <span id="planetBtn-Plut√≥n">‚ôá Plut√≥n</span>
                </button>
            </div>
            
            <div id="aspectsLegendDiv" style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 10px; font-size: 0.85em; color: #a8b2d1;">
                <strong>Leyenda de Aspectos:</strong><br>
                ‚òå Conjunci√≥n (0¬∞) ‚Ä¢ ‚öπ Sextil (60¬∞) ‚Ä¢ ‚ñ° Cuadratura (90¬∞) ‚Ä¢ ‚ñ≥ Tr√≠gono (120¬∞) ‚Ä¢ ‚òç Oposici√≥n (180¬∞)
            </div>
        </div>
    </div>

    <!-- Modal de Aspectos del Planeta -->
    <div id="planetAspectsModal" class="modal">
        <div class="modal-content" style="max-width: 700px; max-height: 80vh; overflow-y: auto;">
            <div class="modal-header">
                <h2 id="planetAspectsTitle">Aspectos del Planeta</h2>
                <span class="close" onclick="closePlanetAspectsModal()">&times;</span>
            </div>
            <div id="planetAspectsBody" style="padding: 20px;">
                <!-- Content will be filled by JS -->
            </div>
        </div>
    </div>

    <!-- Modal de Opciones del D√≠a -->
    <div id="dayOptionsModal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <h2>Opciones del D√≠a</h2>
            <p id="dayOptionsDate" style="text-align: center; margin-bottom: 20px;"></p>
            <button onclick="selectDayOption('agenda')" style="width: 100%; padding: 15px; margin-bottom: 10px; background: #4ecdc4; border: none; border-radius: 8px; color: white; font-size: 1em; cursor: pointer; transition: all 0.2s;">
                üìÖ Agenda / Eventos
            </button>
            <button id="aspectsOptionBtn" onclick="selectDayOption('aspectos')" style="width: 100%; padding: 15px; margin-bottom: 10px; background: #f0e68c; border: none; border-radius: 8px; color: #1a1a2e; font-size: 1em; cursor: pointer; transition: all 0.2s; font-weight: bold;">
                ‚≠ê Aspectos Planetarios (<span id="aspectsCount">0</span>)
            </button>
            <button onclick="selectDayOption('diario')" style="width: 100%; padding: 15px; margin-bottom: 10px; background: #9b59b6; border: none; border-radius: 8px; color: white; font-size: 1em; cursor: pointer; transition: all 0.2s;">
                üìù Diario Personal y Reflexiones
            </button>
            <button onclick="closeDayOptionsModal()" style="width: 100%; padding: 15px; background: rgba(255,255,255,0.1); border: none; border-radius: 8px; color: white; font-size: 1em; cursor: pointer; transition: all 0.2s;">
                ‚ùå Cancelar
            </button>
        </div>
    </div>

    <!-- Modal de Aspectos y Diario -->
    <div id="aspectsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="aspectsModalTitle">Aspectos Planetarios del D√≠a</h2>
                <span class="close" onclick="closeAspectsModal()">&times;</span>
            </div>
            <div id="aspectsModalBody">
                <!-- Aspectos -->
                <div class="aspects-section">
                    <h3>‚≠ê Aspectos del D√≠a</h3>
                    <div id="aspectsDetails"></div>
                </div>

                <div class="button-group">
                    <button class="btn btn-secondary" onclick="closeAspectsModal()">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Eventos/Agenda -->
    <div id="eventsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="eventsModalTitle">Eventos y Agenda</h2>
                <span class="close" onclick="closeEventsModal()">&times;</span>
            </div>
            <div id="eventsModalBody">
                <!-- Formulario para nuevo evento -->
                <div id="eventForm">
                    <h3 style="color: #f0e68c; margin-bottom: 15px;">Agregar Evento</h3>
                    <div class="form-group">
                        <label>Tipo de Evento</label>
                        <select id="eventType">
                            <option value="event">Evento</option>
                            <option value="appointment">Cita</option>
                            <option value="reminder">Recordatorio</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>T√≠tulo *</label>
                        <input type="text" id="eventTitle" placeholder="Nombre del evento" required>
                    </div>
                    <div class="form-group">
                        <label>Hora (opcional)</label>
                        <input type="time" id="eventTime">
                    </div>
                    <div class="form-group">
                        <label>Descripci√≥n</label>
                        <textarea id="eventDescription" placeholder="Detalles adicionales..."></textarea>
                    </div>
                    <div class="button-group">
                        <button class="btn btn-secondary" onclick="closeEventsModal()">Cancelar</button>
                        <button class="btn btn-primary" onclick="saveEvent()">Guardar Evento</button>
                    </div>
                </div>

                <!-- Lista de eventos del d√≠a -->
                <div id="eventsList" style="display: none;">
                    <h3 style="color: #f0e68c; margin-bottom: 15px;">Eventos Agendados</h3>
                    <div class="events-list" id="eventsContainer"></div>
                    <div class="button-group">
                        <button class="btn btn-secondary" onclick="closeEventsModal()">Cerrar</button>
                        <button class="btn btn-primary" onclick="showEventForm()">Agregar Evento</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Diario -->
    <div id="diarioModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h2 id="diarioModalTitle">üìì Diario Personal</h2>
                <span class="close" onclick="closeDiarioModal()">&times;</span>
            </div>
            <div style="padding: 20px;">
                <p id="diarioDate" style="text-align: center; color: rgba(255,255,255,0.7); margin-bottom: 20px;"></p>
                <textarea 
                    class="journal-textarea" 
                    id="diarioText"
                    placeholder="Escribe tus reflexiones del d√≠a, c√≥mo te sientes, qu√© observas...

Ejemplos:
‚Ä¢ Hoy me sent√≠ m√°s optimista
‚Ä¢ Not√© mucha energ√≠a f√≠sica  
‚Ä¢ Conversaci√≥n importante
‚Ä¢ Reflexiones sobre...
‚Ä¢ Sue√±os y observaciones..."
                    style="width: 100%; min-height: 300px; padding: 15px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: white; font-size: 1em; resize: vertical;"></textarea>
                <div style="display: flex; justify-content: space-between; margin-top: 10px;">
                    <div id="diarioSaveStatus" style="color: #4ecdc4;"></div>
                    <div id="diarioWordCount" style="color: #a8b2d1;"></div>
                </div>
                <button onclick="closeDiarioModal()" style="width: 100%; padding: 12px; margin-top: 15px; background: rgba(255,255,255,0.1); border: none; border-radius: 8px; color: white; cursor: pointer;">Cerrar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Eclipse -->
    <div id="eclipseModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2 id="eclipseModalTitle">Eclipse</h2>
                <span class="close" onclick="closeEclipseModal()">&times;</span>
            </div>
            <div id="eclipseModalBody" style="padding: 20px;">
                <!-- Content will be filled by JS -->
            </div>
        </div>
    </div>

    <!-- Modal de Retrogradaci√≥n -->
    <div id="retrogradeModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2 id="retrogradeModalTitle">Retrogradaci√≥n</h2>
                <span class="close" onclick="closeRetrogradeModal()">&times;</span>
            </div>
            <div id="retrogradeModalBody" style="padding: 20px;">
                <!-- Content will be filled by JS -->
            </div>
        </div>
    </div>

    <!-- Modal de Cambio de Signo -->
    <div id="signChangeModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2 id="signChangeModalTitle">Cambio de Signo</h2>
                <span class="close" onclick="closeSignChangeModal()">&times;</span>
            </div>
            <div id="signChangeModalBody" style="padding: 20px;">
                <!-- Content will be filled by JS -->
            </div>
        </div>
    </div>

    <!-- Modal de Stellium -->
    <div id="stelliumModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2 id="stelliumModalTitle">Stellium</h2>
                <span class="close" onclick="closeStelliumModal()">&times;</span>
            </div>
            <div id="stelliumModalBody" style="padding: 20px;">
                <!-- Content will be filled by JS -->
            </div>
        </div>
    </div>

    <!-- Modal de Aspecto Mayor -->
    <div id="majorAspectModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2 id="majorAspectModalTitle">Configuraci√≥n Planetaria</h2>
                <span class="close" onclick="closeMajorAspectModal()">&times;</span>
            </div>
            <div id="majorAspectModalBody" style="padding: 20px;">
                <!-- Content will be filled by JS -->
            </div>
        </div>
    </div>


    <script>
// ==============================================
// C√ÅLCULOS ASTRON√ìMICOS Y LUNARES
// ==============================================

// S√≠mbolos planetarios
const planetSymbols = {
    sun: '‚òâ',
    mercury: '‚òø',
    venus: '‚ôÄ',
    mars: '‚ôÇ',
    jupiter: '‚ôÉ',
    saturn: '‚ôÑ',
    uranus: '‚ôÖ',
    neptune: '‚ôÜ',
    pluto: '‚ôá',
    chiron: '‚ö∑',
    lilith: '‚ö∏'
};

const planetNames = {
    sun: 'Sol',
    mercury: 'Mercurio',
    venus: 'Venus',
    mars: 'Marte',
    jupiter: 'J√∫piter',
    saturn: 'Saturno',
    uranus: 'Urano',
    neptune: 'Neptuno',
    pluto: 'Plut√≥n',
    chiron: 'Quir√≥n',
    lilith: 'Lilith'
};

const aspectDescriptions = {
    conjunction: 'Fusi√≥n energ√©tica. Lo emocional y lo representado se vuelven indistinguibles. Intensificaci√≥n mutua.',
    sextile: 'Flujo facilitado. Oportunidad que requiere intenci√≥n. Colaboraci√≥n entre dominios.',
    square: 'Fricci√≥n productiva. Tensi√≥n que demanda ajuste. Incomodidad que puede generar movimiento.',
    trine: 'Resonancia natural. Facilidad que puede derivar en pasividad. Armon√≠a sin esfuerzo.',
    opposition: 'Polarizaci√≥n consciente. Necesidad de integrar opuestos. Balanceo entre extremos.'
};

// Nombres tradicionales de las lunas llenas
function getFullMoonName(date) {
    const month = date.getMonth();
    const names = [
        'Luna del Lobo', 'Luna de Nieve', 'Luna del Gusano', 'Luna Rosa',
        'Luna de Flores', 'Luna de Fresa', 'Luna del Ciervo', 'Luna del Esturi√≥n',
        'Luna de Cosecha', 'Luna del Cazador', 'Luna del Castor', 'Luna Fr√≠a'
    ];
    return names[month];
}

// Calcular Julian Day
function getJulianDay(date) {
    const year = date.getFullYear();
    const month = date.getMonth() + 1;
    const day = date.getDate() + date.getHours() / 24;
    
    let a = Math.floor((14 - month) / 12);
    let y = year + 4800 - a;
    let m = month + 12 * a - 3;
    
    return day + Math.floor((153 * m + 2) / 5) + 365 * y + 
           Math.floor(y / 4) - Math.floor(y / 100) + 
           Math.floor(y / 400) - 32045;
}

// Calcular posici√≥n de la Luna
function getMoonPosition(date) {
    const jd = getJulianDay(date);
    const T = (jd - 2451545.0) / 36525;
    
    // Longitud media de la Luna
    let L = 218.3164477 + 481267.88123421 * T 
          - 0.0015786 * T * T 
          + T * T * T / 538841 
          - T * T * T * T / 65194000;
    
    // Anomal√≠a media de la Luna
    const M = 134.9633964 + 477198.8675055 * T 
            + 0.0087414 * T * T 
            + T * T * T / 69699 
            - T * T * T * T / 14712000;
    
    // Elongaci√≥n media Sol-Luna
    const D = 297.8501921 + 445267.1114034 * T 
            - 0.0018819 * T * T 
            + T * T * T / 545868 
            - T * T * T * T / 113065000;
    
    // Argumento de latitud
    const F = 93.2720950 + 483202.0175233 * T 
            - 0.0036539 * T * T 
            - T * T * T / 3526000 
            + T * T * T * T / 863310000;
    
    // Correcciones principales
    const deg2rad = Math.PI / 180;
    L = L + 6.289 * Math.sin(M * deg2rad);
    L = L - 1.274 * Math.sin((M - 2 * D) * deg2rad);
    L = L + 0.658 * Math.sin(2 * D * deg2rad);
    L = L + 0.214 * Math.sin(2 * M * deg2rad);
    L = L - 0.186 * Math.sin((M + 2 * D) * deg2rad);
    L = L - 0.114 * Math.sin(2 * F * deg2rad);
    L = L - 0.059 * Math.sin((2 * M - 2 * D) * deg2rad);
    L = L - 0.057 * Math.sin((M + 2 * F) * deg2rad);
    L = L + 0.053 * Math.sin((M + 2 * D) * deg2rad);
    L = L + 0.046 * Math.sin((2 * D - M) * deg2rad);
    L = L + 0.041 * Math.sin((M - 2 * F) * deg2rad);
    L = L - 0.035 * Math.sin(D * deg2rad);
    L = L - 0.031 * Math.sin((M + 2 * F) * deg2rad);
    
    let moonLongitude = L % 360;
    if (moonLongitude < 0) moonLongitude += 360;
    
    return moonLongitude;
}

// Calcular posici√≥n planetaria (simplificado)
function getPlanetPosition(planet, date) {
    if (planet === 'moon') {
        return getMoonPosition(date);
    }
    
    const jd = getJulianDay(date);
    const T = (jd - 2451545.0) / 36525;
    
    const positions = {
        sun: 280.46646 + 36000.76983 * T,
        mercury: 252.25 + 149472.51529 * T,
        venus: 181.98 + 58517.81539 * T,
        mars: 355.43 + 19140.30268 * T,
        jupiter: 34.35 + 3034.74612 * T,
        saturn: 50.08 + 1222.49362 * T,
        uranus: 314.05 + 428.48202 * T,
        neptune: 304.35 + 218.48600 * T,
        pluto: 238.93 + 145.20780 * T,
        chiron: 139.52 + 15.09376 * T,
        lilith: 83.35 + 40.66246 * T
    };
    
    let longitude = positions[planet] % 360;
    if (longitude < 0) longitude += 360;
    
    return longitude;
}

// Obtener signo zodiacal desde longitud
function getZodiacSignFromLongitude(longitude) {
    const signs = [
        '‚ôà Aries', '‚ôâ Tauro', '‚ôä G√©minis', '‚ôã C√°ncer', 
        '‚ôå Leo', '‚ôç Virgo', '‚ôé Libra', '‚ôè Escorpio', 
        '‚ôê Sagitario', '‚ôë Capricornio', '‚ôí Acuario', '‚ôì Piscis'
    ];
    const signIndex = Math.floor(longitude / 30);
    return signs[signIndex];
}

// Obtener signo zodiacal con grado
function getZodiacSignWithDegree(longitude) {
    const signs = [
        '‚ôà Aries', '‚ôâ Tauro', '‚ôä G√©minis', '‚ôã C√°ncer', 
        '‚ôå Leo', '‚ôç Virgo', '‚ôé Libra', '‚ôè Escorpio', 
        '‚ôê Sagitario', '‚ôë Capricornio', '‚ôí Acuario', '‚ôì Piscis'
    ];
    const signIndex = Math.floor(longitude / 30);
    const degreeInSign = longitude % 30;
    const minutes = Math.floor((degreeInSign % 1) * 60);
    const degrees = Math.floor(degreeInSign);
    
    return {
        sign: signs[signIndex],
        degree: degrees,
        minute: minutes,
        formatted: `${degrees}¬∞${minutes.toString().padStart(2, '0')}' ${signs[signIndex]}`
    };
}

// Calcular signo zodiacal de la Luna
function getMoonZodiacSign(date) {
    const moonLongitude = getMoonPosition(date);
    return getZodiacSignFromLongitude(moonLongitude);
}

// Calcular aspectos planetarios
function calculateAspects(date) {
    const aspects = [];
    const moonLongitude = getMoonPosition(date);
    
    const aspectTypes = [
        { name: 'conjunction', symbol: '‚òå', angle: 0, orb: 8, class: 'conjunction' },
        { name: 'sextile', symbol: '‚öπ', angle: 60, orb: 4, class: 'sextile' },
        { name: 'square', symbol: '‚ñ°', angle: 90, orb: 8, class: 'square' },
        { name: 'trine', symbol: '‚ñ≥', angle: 120, orb: 8, class: 'trine' },
        { name: 'opposition', symbol: '‚òç', angle: 180, orb: 8, class: 'opposition' }
    ];
    
    const planets = ['sun', 'mercury', 'venus', 'mars', 'jupiter', 'saturn', 'uranus', 'neptune', 'pluto', 'chiron', 'lilith'];
    
    for (const planet of planets) {
        const planetLongitude = getPlanetPosition(planet, date);
        let diff = Math.abs(moonLongitude - planetLongitude);
        
        if (diff > 180) diff = 360 - diff;
        
        for (const aspect of aspectTypes) {
            const aspectDiff = Math.abs(diff - aspect.angle);
            
            if (aspectDiff <= aspect.orb) {
                const planetSign = getZodiacSignFromLongitude(planetLongitude);
                
                aspects.push({
                    type: aspect.name,
                    symbol: aspect.symbol,
                    planet: planet,
                    planetSymbol: planetSymbols[planet],
                    planetName: planetNames[planet],
                    planetSign: planetSign,
                    exactness: aspect.orb - aspectDiff,
                    class: aspect.class,
                    description: aspectDescriptions[aspect.name]
                });
            }
        }
    }
    
    aspects.sort((a, b) => b.exactness - a.exactness);
    
    return aspects;
}

// C√°lculo de fase lunar (elongaci√≥n)
function calculateLunarPhase(date) {
    const jd = getJulianDay(date);
    const T = (jd - 2451545.0) / 36525;
    const L0 = 280.46646 + 36000.76983 * T;
    const L = 218.3165 + 481267.8813 * T;
    
    let elongation = (L - L0) % 360;
    if (elongation < 0) elongation += 360;
    
    return elongation;
}

function getMoonEmoji(elongation) {
    if (elongation < 22.5 || elongation >= 337.5) return 'üåë';
    if (elongation < 67.5) return 'üåí';
    if (elongation < 112.5) return 'üåì';
    if (elongation < 157.5) return 'üåî';
    if (elongation < 202.5) return 'üåï';
    if (elongation < 247.5) return 'üåñ';
    if (elongation < 292.5) return 'üåó';
    return 'üåò';
}

function getPhaseData(date) {
    const phase = calculateLunarPhase(date);
    let phaseName, weekIndex;
    
    if (phase < 0.05 || phase >= 0.95) {
        phaseName = 'Luna Nueva';
        weekIndex = 0;
    } else if (phase < 0.275) {
        phaseName = 'Cuarto Creciente';
        weekIndex = 1;
    } else if (phase < 0.525) {
        phaseName = 'Luna Llena';
        weekIndex = 2;
    } else if (phase < 0.775) {
        phaseName = 'Cuarto Menguante';
        weekIndex = 3;
    } else {
        phaseName = 'Luna Nueva';
        weekIndex = 0;
    }
    
    return { phase, phaseName, weekIndex, emoji: getMoonEmoji(phase) };
}

function findExactPerfection(startDate, targetDegree) {
    let date = new Date(startDate);
    let minDiff = 360;
    let bestDate = new Date(date);
    
    for (let day = 0; day < 10; day++) {
        for (let hour = 0; hour < 24; hour++) {
            let testDate = new Date(startDate);
            testDate.setDate(testDate.getDate() + day);
            testDate.setHours(hour, 0, 0, 0);
            
            let elongation = calculateLunarPhase(testDate);
            let diff = Math.abs(elongation - targetDegree);
            
            if (diff > 180) diff = 360 - diff;
            
            if (diff < minDiff) {
                minDiff = diff;
                bestDate = new Date(testDate);
            }
        }
    }
    
    return bestDate;
}

function findLunarPerfections(startDate) {
    const perfections = [];
    const phases = [
        { name: 'Luna Nueva', degree: 0, emoji: 'üåë' },
        { name: 'Cuarto Creciente', degree: 90, emoji: 'üåì' },
        { name: 'Luna Llena', degree: 180, emoji: 'üåï' },
        { name: 'Cuarto Menguante', degree: 270, emoji: 'üåó' }
    ];
    
    let searchDate = new Date(startDate);
    
    for (let i = 0; i < phases.length; i++) {
        const phase = phases[i];
        const perfectionDate = findExactPerfection(searchDate, phase.degree);
        const zodiacSign = getMoonZodiacSign(perfectionDate);
        
        let fullName = phase.name;
        if (phase.name === 'Luna Llena') {
            fullName = getFullMoonName(perfectionDate);
        }
        
        perfections.push({
            name: fullName,
            emoji: phase.emoji,
            date: perfectionDate,
            degree: phase.degree,
            zodiacSign: zodiacSign
        });
        
        searchDate = new Date(perfectionDate);
        searchDate.setDate(searchDate.getDate() + 1);
    }
    
    return perfections;
}

// Fechas exactas de Lunas Nuevas (datos astron√≥micos reales)
// Fuente: NASA/Observatorio Naval de EE.UU. + CHANI Astrology
const newMoonDates = [
    // 2024
    new Date('2024-12-01T06:21:00Z'),
    new Date('2024-12-30T22:27:00Z'),
    
    // 2025
    new Date('2025-01-29T12:36:00Z'),
    new Date('2025-02-27T20:45:00Z'),
    new Date('2025-03-29T10:58:00Z'),
    new Date('2025-04-27T19:31:00Z'),
    new Date('2025-05-27T03:02:00Z'),
    new Date('2025-06-25T10:32:00Z'),
    new Date('2025-07-24T19:11:00Z'),
    new Date('2025-08-23T06:06:00Z'),
    new Date('2025-09-21T19:54:00Z'),
    new Date('2025-10-21T12:25:00Z'),
    new Date('2025-11-20T06:47:00Z'),
    new Date('2025-12-20T01:43:00Z'),
    
    // 2026 - VERIFICADO con m√∫ltiples fuentes
    new Date('2026-01-18T19:52:00Z'),
    new Date('2026-02-17T12:11:00Z'),  // CORREGIDO: era 12:01
    new Date('2026-03-18T02:23:00Z'),  // CORREGIDO: era 03-19 01:23
    new Date('2026-04-17T11:52:00Z'),
    new Date('2026-05-16T20:01:00Z'),
    new Date('2026-06-15T02:54:00Z'),
    new Date('2026-07-14T09:44:00Z'),
    new Date('2026-08-12T17:37:00Z'),
    new Date('2026-09-11T03:27:00Z'),
    new Date('2026-10-10T16:00:00Z'),
    new Date('2026-11-09T07:02:00Z'),
    new Date('2026-12-09T00:52:00Z'),
    
    // 2027
    new Date('2027-01-07T19:24:00Z'),
    new Date('2027-02-06T13:56:00Z'),
    new Date('2027-03-08T06:29:00Z'),
    new Date('2027-04-06T19:51:00Z'),
    new Date('2027-05-06T06:58:00Z'),
    new Date('2027-06-04T16:10:00Z'),
    new Date('2027-07-03T23:02:00Z'),
    new Date('2027-08-02T04:45:00Z'),
    new Date('2027-08-31T10:41:00Z'),
    new Date('2027-09-29T18:36:00Z'),
    new Date('2027-10-29T05:36:00Z'),
    new Date('2027-11-27T20:25:00Z'),
    new Date('2027-12-27T13:13:00Z')
];

// Convertir fechas UTC a hora local (Costa Rica UTC-6)
const newMoonsLocal = newMoonDates.map(date => {
    const localDate = new Date(date);
    localDate.setHours(localDate.getHours() - 6);
    return localDate;
});

// Eclipses 2026 (Costa Rica UTC-6)
// Helper para crear fechas en hora de Costa Rica (UTC-6)
function crDate(dateStr) {
    // Crear fecha en UTC y ajustar a Costa Rica
    const date = new Date(dateStr + 'T00:00:00-06:00');
    return date;
}

const eclipses2026 = [
    { 
        date: crDate('2026-02-17'),
        time: '07:01', // 7:01 AM EST
        type: 'solar', 
        name: 'Eclipse Solar Anular',
        degree: '28¬∞36\' ‚ôí Acuario',
        visibility: 'Visible en Ant√°rtida, sur de √Åfrica, sur del Oc√©ano √çndico',
        aspects: [
            { planet: 'Saturno', aspect: 'Conjunci√≥n', description: 'Estructura, responsabilidad' },
            { planet: 'J√∫piter', aspect: 'Sextil', description: 'Expansi√≥n, oportunidades' },
            { planet: 'Urano', aspect: 'Cuadratura', description: 'Cambios s√∫bitos, liberaci√≥n' }
        ]
    },
    { 
        date: crDate('2026-03-03'),
        time: '06:38', // 6:38 AM EST
        type: 'lunar', 
        name: 'Eclipse Lunar Total',
        degree: '12¬∞24\' ‚ôç Virgo',
        visibility: 'Visible en Am√©rica, Europa, √Åfrica',
        aspects: [
            { planet: 'Neptuno', aspect: 'Oposici√≥n', description: 'Claridad vs ilusi√≥n' },
            { planet: 'Plut√≥n', aspect: 'Tr√≠gono', description: 'Transformaci√≥n profunda' },
            { planet: 'Marte', aspect: 'Sextil', description: 'Acci√≥n constructiva' }
        ]
    },
    { 
        date: crDate('2026-08-12'),
        time: '13:36', // 1:36 PM EDT
        type: 'solar', 
        name: 'Eclipse Solar Total',
        degree: '20¬∞03\' ‚ôå Leo',
        visibility: 'Visible en Groenlandia, Islandia, Espa√±a',
        aspects: [
            { planet: 'Venus', aspect: 'Conjunci√≥n', description: 'Amor, valores, belleza' },
            { planet: 'J√∫piter', aspect: 'Cuadratura', description: 'Exceso, optimismo exagerado' }
        ]
    },
    { 
        date: crDate('2026-08-28'),
        time: '00:18', // 12:18 AM EDT
        type: 'lunar', 
        name: 'Eclipse Lunar Parcial',
        degree: '05¬∞07\' ‚ôì Piscis',
        visibility: 'Visible en Am√©rica, Europa, √Åfrica, Asia',
        aspects: [
            { planet: 'Saturno', aspect: 'Conjunci√≥n', description: 'L√≠mites, madurez emocional' },
            { planet: 'Urano', aspect: 'Sextil', description: 'Intuici√≥n, innovaci√≥n' }
        ]
    }
];

// Retrogradaciones 2026 (FECHAS VERIFICADAS - ChatGPT/Astrolog√≠a)
// Ajustadas a zona horaria Costa Rica (UTC-6)
const retrogrades2026 = [
    // Mercurio - Ciclo 1
    { 
        planet: 'Mercurio', symbol: '‚òø', 
        start: crDate('2026-01-01'), end: crDate('2026-01-18'),
        sign: 'Capricornio',
        meaning: 'Revisi√≥n de estructuras mentales. Retrasos funcionales en comunicaci√≥n. Reconsideraci√≥n de compromisos.',
        areas: 'Planes profesionales, autoridad, responsabilidad pragm√°tica'
    },
    // Mercurio - Ciclo 2
    { 
        planet: 'Mercurio', symbol: '‚òø', 
        start: crDate('2026-05-10'), end: crDate('2026-06-01'),
        sign: 'G√©minis ‚Üí Tauro',
        meaning: 'Pensamiento entre versatilidad y concreci√≥n. Necesidad de aterrizar ideas. Comunicaci√≥n requiere revisi√≥n.',
        areas: 'Intercambios, valores materiales, posesiones, aprendizaje'
    },
    // Mercurio - Ciclo 3
    { 
        planet: 'Mercurio', symbol: '‚òø', 
        start: crDate('2026-09-04'), end: crDate('2026-09-26'),
        sign: 'Libra ‚Üí Virgo',
        meaning: 'An√°lisis relacional. Perfeccionismo vs diplomacia. Reexamen de acuerdos y procesos.',
        areas: 'V√≠nculos, salud, trabajo detallado, cr√≠tica constructiva'
    },
    
    // Venus (MUY IMPORTANTE - cruza signo)
    { 
        planet: 'Venus', symbol: '‚ôÄ', 
        start: crDate('2026-03-09'), end: crDate('2026-04-20'),
        sign: 'Aries ‚Üí Piscis',
        meaning: 'Revisi√≥n de v√≠nculos y valores. Tensi√≥n entre afirmaci√≥n relacional y disoluci√≥n emp√°tica. Reconsideraci√≥n de deseos.',
        areas: 'Relaciones, autoestima, finanzas, receptividad, l√≠mites'
    },
    
    // Marte (Leo ‚Üî C√°ncer)
    { 
        planet: 'Marte', symbol: '‚ôÇ', 
        start: crDate('2026-10-13'), end: crDate('2026-11-28'),
        sign: 'Leo ‚Üí C√°ncer',
        meaning: 'Energ√≠a entre expresi√≥n dram√°tica y protecci√≥n emocional. Acci√≥n requiere reconsideraci√≥n. Voluntad vs necesidades afectivas.',
        areas: 'Iniciativa, hogar, familia, creatividad, seguridad'
    },
    
    // J√∫piter
    { 
        planet: 'J√∫piter', symbol: '‚ôÉ', 
        start: crDate('2026-06-22'), end: crDate('2026-10-20'),
        sign: 'C√°ncer ‚Üí G√©minis',
        meaning: 'Expansi√≥n requiere revisi√≥n. Tensi√≥n entre profundizaci√≥n emocional y dispersi√≥n mental. Crecimiento introspectivo.',
        areas: 'Familia, aprendizaje, viajes internos, significado'
    },
    
    // Saturno (TEMA FUERTE: estructura del yo ‚Üî disoluci√≥n del ego)
    { 
        planet: 'Saturno', symbol: '‚ôÑ', 
        start: crDate('2026-07-03'), end: crDate('2026-11-28'),
        sign: 'Aries ‚Üí Piscis',
        meaning: 'L√≠mites del yo requieren revisi√≥n. Tensi√≥n entre estructuraci√≥n de identidad y disoluci√≥n de fronteras. Responsabilidad vs rendici√≥n.',
        areas: 'Identidad, l√≠mites personales, espiritualidad, sacrificio'
    },
    
    // Urano (cruza a√±o)
    { 
        planet: 'Urano', symbol: '‚ôÖ', 
        start: crDate('2026-08-08'), end: crDate('2027-01-07'),
        sign: 'G√©minis ‚Üí Tauro',
        meaning: 'Innovaci√≥n comunicacional revisada. Tensi√≥n entre cambio mental y estabilidad material. Revoluci√≥n introspectiva.',
        areas: 'Tecnolog√≠a, pensamiento, valores, recursos, seguridad'
    },
    
    // Neptuno (acci√≥n consciente vs entrega espiritual)
    { 
        planet: 'Neptuno', symbol: '‚ôÜ', 
        start: crDate('2026-06-23'), end: crDate('2026-12-29'),
        sign: 'Aries ‚Üí Piscis',
        meaning: 'Idealismo entre afirmaci√≥n y rendici√≥n. Confusi√≥n sobre d√≥nde dirigir inspiraci√≥n. Espiritualidad requiere reconsideraci√≥n.',
        areas: 'Inspiraci√≥n, compasi√≥n, acci√≥n consciente, entrega'
    },
    
    // Plut√≥n (MUY SIMB√ìLICO: futuro colectivo ‚Üî poder antiguo)
    { 
        planet: 'Plut√≥n', symbol: '‚ôá', 
        start: crDate('2026-05-14'), end: crDate('2026-10-22'),
        sign: 'Acuario ‚Üí Capricornio',
        meaning: 'Transformaci√≥n entre futurismo colectivo y estructuras de poder establecidas. Revisi√≥n profunda de sistemas de control.',
        areas: 'Poder institucional, revoluci√≥n, estructuras sociales'
    }
];

// Cambios de Signo Planetarios 2026 (DATOS VERIFICADOS)
// Fuentes: Cafe Astrology, CHANI, Astro Butterfly
const signChanges2026 = [
    // SOL (Temporadas)
    { planet: 'Sol', symbol: '‚òâ', date: crDate('2026-01-19'), toSign: 'Acuario', meaning: '√ânfasis colectivo. Distancia necesaria para perspectiva. Pensamiento sist√©mico activado.', color: '#FFD700' },
    { planet: 'Sol', symbol: '‚òâ', date: crDate('2026-02-18'), toSign: 'Piscis', meaning: 'Disoluci√≥n de l√≠mites del yo. Mayor porosidad emocional. Necesidad de retiro o contemplaci√≥n.', color: '#FFD700' },
    { planet: 'Sol', symbol: '‚òâ', date: crDate('2026-03-20'), time: '14:46', toSign: 'Aries', meaning: 'EQUINOCCIO PRIMAVERA (14:46 UTC). Impulso hacia lo nuevo. Energ√≠a de iniciaci√≥n. Foco en identidad individual.', color: '#FFD700', isEquinox: true },
    { planet: 'Sol', symbol: '‚òâ', date: crDate('2026-04-19'), toSign: 'Tauro', meaning: 'Anclaje en lo material. Ritmo m√°s lento. Necesidad de estabilidad y tangibilidad.', color: '#FFD700' },
    { planet: 'Sol', symbol: '‚òâ', date: crDate('2026-05-20'), toSign: 'G√©minis', meaning: 'Activaci√≥n mental. Curiosidad incrementada. Multiplicidad de intereses simult√°neos.', color: '#FFD700' },
    { planet: 'Sol', symbol: '‚òâ', date: crDate('2026-06-21'), time: '08:25', toSign: 'C√°ncer', meaning: 'SOLSTICIO VERANO (08:25 UTC). √ânfasis emocional. Retorno a lo familiar. Sensibilidad al entorno aumentada.', color: '#FFD700', isSolstice: true },
    { planet: 'Sol', symbol: '‚òâ', date: crDate('2026-07-22'), toSign: 'Leo', meaning: 'Impulso expresivo. Necesidad de ser visto. Centralidad del yo. Creatividad activada.', color: '#FFD700' },
    { planet: 'Sol', symbol: '‚òâ', date: crDate('2026-08-23'), toSign: 'Virgo', meaning: 'An√°lisis de sistemas. Perfeccionamiento de procesos. Foco en utilidad pr√°ctica.', color: '#FFD700' },
    { planet: 'Sol', symbol: '‚òâ', date: crDate('2026-09-23'), time: '00:06', toSign: 'Libra', meaning: 'EQUINOCCIO OTO√ëO (00:06 UTC). √ânfasis relacional. B√∫squeda de equilibrio entre opuestos. Diplomacia necesaria.', color: '#FFD700', isEquinox: true },
    { planet: 'Sol', symbol: '‚òâ', date: crDate('2026-10-23'), toSign: 'Escorpio', meaning: 'Intensificaci√≥n ps√≠quica. Necesidad de profundizar. Confrontaci√≥n con lo oculto.', color: '#FFD700' },
    { planet: 'Sol', symbol: '‚òâ', date: crDate('2026-11-22'), toSign: 'Sagitario', meaning: 'Expansi√≥n de perspectiva. B√∫squeda de significado. Inquietud filos√≥fica o f√≠sica.', color: '#FFD700' },
    { planet: 'Sol', symbol: '‚òâ', date: crDate('2026-12-21'), time: '15:03', toSign: 'Capricornio', meaning: 'SOLSTICIO INVIERNO (15:03 UTC). Estructuraci√≥n necesaria. Enfrentamiento con l√≠mites. Ambici√≥n activada.', color: '#FFD700', isSolstice: true },
    
    // MERCURIO
    { planet: 'Mercurio', symbol: '‚òø', date: crDate('2026-01-01'), toSign: 'Capricornio', meaning: 'Comunicaci√≥n pr√°ctica, enfoque profesional', color: '#f39c12' },
    { planet: 'Mercurio', symbol: '‚òø', date: crDate('2026-01-20'), toSign: 'Acuario', meaning: 'Ideas innovadoras, pensamiento colectivo', color: '#f39c12' },
    { planet: 'Mercurio', symbol: '‚òø', date: crDate('2026-02-06'), toSign: 'Piscis', meaning: 'Intuici√≥n, comunicaci√≥n emocional', color: '#f39c12' },
    { planet: 'Mercurio', symbol: '‚òø', date: crDate('2026-04-14'), toSign: 'Aries', meaning: 'Comunicaci√≥n directa, decisiones r√°pidas', color: '#f39c12' },
    
    // VENUS
    { planet: 'Venus', symbol: '‚ôÄ', date: crDate('2026-01-17'), toSign: 'Acuario', meaning: 'Lo relacional se vuelve experimental. Atracci√≥n hacia lo poco convencional. Distancia emocional como forma de conexi√≥n.', color: '#e91e63' },
    { planet: 'Venus', symbol: '‚ôÄ', date: crDate('2026-02-10'), time: '05:19', toSign: 'Piscis', meaning: 'Mayor receptividad emocional. L√≠mites relacionales menos definidos. Vulnerabilidad incrementada. Idealizaci√≥n facilitada.', color: '#e91e63' },
    { planet: 'Venus', symbol: '‚ôÄ', date: crDate('2026-03-06'), toSign: 'Aries', meaning: 'Impulsos relacionales m√°s directos. Menor filtro entre deseo y acci√≥n. Impaciencia en v√≠nculos.', color: '#e91e63' },
    { planet: 'Venus', symbol: '‚ôÄ', date: crDate('2026-03-30'), toSign: 'Tauro', meaning: 'Anclaje en lo sensorial. B√∫squeda de estabilidad relacional. Necesidad de tangibilidad en afectos.', color: '#e91e63' },
    
    // MARTE
    { planet: 'Marte', symbol: '‚ôÇ', date: crDate('2026-02-05'), toSign: 'Leo', meaning: 'Acci√≥n orientada a visibilidad. Necesidad de reconocimiento en hacer. Energ√≠a dram√°tica.', color: '#ff6b6b' },
    { planet: 'Marte', symbol: '‚ôÇ', date: crDate('2026-04-18'), toSign: 'Virgo', meaning: 'Acci√≥n orientada a precisi√≥n. Irritabilidad con imperfecci√≥n. Energ√≠a aplicada a detalle.', color: '#ff6b6b' },
    { planet: 'Marte', symbol: '‚ôÇ', date: crDate('2026-05-31'), toSign: 'Libra', meaning: 'Acci√≥n mediada por consideraci√≥n. Dificultad para iniciativa directa. Energ√≠a en negociaci√≥n.', color: '#ff6b6b' },
    { planet: 'Marte', symbol: '‚ôÇ', date: crDate('2026-07-16'), toSign: 'Escorpio', meaning: 'Intensidad en acci√≥n. Estrategia sobre reactividad. Energ√≠a dirigida a profundidad.', color: '#ff6b6b' },
    { planet: 'Marte', symbol: '‚ôÇ', date: crDate('2026-09-04'), toSign: 'Sagitario', meaning: 'Acci√≥n exploratoria. Inquietud f√≠sica o filos√≥fica. Energ√≠a dispersa en m√∫ltiples direcciones.', color: '#ff6b6b' },
    
    // J√öPITER (MUY IMPORTANTE)
    { planet: 'J√∫piter', symbol: '‚ôÉ', date: crDate('2026-06-29'), toSign: 'Leo', meaning: 'CICLO ANUAL. Expansi√≥n a trav√©s de expresi√≥n. Oportunidades v√≠a visibilidad. Confianza en creatividad. (2026-2027)', color: '#9b59b6', isImportant: true },
    
    // SATURNO (CR√çTICO)
    { planet: 'Saturno', symbol: '‚ôÑ', date: crDate('2026-02-13'), toSign: 'Aries', meaning: 'CICLO MAYOR. Estructuraci√≥n de identidad. L√≠mites en autoafirmaci√≥n. Aprendizaje sobre autonom√≠a responsable. (hasta 2028-2029)', color: '#3498db', isCritical: true },
    
    // URANO (GENERACIONAL)
    { planet: 'Urano', symbol: '‚ôÖ', date: crDate('2026-07-07'), toSign: 'G√©minis', meaning: 'CAMBIO GENERACIONAL (7 a√±os). Revoluci√≥n en comunicaci√≥n y pensamiento. Tecnolog√≠a disruptiva en informaci√≥n.', color: '#1abc9c', isGenerational: true },
    
    // NEPTUNO (MEGA IMPORTANTE)
    { planet: 'Neptuno', symbol: '‚ôÜ', date: crDate('2026-01-26'), toSign: 'Aries', meaning: 'CAMBIO GENERACIONAL. Idealismo requiere acci√≥n. Espiritualidad menos pasiva. Confusi√≥n sobre identidad. (hasta 2039)', color: '#5dade2', isGenerational: true },
];

// Stelliums detectados 2026 (SOLO VERIFICADOS REALES)
const stelliums2026 = [
    { date: crDate('2026-01-04'), sign: 'Capricornio', planets: ['Venus', 'Sol', 'Marte'], count: 3 },
    { date: crDate('2026-01-21'), sign: 'Acuario', planets: ['Sol', 'Mercurio', 'Plut√≥n', 'Venus', 'Marte'], count: 5 }
];

// Aspectos Importantes 2026 (Configuraciones Mayores - Cafe Astrology)
const majorAspects2026 = [
    // T-Squares (Tensi√≥n productiva)
    {
        date: crDate('2026-09-30'),
        type: 'T-Square',
        planets: ['Marte', 'Plut√≥n', 'Mercurio'],
        signs: 'Virgo-Acuario-Sagitario',
        meaning: 'Tensi√≥n entre acci√≥n, transformaci√≥n y comunicaci√≥n. Momento de tomar decisiones dif√≠ciles.',
        impact: 'Desaf√≠os que impulsan crecimiento. Energ√≠a din√°mica para logros.'
    },
    {
        date: crDate('2026-12-07'),
        type: 'T-Square',
        planets: ['Urano', 'Mercurio', 'Marte'],
        signs: 'G√©minis-Sagitario-Virgo',
        meaning: 'Cambio s√∫bito, comunicaci√≥n urgente, acci√≥n necesaria. Crisis que genera oportunidad.',
        impact: 'Innovaci√≥n forzada. Soluciones creativas bajo presi√≥n.'
    },
    
    // Kite (Gran potencial)
    {
        date: crDate('2026-08-10'),
        type: 'Kite',
        planets: ['Plut√≥n', 'Urano', 'Mercurio', 'Venus'],
        signs: 'Acuario-G√©minis-Libra-Leo',
        meaning: 'Configuraci√≥n arm√≥nica con foco. Gran talento para manifestar cambios.',
        impact: 'Momento poderoso para transformaci√≥n creativa y relaciones.'
    },
    
    // Mystic Rectangle (Equilibrio din√°mico)
    {
        date: crDate('2026-08-10'),
        type: 'Mystic Rectangle',
        planets: ['Plut√≥n', 'Neptuno', 'Mercurio', 'Venus'],
        signs: 'Acuario-Aries-Libra-Leo',
        meaning: 'Balance entre espiritualidad y manifestaci√≥n. Sue√±os + acci√≥n.',
        impact: 'Talentos puestos al servicio de causas importantes.'
    }
];

// ASPECTOS ENTRE PLANETAS 2026 (Verificados - Cafe Astrology)
// Fuente: https://cafeastrology.com/2026-astrological-aspects.html
const interPlanetaryAspects2026 = [
    // SATURNO-NEPTUNO (MEGA IMPORTANTE)
    {
        date: crDate('2026-02-20'),
        time: '11:54',
        planet1: 'Saturno',
        planet2: 'Neptuno',
        aspect: 'Conjunci√≥n',
        symbol: '‚òå',
        degree: "0¬∞ Aries 45'",
        meaning: 'ASPECTO GENERACIONAL. Materializaci√≥n de ideales vs desilusi√≥n de estructuras. L√≠mites (Saturno) encuentran disoluci√≥n (Neptuno). Espiritualidad requiere concreci√≥n.',
        color: '#9b59b6',
        isGenerational: true
    },
    
    // VENUS-J√öPITER
    {
        date: crDate('2026-02-22'),
        time: '15:02',
        planet1: 'Venus',
        planet2: 'J√∫piter',
        aspect: 'Tr√≠gono',
        symbol: '‚ñ≥',
        degree: "15¬∞ Piscis 31' / 15¬∞ C√°ncer 31'",
        meaning: 'Armon√≠a entre afectos y expansi√≥n. Optimismo relacional. Generosidad emocional. Oportunidades en v√≠nculos.',
        color: '#4ecdc4'
    },
    {
        date: crDate('2026-03-18'),
        time: '12:09',
        planet1: 'Venus',
        planet2: 'J√∫piter',
        aspect: 'Cuadratura',
        symbol: '‚ñ°',
        degree: "15¬∞ Aries 11' / 15¬∞ C√°ncer 11'",
        meaning: 'Fricci√≥n entre deseo (Venus) y expansi√≥n (J√∫piter). Exceso en relaciones. Tensi√≥n entre independencia y seguridad.',
        color: '#ff6b6b'
    },
    
    // SATURNO-PLUT√ìN
    {
        date: crDate('2026-03-28'),
        time: '18:11',
        planet1: 'Saturno',
        planet2: 'Plut√≥n',
        aspect: 'Sextil',
        symbol: '‚öπ',
        degree: "5¬∞ Aries 10' / 5¬∞ Acuario 10'",
        meaning: 'Oportunidad entre estructura (Saturno) y transformaci√≥n (Plut√≥n). Cambio disciplinado. Poder responsable. Renovaci√≥n sistem√°tica.',
        color: '#1abc9c'
    },
    
    // J√öPITER-NEPTUNO
    {
        date: crDate('2026-07-20'),
        planet1: 'J√∫piter',
        planet2: 'Neptuno',
        aspect: 'Tr√≠gono',
        symbol: '‚ñ≥',
        degree: "4¬∞ Leo 22' / 4¬∞ Aries 22'",
        meaning: 'Armon√≠a entre expansi√≥n (J√∫piter) e inspiraci√≥n (Neptuno). Fe manifestada. Idealismo productivo. Crecimiento espiritual.',
        color: '#4ecdc4'
    },
    
    // J√öPITER-PLUT√ìN
    {
        date: crDate('2026-07-20'),
        planet1: 'J√∫piter',
        planet2: 'Plut√≥n',
        aspect: 'Oposici√≥n',
        symbol: '‚òç',
        degree: "4¬∞ Leo 26' / 4¬∞ Acuario 26'",
        meaning: 'Polarizaci√≥n entre expansi√≥n (J√∫piter) y poder (Plut√≥n). Ambici√≥n vs transformaci√≥n colectiva. Necesidad de integrar opuestos.',
        color: '#e91e63'
    },
    
    // J√öPITER-SATURNO
    {
        date: crDate('2026-08-31'),
        planet1: 'J√∫piter',
        planet2: 'Saturno',
        aspect: 'Tr√≠gono',
        symbol: '‚ñ≥',
        degree: "13¬∞ Leo 41' / 13¬∞ Aries 41'",
        meaning: 'Armon√≠a entre expansi√≥n (J√∫piter) y estructura (Saturno). Crecimiento disciplinado. Oportunidades realistas. Manifestaci√≥n sostenible.',
        color: '#4ecdc4',
        isImportant: true
    }
];

function getInterPlanetaryAspects(date) {
    const aspects = [];
    const targetYear = date.getFullYear();
    const targetMonth = date.getMonth();
    const targetDay = date.getDate();
    
    for (const aspect of interPlanetaryAspects2026) {
        const aspectDate = new Date(aspect.date);
        
        if (aspectDate.getFullYear() === targetYear &&
            aspectDate.getMonth() === targetMonth &&
            aspectDate.getDate() === targetDay) {
            aspects.push(aspect);
        }
    }
    return aspects;
}

function getMajorAspect(date) {
    const dateStr = new Date(date).setHours(0, 0, 0, 0);
    
    for (const aspect of majorAspects2026) {
        const aspectDate = new Date(aspect.date);
        aspectDate.setHours(0, 0, 0, 0);
        
        if (aspectDate.getTime() === dateStr) {
            return aspect;
        }
    }
    return null;
}

function getSignChanges(date) {
    const changes = [];
    const dateStr = new Date(date).setHours(0, 0, 0, 0);
    
    for (const change of signChanges2026) {
        const changeDate = new Date(change.date);
        changeDate.setHours(0, 0, 0, 0);
        
        if (changeDate.getTime() === dateStr) {
            changes.push(change);
        }
    }
    return changes;
}

function getStellium(date) {
    const dateStr = new Date(date).setHours(0, 0, 0, 0);
    
    for (const stellium of stelliums2026) {
        const stelliumDate = new Date(stellium.date);
        stelliumDate.setHours(0, 0, 0, 0);
        
        if (stelliumDate.getTime() === dateStr) {
            return stellium;
        }
    }
    return null;
}

function getEclipseInfo(date) {
    const dateStr = date.toDateString();
    for (const eclipse of eclipses2026) {
        if (eclipse.date.toDateString() === dateStr) {
            return eclipse;
        }
    }
    return null;
}

function getRetrogrades(date) {
    const retros = [];
    
    // Limpiar horas para comparar solo fecha
    const dateClean = new Date(date);
    dateClean.setHours(0, 0, 0, 0);
    const dateStr = dateClean.toDateString();
    
    console.log(`üîç Buscando retrogradaciones para: ${dateStr}`);
    
    for (const retro of retrogrades2026) {
        const startClean = new Date(retro.start);
        startClean.setHours(0, 0, 0, 0);
        const endClean = new Date(retro.end);
        endClean.setHours(0, 0, 0, 0);
        
        const startStr = startClean.toDateString();
        const endStr = endClean.toDateString();
        
        if (dateStr === startStr) {
            console.log(`‚úÖ ${retro.planet} INICIA retrogradaci√≥n en ${dateStr}`);
            retros.push({ ...retro, isStart: true });
        } else if (dateStr === endStr) {
            console.log(`‚úÖ ${retro.planet} TERMINA retrogradaci√≥n (vuelve DIRECTO) en ${dateStr}`);
            retros.push({ ...retro, isStart: false });
        }
    }
    
    if (retros.length === 0) {
        console.log(`   No hay retrogradaciones en ${dateStr}`);
    }
    
    return retros;
}

function findNearestNewMoon(date) {
    const searchDate = new Date(date);
    searchDate.setHours(0, 0, 0, 0);
    const searchTime = searchDate.getTime();
    
    // Buscar la Luna Nueva ANTERIOR o igual (que inicia el ciclo actual)
    let closestMoon = newMoonsLocal[0];
    
    for (const moonDate of newMoonsLocal) {
        const moonTime = new Date(moonDate).getTime();
        // Si esta Luna Nueva es anterior o igual a la fecha buscada
        if (moonTime <= searchTime) {
            closestMoon = moonDate;
        } else {
            // Ya pasamos la fecha, la anterior es la correcta
            break;
        }
    }
    
    return new Date(closestMoon);
}

function getNextNewMoon(currentNewMoon) {
    const currentTime = currentNewMoon.getTime();
    
    for (const moonDate of newMoonsLocal) {
        if (moonDate.getTime() > currentTime) {
            return new Date(moonDate);
        }
    }
    
    // Si no hay m√°s en la lista, estimar siguiente (29.53 d√≠as despu√©s)
    const nextMoon = new Date(currentNewMoon);
    nextMoon.setDate(nextMoon.getDate() + 30);
    return nextMoon;
}

function getPreviousNewMoon(currentNewMoon) {
    const currentTime = currentNewMoon.getTime();
    
    for (let i = newMoonsLocal.length - 1; i >= 0; i--) {
        if (newMoonsLocal[i].getTime() < currentTime) {
            return new Date(newMoonsLocal[i]);
        }
    }
    
    // Si no hay m√°s en la lista, estimar anterior (29.53 d√≠as antes)
    const prevMoon = new Date(currentNewMoon);
    prevMoon.setDate(prevMoon.getDate() - 30);
    return prevMoon;
}

function calculateLunarCycle(startDate) {
    const perfections = findLunarPerfections(startDate);
    const weeks = [];
    
    let nextNewMoonDate = new Date(perfections[3].date);
    nextNewMoonDate.setDate(nextNewMoonDate.getDate() + 1);
    const nextNewMoon = findExactPerfection(nextNewMoonDate, 0);
    
    let lunarDayCounter = 1;
    
    for (let i = 0; i < perfections.length; i++) {
        const currentPerfection = perfections[i];
        let nextPerfection;
        
        if (i < 3) {
            nextPerfection = perfections[i + 1];
        } else {
            nextPerfection = { date: nextNewMoon };
        }
        
        const startDate = new Date(currentPerfection.date);
        startDate.setHours(0, 0, 0, 0);
        
        const endDate = new Date(nextPerfection.date);
        endDate.setHours(0, 0, 0, 0);
        endDate.setDate(endDate.getDate() - 1);
        
        const days = [];
        let dayDate = new Date(startDate);
        
        while (dayDate <= endDate) {
            const isPerfectionDay = dayDate.getTime() === new Date(currentPerfection.date).setHours(0,0,0,0);
            const dayAspects = calculateAspects(dayDate);
            
            days.push({
                date: new Date(dayDate),
                dayNumber: dayDate.getDate(),
                month: dayDate.getMonth(),
                year: dayDate.getFullYear(),
                isPerfectionDay: isPerfectionDay,
                lunarDay: lunarDayCounter,
                aspects: dayAspects
            });
            
            lunarDayCounter++;
            dayDate.setDate(dayDate.getDate() + 1);
        }
        
        weeks.push({
            name: currentPerfection.name,
            emoji: currentPerfection.emoji,
            startDate: new Date(startDate),
            endDate: new Date(endDate),
            perfectionDate: currentPerfection.date,
            zodiacSign: currentPerfection.zodiacSign,
            days: days
        });
    }
    
    return weeks;
}

// ==============================================
// CALENDARIO LUNAR - L√ìGICA PRINCIPAL
// ==============================================

let currentCycleStart = findNearestNewMoon(new Date());
let selectedDate = null;
let selectedDayData = null;
let events = {};
let journals = {};
let autoSaveTimeout = null;

// Calendar mode: 'lunar' or 'solar'
let calendarMode = localStorage.getItem('calendarMode') || 'lunar';
let currentSignIndex = 0; // For solar calendar navigation

// Language system
let currentLang = localStorage.getItem('language') || 'es';

// Translation cache for auto-translated content
let translationCache = JSON.parse(localStorage.getItem('translationCache') || '{}');

const translations = {
    es: {
        // Calendar
        lunarCalendar: 'üåô Calendario Lunar Astrol√≥gico',
        solarCalendar: '‚òâ Calendario Solar Astrol√≥gico',
        subtitle: 'Ciclo natural de la Luna ‚Ä¢ Aspectos Planetarios ‚Ä¢ Diario Personal',
        subtitleSolar: 'Ciclo del Sol ‚Ä¢ Aspectos Planetarios ‚Ä¢ Diario Personal',
        
        // Navigation
        previousCycle: '‚Üê Ciclo Anterior',
        nextCycle: 'Ciclo Siguiente ‚Üí',
        previousSign: '‚Üê Signo Anterior',
        nextSign: 'Signo Siguiente ‚Üí',
        lunarCycle: 'Ciclo Lunar',
        
        // Days of week
        days: ['DOM', 'LUN', 'MAR', 'MI√â', 'JUE', 'VIE', 'S√ÅB'],
        daysLong: ['Domingo', 'Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado'],
        
        // Months
        months: ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'],
        monthsLong: ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'],
        
        // Planets
        planets: {
            'Sol': 'Sol',
            'Mercurio': 'Mercurio',
            'Venus': 'Venus',
            'Marte': 'Marte',
            'J√∫piter': 'J√∫piter',
            'Saturno': 'Saturno',
            'Urano': 'Urano',
            'Neptuno': 'Neptuno',
            'Plut√≥n': 'Plut√≥n',
            'Luna': 'Luna'
        },
        
        // Zodiac signs
        signs: {
            'Aries': 'Aries',
            'Tauro': 'Tauro',
            'G√©minis': 'G√©minis',
            'C√°ncer': 'C√°ncer',
            'Leo': 'Leo',
            'Virgo': 'Virgo',
            'Libra': 'Libra',
            'Escorpio': 'Escorpio',
            'Sagitario': 'Sagitario',
            'Capricornio': 'Capricornio',
            'Acuario': 'Acuario',
            'Piscis': 'Piscis'
        },
        
        // Aspects
        aspectTypes: {
            'Conjunci√≥n': 'Conjunci√≥n',
            'Sextil': 'Sextil',
            'Cuadratura': 'Cuadratura',
            'Tr√≠gono': 'Tr√≠gono',
            'Oposici√≥n': 'Oposici√≥n',
            'Retr√≥grado INICIA': 'Retr√≥grado INICIA',
            'Directo': 'Directo',
            'Entra en': 'Entra en',
            'conjunction': 'Conjunci√≥n',
            'sextile': 'Sextil',
            'square': 'Cuadratura',
            'trine': 'Tr√≠gono',
            'opposition': 'Oposici√≥n'
        },
        
        // Decans
        decanNames: {
            'Primer Decan': 'Primer Decan',
            'Segundo Decan': 'Segundo Decan',
            'Tercer Decan': 'Tercer Decan',
            'Iniciaci√≥n': 'Iniciaci√≥n',
            'Manifestaci√≥n': 'Manifestaci√≥n',
            'Culminaci√≥n': 'Culminaci√≥n'
        },
        
        // Menu
        dayOptions: 'Opciones del D√≠a',
        agenda: 'üìÖ Agenda / Eventos',
        aspects: '‚≠ê Aspectos Planetarios',
        diary: 'üìù Diario Personal y Reflexiones',
        cancel: 'Cancelar',
        close: 'Cerrar',
        
        // Day info
        day: 'D√≠a',
        week: 'Semana',
        noAspects: 'No hay aspectos exactos para este d√≠a',
        aspectsOfDay: 'Aspectos del D√≠a',
        
        // Events
        addEvent: 'Agregar Evento',
        eventTitle: 'T√≠tulo del evento',
        eventTime: 'Hora (opcional)',
        eventType: 'Tipo',
        eventTypes: {
            personal: 'Personal',
            work: 'Trabajo',
            health: 'Salud',
            spiritual: 'Espiritual'
        },
        save: 'Guardar',
        delete: 'Eliminar',
        myEvents: 'Mis Eventos',
        noEvents: 'No hay eventos para este d√≠a',
        
        // Diary
        diaryTitle: 'Diario Personal y Reflexiones',
        diaryPlaceholder: 'Escribe tus reflexiones del d√≠a...',
        saving: 'üíæ Guardando...',
        saved: '‚úì Guardado',
        
        // Planets section
        planetaryAspects: 'ü™ê Aspectos Planetarios 2026',
        clickPlanet: 'Haz click en un planeta para ver todos sus aspectos durante el a√±o',
        aspectsLegend: '‚òå Conjunci√≥n (0¬∞) ‚Ä¢ ‚öπ Sextil (60¬∞) ‚Ä¢ ‚ñ° Cuadratura (90¬∞) ‚Ä¢ ‚ñ≥ Tr√≠gono (120¬∞) ‚Ä¢ ‚òç Oposici√≥n (180¬∞)',
        importantEvents: 'eventos importantes durante el a√±o',
        aspectsOf: 'Aspectos de'
    },
    en: {
        // Calendar
        lunarCalendar: 'üåô Astrological Lunar Calendar',
        solarCalendar: '‚òâ Astrological Solar Calendar',
        subtitle: 'Natural Lunar Cycle ‚Ä¢ Planetary Aspects ‚Ä¢ Personal Journal',
        subtitleSolar: 'Solar Cycle ‚Ä¢ Planetary Aspects ‚Ä¢ Personal Journal',
        
        // Navigation
        previousCycle: '‚Üê Previous Cycle',
        nextCycle: 'Next Cycle ‚Üí',
        previousSign: '‚Üê Previous Sign',
        nextSign: 'Next Sign ‚Üí',
        lunarCycle: 'Lunar Cycle',
        
        // Days of week
        days: ['SUN', 'MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT'],
        daysLong: ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'],
        
        // Months
        months: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
        monthsLong: ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'],
        
        // Planets
        planets: {
            'Sol': 'Sun',
            'Mercurio': 'Mercury',
            'Venus': 'Venus',
            'Marte': 'Mars',
            'J√∫piter': 'Jupiter',
            'Saturno': 'Saturn',
            'Urano': 'Uranus',
            'Neptuno': 'Neptune',
            'Plut√≥n': 'Pluto',
            'Luna': 'Moon'
        },
        
        // Zodiac signs
        signs: {
            'Aries': 'Aries',
            'Tauro': 'Taurus',
            'G√©minis': 'Gemini',
            'C√°ncer': 'Cancer',
            'Leo': 'Leo',
            'Virgo': 'Virgo',
            'Libra': 'Libra',
            'Escorpio': 'Scorpio',
            'Sagitario': 'Sagittarius',
            'Capricornio': 'Capricorn',
            'Acuario': 'Aquarius',
            'Piscis': 'Pisces'
        },
        
        // Aspects
        aspectTypes: {
            'Conjunci√≥n': 'Conjunction',
            'Sextil': 'Sextile',
            'Cuadratura': 'Square',
            'Tr√≠gono': 'Trine',
            'Oposici√≥n': 'Opposition',
            'Retr√≥grado INICIA': 'Retrograde STARTS',
            'Directo': 'Direct',
            'Entra en': 'Enters',
            'conjunction': 'Conjunction',
            'sextile': 'Sextile',
            'square': 'Square',
            'trine': 'Trine',
            'opposition': 'Opposition'
        },
        
        // Decans
        decanNames: {
            'Primer Decan': 'First Decan',
            'Segundo Decan': 'Second Decan',
            'Tercer Decan': 'Third Decan',
            'Iniciaci√≥n': 'Initiation',
            'Manifestaci√≥n': 'Manifestation',
            'Culminaci√≥n': 'Culmination'
        },
        
        // Menu
        dayOptions: 'Day Options',
        agenda: 'üìÖ Agenda / Events',
        aspects: '‚≠ê Planetary Aspects',
        diary: 'üìù Personal Journal & Reflections',
        cancel: 'Cancel',
        close: 'Close',
        
        // Day info
        day: 'Day',
        week: 'Week',
        noAspects: 'No exact aspects for this day',
        aspectsOfDay: 'Aspects of the Day',
        
        // Events
        addEvent: 'Add Event',
        eventTitle: 'Event title',
        eventTime: 'Time (optional)',
        eventType: 'Type',
        eventTypes: {
            personal: 'Personal',
            work: 'Work',
            health: 'Health',
            spiritual: 'Spiritual'
        },
        save: 'Save',
        delete: 'Delete',
        myEvents: 'My Events',
        noEvents: 'No events for this day',
        
        // Diary
        diaryTitle: 'Personal Journal & Reflections',
        diaryPlaceholder: 'Write your reflections of the day...',
        saving: 'üíæ Saving...',
        saved: '‚úì Saved',
        
        // Planets section
        planetaryAspects: 'ü™ê Planetary Aspects 2026',
        clickPlanet: 'Click on a planet to see all its aspects during the year',
        aspectsLegend: '‚òå Conjunction (0¬∞) ‚Ä¢ ‚öπ Sextile (60¬∞) ‚Ä¢ ‚ñ° Square (90¬∞) ‚Ä¢ ‚ñ≥ Trine (120¬∞) ‚Ä¢ ‚òç Opposition (180¬∞)',
        importantEvents: 'important events during the year',
        aspectsOf: 'Aspects of'
    }
};

// Translation helper
function t(key) {
    const keys = key.split('.');
    let value = translations[currentLang];
    for (const k of keys) {
        value = value?.[k];
        if (!value) return key;
    }
    return value;
}

// Translate planet name
function tp(planetName) {
    return translations[currentLang].planets[planetName] || planetName;
}

// Translate sign name
function ts(signName) {
    return translations[currentLang].signs[signName] || signName;
}

// Translate aspect type
function ta(aspectType) {
    return translations[currentLang].aspectTypes[aspectType] || aspectType;
}

// Translate complex aspect types like "Entra en Aries" ‚Üí "Enters Aries"
function translateAspectType(type) {
    if (!type) return type;
    
    // Check if it's a simple type first
    if (translations[currentLang].aspectTypes[type]) {
        return translations[currentLang].aspectTypes[type];
    }
    
    // Handle "Entra en [Sign]" ‚Üí "Enters [Sign]"
    if (type.startsWith('Entra en ')) {
        const sign = type.replace('Entra en ', '');
        const translatedSign = ts(sign) || sign;
        return currentLang === 'es' ? `Entra en ${translatedSign}` : `Enters ${translatedSign}`;
    }
    
    // Handle "Retr√≥grado" variations
    if (type === 'Retr√≥grado INICIA') {
        return currentLang === 'es' ? 'Retr√≥grado INICIA' : 'Retrograde STARTS';
    }
    if (type === 'Retr√≥grado') {
        return currentLang === 'es' ? 'Retr√≥grado' : 'Retrograde';
    }
    if (type === 'Directo') {
        return currentLang === 'es' ? 'Directo' : 'Direct';
    }
    
    // Return original if no translation found
    return type;
}

// Auto-translate long text using browser's translation capability or fallback
async function autoTranslate(text, fromLang = 'es', toLang = 'en') {
    if (fromLang === toLang) return text;
    
    // Check cache first
    const cacheKey = `${text}_${fromLang}_${toLang}`;
    if (translationCache[cacheKey]) {
        return translationCache[cacheKey];
    }
    
    // For now, return original text
    // In production, you'd use a translation API here
    // This is a placeholder that could be connected to Google Translate API
    return text;
}

// Save translation cache
function saveTranslationCache() {
    try {
        localStorage.setItem('translationCache', JSON.stringify(translationCache));
    } catch (e) {
        // Cache too large, clear old entries
        translationCache = {};
    }
}

function changeLanguage(lang) {
    currentLang = lang;
    localStorage.setItem('language', lang);
    updateLanguageButtons();
    updateUILanguage();
}

async function toggleNotifications() {
    const btn = document.getElementById('notificationBtn');
    
    if (!('Notification' in window)) {
        alert(currentLang === 'es' ? 
            'Tu navegador no soporta notificaciones' : 
            'Your browser does not support notifications');
        return;
    }
    
    console.log('üîî Notification permission:', Notification.permission);
    console.log('üîî notificationsEnabled:', localStorage.getItem('notificationsEnabled'));
    
    // Check if user wants to disable
    const notificationsEnabled = localStorage.getItem('notificationsEnabled') !== 'false';
    
    if (Notification.permission === 'granted') {
        if (notificationsEnabled) {
            // Disable notifications
            if (confirm(currentLang === 'es' ? 
                '¬øDesactivar notificaciones?\n\nPodr√°s reactivarlas en cualquier momento.' :
                'Disable notifications?\n\nYou can re-enable them anytime.')) {
                
                localStorage.setItem('notificationsEnabled', 'false');
                btn.innerHTML = 'üîï';
                btn.style.opacity = '0.5';
                btn.style.borderColor = 'rgba(255,255,255,0.1)';
                btn.style.boxShadow = 'none';
                btn.title = currentLang === 'es' ? 'Activar notificaciones' : 'Enable notifications';
            }
            return;
        } else {
            // Re-enable notifications
            localStorage.setItem('notificationsEnabled', 'true');
            btn.innerHTML = 'üîî';
            btn.style.opacity = '1';
            btn.style.borderColor = 'rgba(78,205,196,0.6)';
            btn.style.boxShadow = '0 2px 8px rgba(78,205,196,0.3)';
            btn.title = currentLang === 'es' ? 'Desactivar notificaciones' : 'Disable notifications';
            
            alert(currentLang === 'es' ? 
                '‚úÖ Notificaciones reactivadas\n\n‚Ä¢ Eventos: 15 min antes\n‚Ä¢ Aspectos: Al inicio del d√≠a' : 
                '‚úÖ Notifications re-enabled\n\n‚Ä¢ Events: 15 min before\n‚Ä¢ Aspects: Start of day');
            return;
        }
    }
    
    if (Notification.permission === 'denied') {
        alert(currentLang === 'es' ? 
            'Notificaciones bloqueadas. Por favor act√≠valas en la configuraci√≥n del navegador.' : 
            'Notifications blocked. Please enable them in browser settings.');
        return;
    }
    
    if (Notification.permission === 'default') {
        const permission = await Notification.requestPermission();
        if (permission === 'granted') {
            localStorage.setItem('notificationsEnabled', 'true');
            btn.innerHTML = 'üîî';
            btn.style.opacity = '1';
            btn.style.borderColor = 'rgba(78,205,196,0.6)';
            btn.style.boxShadow = '0 2px 8px rgba(78,205,196,0.3)';
            btn.title = currentLang === 'es' ? 'Desactivar notificaciones' : 'Disable notifications';
            
            // Test notification
            new Notification('‚úÖ ' + (currentLang === 'es' ? 'Notificaciones activadas' : 'Notifications enabled'), {
                body: currentLang === 'es' ? 
                    'Recibir√°s alertas de eventos y aspectos astrol√≥gicos' : 
                    'You will receive alerts for events and astrological aspects',
                icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y="75" font-size="75">üîî</text></svg>'
            });
        }
    } else {
        // Re-enable notifications
        localStorage.setItem('notificationsEnabled', 'true');
        btn.innerHTML = 'üîî';
        btn.style.opacity = '1';
        btn.style.borderColor = 'rgba(78,205,196,0.6)';
        btn.style.boxShadow = '0 2px 8px rgba(78,205,196,0.3)';
        btn.title = currentLang === 'es' ? 'Desactivar notificaciones' : 'Disable notifications';
        
        alert(currentLang === 'es' ? 
            '‚úÖ Notificaciones reactivadas\n\n‚Ä¢ Eventos: 15 min antes\n‚Ä¢ Aspectos: Al inicio del d√≠a' : 
            '‚úÖ Notifications re-enabled\n\n‚Ä¢ Events: 15 min before\n‚Ä¢ Aspects: Start of day');
    }
}

// Update notification button on load
function updateNotificationButton() {
    const btn = document.getElementById('notificationBtn');
    if (!btn) return;
    
    const notificationsEnabled = localStorage.getItem('notificationsEnabled') !== 'false';
    
    if (Notification.permission === 'granted' && notificationsEnabled) {
        btn.innerHTML = 'üîî';
        btn.style.opacity = '1';
        btn.style.borderColor = 'rgba(78,205,196,0.6)';
        btn.style.boxShadow = '0 2px 8px rgba(78,205,196,0.3)';
        btn.title = currentLang === 'es' ? 'Desactivar notificaciones' : 'Disable notifications';
    } else if (Notification.permission === 'granted' && !notificationsEnabled) {
        btn.innerHTML = 'üîï';
        btn.style.opacity = '0.5';
        btn.style.borderColor = 'rgba(255,255,255,0.1)';
        btn.style.boxShadow = 'none';
        btn.title = currentLang === 'es' ? 'Activar notificaciones' : 'Enable notifications';
    }
}

function updatePlanetButtonCounters() {
    const planets = ['Sol', 'Mercurio', 'Venus', 'Marte', 'J√∫piter', 'Saturno', 'Urano', 'Neptuno', 'Plut√≥n'];
    
    planets.forEach(planet => {
        const btn = document.getElementById(`planetBtn-${planet}`);
        if (btn) {
            const aspects = getAllAspectsForPlanet(planet);
            const symbol = btn.textContent.split(' ')[0]; // Preserve symbol
            const translatedName = tp(planet);
            const count = aspects.length;
            btn.textContent = `${symbol} ${translatedName} (${count})`;
        }
    });
}

function updateLanguageButtons() {
    const esBtn = document.getElementById('langES');
    const enBtn = document.getElementById('langEN');
    
    if (currentLang === 'es') {
        esBtn.style.borderColor = 'rgba(255,255,255,0.6)';
        esBtn.style.opacity = '1';
        esBtn.style.boxShadow = '0 4px 15px rgba(255,255,255,0.3)';
        enBtn.style.borderColor = 'rgba(255,255,255,0.1)';
        enBtn.style.opacity = '0.5';
        enBtn.style.boxShadow = 'none';
    } else {
        enBtn.style.borderColor = 'rgba(255,255,255,0.6)';
        enBtn.style.opacity = '1';
        enBtn.style.boxShadow = '0 4px 15px rgba(255,255,255,0.3)';
        esBtn.style.borderColor = 'rgba(255,255,255,0.1)';
        esBtn.style.opacity = '0.5';
        esBtn.style.boxShadow = 'none';
    }
}

function updateUILanguage() {
    // Update title based on mode
    const title = calendarMode === 'lunar' ? t('lunarCalendar') : t('solarCalendar');
    document.getElementById('calendarTitle').innerHTML = title;
    
    // Update subtitle
    const subtitle = calendarMode === 'lunar' ? t('subtitle') : t('subtitleSolar');
    document.querySelector('.subtitle').textContent = subtitle;
    
    // Update planet buttons with counters
    updatePlanetButtonCounters();
    
    // Update planetary aspects section
    const planetaryTitle = document.getElementById('planetaryAspectsTitle');
    if (planetaryTitle) planetaryTitle.textContent = t('planetaryAspects');
    
    const planetarySubtitle = document.getElementById('planetaryAspectsSubtitle');
    if (planetarySubtitle) planetarySubtitle.textContent = t('clickPlanet');
    
    const aspectsLegend = document.getElementById('aspectsLegendDiv');
    if (aspectsLegend) {
        aspectsLegend.innerHTML = `
            <strong>${currentLang === 'es' ? 'Leyenda de Aspectos' : 'Aspects Legend'}:</strong><br>
            ${t('aspectsLegend')}
        `;
    }
    
    // Update static modal content
    updateModalTranslations();
    
    // Re-render calendar to update all text
    if (calendarMode === 'lunar') {
        renderCalendar();
    } else {
        renderSolarCalendar();
    }
}

function updateModalTranslations() {
    // Update Day Options Modal (static HTML)
    const dayOptionsModal = document.getElementById('dayOptionsModal');
    if (dayOptionsModal) {
        const h2 = dayOptionsModal.querySelector('h2');
        if (h2) h2.textContent = t('dayOptions');
        
        const buttons = dayOptionsModal.querySelectorAll('button');
        if (buttons[0]) buttons[0].innerHTML = t('agenda');
        if (buttons[1]) buttons[1].innerHTML = `${t('aspects')} (<span id="aspectsCount">0</span>)`;
        if (buttons[2]) buttons[2].innerHTML = t('diary');
        if (buttons[3]) buttons[3].innerHTML = `‚ùå ${t('cancel')}`;
    }
    
    // Update Aspects Modal title placeholder
    const aspectsModalTitle = document.getElementById('aspectsModalTitle');
    if (aspectsModalTitle && aspectsModalTitle.textContent.includes('D√≠a') && currentLang === 'en') {
        // Will be updated when modal opens
    }
    
    // Update Diary Modal
    const diarioModalTitle = document.getElementById('diarioModalTitle');
    if (diarioModalTitle) diarioModalTitle.textContent = t('diaryTitle');
    
    const diarioTextarea = document.getElementById('journalText');
    if (diarioTextarea) diarioTextarea.placeholder = t('diaryPlaceholder');
}

// ==============================================
// GESTI√ìN DE ALMACENAMIENTO
// ==============================================

function loadEvents() {
    // Clear all demo/test events AND old UTC-based events
    const saved = localStorage.getItem('lunarCalendarEvents');
    
    // If there are saved events, check if they need migration
    if (saved) {
        try {
            const oldEvents = JSON.parse(saved);
            // Check if any key looks like it might have timezone issues
            const hasUTCIssue = Object.keys(oldEvents).some(key => {
                // If we have events, assume they might be UTC-based from old version
                return true;
            });
            
            if (hasUTCIssue) {
                console.log('‚ö†Ô∏è Clearing old UTC-based events to prevent date mismatches');
                localStorage.removeItem('lunarCalendarEvents');
                events = {};
            } else {
                events = oldEvents;
            }
        } catch (e) {
            console.error('Error loading events:', e);
            events = {};
        }
    }
    
    /* Original code preserved for future use:
    const saved = localStorage.getItem('lunarCalendarEvents');
    if (saved) {
        events = JSON.parse(saved);
    }
    */
}

function saveEvents() {
    localStorage.setItem('lunarCalendarEvents', JSON.stringify(events));
}

function loadJournals() {
    const saved = localStorage.getItem('lunarCalendarJournals');
    if (saved) {
        journals = JSON.parse(saved);
    }
}

function saveJournals() {
    localStorage.setItem('lunarCalendarJournals', JSON.stringify(journals));
}

function getDateKey(date) {
    // Use local date components to avoid timezone issues
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
}

function getEventsForDate(date) {
    const key = getDateKey(date);
    return events[key] || [];
}

function getJournalForDate(date) {
    const key = getDateKey(date);
    return journals[key] || '';
}

function saveJournalForDate(date, text) {
    const key = getDateKey(date);
    if (text.trim()) {
        journals[key] = text;
    } else {
        delete journals[key];
    }
    saveJournals();
}

// ==============================================
// UTILIDADES DE FORMATO
// ==============================================

function isSameDay(date1, date2) {
    return date1.getFullYear() === date2.getFullYear() &&
           date1.getMonth() === date2.getMonth() &&
           date1.getDate() === date2.getDate();
}

function formatDate(date) {
    const months = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 
                  'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
    return `${date.getDate()} ${months[date.getMonth()]}`;
}

function formatShortDate(date) {
    const day = date.getDate();
    const month = t('months')[date.getMonth()];
    return `${day}/${month}`;
}

function formatLongDate(date) {
    return `${date.getDate()} ${t('months')[date.getMonth()]} ${date.getFullYear()}`;
}

function formatTime(date) {
    const hours = date.getHours();
    const minutes = date.getMinutes();
    const ampm = hours >= 12 ? 'PM' : 'AM';
    const displayHours = hours % 12 || 12;
    return `${displayHours}:${minutes.toString().padStart(2, '0')} ${ampm}`;
}

function getWeekdayName(date) {
    return t('days')[date.getDay()];
}

function isWeekend(date) {
    const day = date.getDay();
    return day === 0 || day === 6;
}

// ==============================================
// MODAL DE ASPECTOS Y DIARIO
// ==============================================

function openAspectsModal(date, lunarDay, dayData) {
    selectedDate = date;
    selectedDayData = dayData;
    const modal = document.getElementById('aspectsModal');
    
    document.getElementById('aspectsModalTitle').textContent = 
        `${t('day')} ${lunarDay} - ${formatLongDate(date)}`;
    
    // Update section title
    const sectionTitle = modal.querySelector('.aspects-section h3');
    if (sectionTitle) sectionTitle.textContent = `‚≠ê ${t('aspectsOfDay')}`;
    
    // Update close button
    const closeBtn = modal.querySelector('.btn-secondary');
    if (closeBtn) closeBtn.textContent = t('close');
    
    // Obtener TODOS los eventos planetarios del d√≠a
    const signChanges = getSignChanges(date);
    const retrogrades = getRetrogrades(date);
    const interAspects = getInterPlanetaryAspects(date);
    const eclipse = getEclipseInfo(date);
    
    // Mostrar aspectos Luna + eventos planetarios
    const aspectsDetails = document.getElementById('aspectsDetails');
    
    let htmlContent = '';
    
    // 0. Eclipse (si hay)
    if (eclipse) {
        const eclipseIcon = eclipse.type === 'solar' ? '‚òÄÔ∏è' : 'üåï';
        const timeStr = eclipse.time ? `<span style="color: #f0e68c; font-weight: bold;">${eclipse.time}</span> - ` : '';
        htmlContent += `
        <div class="aspect-detail" style="border-left-color: #FFD700; background: rgba(255,215,0,0.1);">
            <div class="aspect-planets">
                ${timeStr}${eclipseIcon} ${eclipse.name}
            </div>
            <div class="aspect-description">
                ${eclipse.degree}<br>
                <span style="font-size: 0.85em; opacity: 0.8;">${eclipse.visibility}</span>
            </div>
        </div>
        `;
    }
    
    // 1. Aspectos Luna-Planeta
    if (dayData.aspects && dayData.aspects.length > 0) {
        htmlContent += dayData.aspects.map(aspect => `
            <div class="aspect-detail ${aspect.class}">
                <div class="aspect-planets">
                    ${tp('Luna')} ${aspect.symbol} ${tp(aspect.planetName)} (${ts(aspect.planetSign.split(' ')[1])})
                </div>
                <div class="aspect-description">
                    ${aspect.description}
                </div>
            </div>
        `).join('');
    }
    
    // 2. Aspectos entre Planetas (NUEVO)
    if (interAspects.length > 0) {
        htmlContent += interAspects.map(asp => {
            const timeStr = asp.time ? `<span style="color: #f0e68c; font-weight: bold;">${asp.time}</span> - ` : '';
            const degreeStr = asp.degree ? `<span style="color: #a8b2d1; font-size: 0.85em;">(${asp.degree})</span>` : '';
            const badge = asp.isGenerational ? '<span style="background: #9b59b6; padding: 2px 6px; border-radius: 3px; font-size: 0.75em; margin-left: 5px;">GENERACIONAL</span>' : 
                         asp.isImportant ? '<span style="background: #4ecdc4; padding: 2px 6px; border-radius: 3px; font-size: 0.75em; margin-left: 5px;">IMPORTANTE</span>' : '';
            
            return `
            <div class="aspect-detail" style="border-left-color: ${asp.color}; background: rgba(0,0,0,0.2);">
                <div class="aspect-planets">
                    ${timeStr}${tp(asp.planet1)} ${asp.symbol} ${tp(asp.planet2)} ${degreeStr}${badge}
                </div>
                <div class="aspect-description">
                    ${asp.meaning}
                </div>
            </div>
        `}).join('');
    }
    
    // 3. Cambios de Signo
    if (signChanges.length > 0) {
        htmlContent += signChanges.map(change => {
            const timeStr = change.time ? `<span style="color: #f0e68c; font-weight: bold;">${change.time}</span> - ` : '';
            return `
            <div class="aspect-detail" style="border-left-color: ${change.color};">
                <div class="aspect-planets">
                    ${timeStr}${change.symbol} ${tp(change.planet)} ‚Üí ${ts(change.toSign)}
                </div>
                <div class="aspect-description">
                    ${change.meaning}
                </div>
            </div>
        `}).join('');
    }
    
    // 4. Retrogradaciones
    if (retrogrades.length > 0) {
        htmlContent += retrogrades.map(retro => `
            <div class="aspect-detail" style="border-left-color: #ff6b6b;">
                <div class="aspect-planets">
                    ${retro.planet} ${retro.isStart ? (currentLang === 'es' ? 'Retr√≥grado INICIA' : 'Retrograde STARTS') : (currentLang === 'es' ? 'Directo' : 'Direct')}
                </div>
                <div class="aspect-description">
                    ${retro.meaning}
                </div>
            </div>
        `).join('');
    }
    
    if (htmlContent) {
        aspectsDetails.innerHTML = htmlContent;
    } else {
        aspectsDetails.innerHTML = `<div class="no-aspects">${t('noAspects')}</div>`;
    }
    
    modal.classList.add('show');
}

function updateJournalWordCount() {
    const text = document.getElementById('journalText').value;
    const words = text.trim() ? text.trim().split(/\s+/).length : 0;
    const chars = text.length;
    document.getElementById('journalWordCount').textContent = 
        `${words} palabra${words !== 1 ? 's' : ''} ‚Ä¢ ${chars} caracter${chars !== 1 ? 'es' : ''}`;
}

function closeAspectsModal() {
    document.getElementById('aspectsModal').classList.remove('show');
}

// ==============================================
// MODAL DE EVENTOS/AGENDA
// ==============================================

// Manejar click en d√≠a - mostrar opciones
function handleDayClick(element) {
    const dateTime = parseInt(element.dataset.date);
    const lunarDay = parseInt(element.dataset.lunarDay);
    const hasAspects = element.dataset.hasAspects === 'true';
    const dayData = JSON.parse(element.dataset.dayData);
    
    const date = new Date(dateTime);
    const signChanges = getSignChanges(date);
    const retrogrades = getRetrogrades(date);
    const aspectsCount = dayData.aspects ? dayData.aspects.length : 0;
    const allEvents = aspectsCount + signChanges.length + retrogrades.length;
    
    // Translate and update modal
    const modal = document.getElementById('dayOptionsModal');
    const aspectsBtn = document.getElementById('aspectsOptionBtn');
    
    modal.querySelector('h2').textContent = t('dayOptions');
    modal.querySelector('button[onclick="selectDayOption(\'agenda\')"]').innerHTML = t('agenda');

function handleInterAspectClick(timestamp, lunarDay) {
    const date = new Date(timestamp);
    selectedDate = date; // CRITICAL: Set selectedDate for delete to work
    const dayData = {
        lunarDay: lunarDay,
        aspects: getAspects(date),
        date: date
    };
    openAspectsModal(date, lunarDay, dayData);
}

    aspectsBtn.innerHTML = `${t('aspects')} (<span id="aspectsCount">${allEvents}</span>)`;
    modal.querySelector('button[onclick="selectDayOption(\'diario\')"]').innerHTML = t('diary');
    modal.querySelector('button[onclick="closeDayOptionsModal()"]').innerHTML = `‚ùå ${t('cancel')}`;
    
    // IMPORTANTE: Mostrar bot√≥n de aspectos SIEMPRE (incluso si es 0)
    aspectsBtn.style.display = 'block';
    aspectsBtn.style.visibility = 'visible';
    aspectsBtn.style.opacity = '1';
    
    // Mostrar modal de opciones
    document.getElementById('dayOptionsDate').textContent = `üåô ${formatLongDate(date)} - ${t('day')} ${currentLang === 'es' ? 'Lunar' : ''} ${lunarDay}`;
    
    // Guardar datos para uso posterior
    window.selectedDayDate = date;
    window.selectedDayLunarDay = lunarDay;
    window.selectedDayData = dayData;
    
    document.getElementById('dayOptionsModal').classList.add('show');
}

function selectDayOption(option) {
    closeDayOptionsModal();
    if (option === 'agenda') {
        openEventsModal(window.selectedDayDate, window.selectedDayLunarDay);
    } else if (option === 'aspectos') {
        openAspectsModal(window.selectedDayDate, window.selectedDayLunarDay, window.selectedDayData);
    } else if (option === 'diario') {
        openDiarioModal(window.selectedDayDate, window.selectedDayLunarDay);
    }
}

function closeDayOptionsModal() {
    document.getElementById('dayOptionsModal').classList.remove('show');
}

function openDiarioModal(date, lunarDay) {
    document.getElementById('diarioDate').textContent = `üåô ${formatLongDate(date)} - ${t('day')} ${currentLang === 'es' ? 'Lunar' : ''} ${lunarDay}`;
    document.getElementById('diarioModalTitle').textContent = `üìì ${t('diaryTitle')}`;
    
    // Cargar diario guardado
    const dateKey = date.toISOString().split('T')[0];
    const savedDiary = localStorage.getItem(`diary_${dateKey}`) || '';
    const textarea = document.getElementById('diarioText');
    textarea.value = savedDiary;
    textarea.placeholder = t('diaryPlaceholder');
    
    // Auto-save on typing
    let saveTimeout;
    textarea.oninput = function() {
        clearTimeout(saveTimeout);
        saveTimeout = setTimeout(() => {
            localStorage.setItem(`diary_${dateKey}`, textarea.value);
            document.getElementById('diarioSaveStatus').textContent = t('saved');
            setTimeout(() => {
                document.getElementById('diarioSaveStatus').textContent = '';
            }, 2000);
        }, 1000);
        
        // Word count
        const words = textarea.value.trim().split(/\s+/).filter(w => w.length > 0).length;
        const wordLabel = currentLang === 'es' ? 'palabras' : 'words';
        document.getElementById('diarioWordCount').textContent = `${words} ${wordLabel}`;
    };
    
    // Initial word count
    const words = savedDiary.trim().split(/\s+/).filter(w => w.length > 0).length;
    const wordLabel = currentLang === 'es' ? 'palabras' : 'words';
    document.getElementById('diarioWordCount').textContent = savedDiary ? `${words} ${wordLabel}` : '';
    
    document.getElementById('diarioModal').classList.add('show');
}

function closeDiarioModal() {
    document.getElementById('diarioModal').classList.remove('show');
}

function openEventsModal(date, lunarDay) {
    selectedDate = date;
    const modal = document.getElementById('eventsModal');
    const dayEvents = getEventsForDate(date);
    
    document.getElementById('eventsModalTitle').textContent = 
        `${t('day')} ${lunarDay} - ${formatLongDate(date)} - ${t('agenda').replace('üìÖ ', '')}`;
    
    if (dayEvents.length > 0) {
        showEventsList(dayEvents);
    } else {
        showEventForm();
    }
    
    modal.classList.add('show');
}

function showEventForm() {
    document.getElementById('eventForm').style.display = 'block';
    document.getElementById('eventsList').style.display = 'none';
    
    // Update form labels and placeholders dynamically
    const form = document.getElementById('eventForm');
    form.querySelector('h3').textContent = t('addEvent');
    
    const labels = form.querySelectorAll('label');
    if (labels[0]) labels[0].textContent = t('eventType');
    if (labels[1]) labels[1].textContent = t('eventTitle');
    if (labels[2]) labels[2].textContent = t('eventTime');
    if (labels[3]) labels[3].textContent = currentLang === 'es' ? 'Descripci√≥n' : 'Description';
    
    // Update select options
    const select = document.getElementById('eventType');
    select.innerHTML = `
        <option value="event">${currentLang === 'es' ? 'Evento' : 'Event'}</option>
        <option value="appointment">${currentLang === 'es' ? 'Cita' : 'Appointment'}</option>
        <option value="reminder">${currentLang === 'es' ? 'Recordatorio' : 'Reminder'}</option>
    `;
    
    // Update placeholders
    document.getElementById('eventTitle').placeholder = currentLang === 'es' ? 'Nombre del evento' : 'Event name';
    document.getElementById('eventDescription').placeholder = currentLang === 'es' ? 'Detalles adicionales...' : 'Additional details...';
    
    // Update buttons
    const buttons = form.querySelectorAll('button');
    if (buttons[0]) buttons[0].textContent = t('cancel');
    if (buttons[1]) buttons[1].textContent = currentLang === 'es' ? 'Guardar Evento' : 'Save Event';
    
    // Clear form
    document.getElementById('eventTitle').value = '';
    document.getElementById('eventTime').value = '';
    document.getElementById('eventDescription').value = '';
    document.getElementById('eventType').value = 'event';
}

function showEventsList(dayEvents) {
    document.getElementById('eventForm').style.display = 'none';
    document.getElementById('eventsList').style.display = 'block';
    
    // Update title
    const eventsList = document.getElementById('eventsList');
    eventsList.querySelector('h3').textContent = currentLang === 'es' ? 'Eventos Agendados' : 'Scheduled Events';
    
    // Update buttons
    const buttons = eventsList.querySelectorAll('button');
    if (buttons[0]) buttons[0].textContent = t('close');
    if (buttons[1]) buttons[1].textContent = t('addEvent');
    
    const container = document.getElementById('eventsContainer');
    
    if (dayEvents.length === 0) {
        container.innerHTML = `<div class="no-events">${t('noEvents')}</div>`;
        return;
    }
    
    container.innerHTML = dayEvents.map((event, index) => `
        <div class="event-item type-${event.type}" style="position: relative; padding-right: 10px;">
            <div class="event-title">${event.title}</div>
            ${event.time ? `<div class="event-time">‚è∞ ${event.time}</div>` : ''}
            ${event.description ? `<div class="event-description">${event.description}</div>` : ''}
            <div class="event-actions" style="margin-top: 10px; display: flex; justify-content: flex-end;">
                <button class="btn btn-danger" onclick="window.deleteEventByIndex(${index})" style="font-size: 0.9em; padding: 8px 15px;">üóëÔ∏è ${t('delete')}</button>
            </div>
        </div>
    `).join('');
}

function saveEvent() {
    const title = document.getElementById('eventTitle').value.trim();
    if (!title) {
        alert('Por favor ingresa un t√≠tulo para el evento');
        return;
    }
    
    const event = {
        title: title,
        type: document.getElementById('eventType').value,
        time: document.getElementById('eventTime').value,
        description: document.getElementById('eventDescription').value.trim(),
        created: new Date().toISOString()
    };
    
    const key = getDateKey(selectedDate);
    if (!events[key]) {
        events[key] = [];
    }
    events[key].push(event);
    
    saveEvents();
    showEventsList(events[key]);
    renderCalendar();
}

function deleteEvent(index) {
    console.log('üóëÔ∏è deleteEvent called with index:', index);
    console.log('üìÖ selectedDate:', selectedDate);
    
    if (!selectedDate) {
        alert('Error: No date selected');
        console.error('selectedDate is null');
        return;
    }
    
    const confirmMsg = currentLang === 'es' ? '¬øEst√°s seguro de eliminar este evento?' : 'Are you sure you want to delete this event?';
    
    if (confirm(confirmMsg)) {
        const key = getDateKey(selectedDate);
        console.log('üîë Date key:', key);
        console.log('üì¶ Events for this key:', events[key]);
        
        if (!events[key]) {
            alert('Error: No events found for this date');
            console.error('No events found for key:', key);
            return;
        }
        
        console.log('‚úÇÔ∏è Removing event at index:', index);
        events[key].splice(index, 1);
        
        if (events[key].length === 0) {
            delete events[key];
        }
        
        saveEvents();
        console.log('üíæ Events saved');
        
        // Refresh the calendar
        if (calendarMode === 'lunar') {
            renderCalendar();
        } else {
            renderSolarCalendar();
        }
        
        // Update the modal
        const dayEvents = events[key] || [];
        if (dayEvents.length > 0) {
            showEventsList(dayEvents);
        } else {
            showEventForm();
        }
        
        console.log('‚úÖ Event deleted successfully');
    }
}

function toggleEventComplete(dateKey, eventIndex) {
    if (!events[dateKey] || !events[dateKey][eventIndex]) {
        console.error('Event not found');
        return;
    }
    
    events[dateKey][eventIndex].completed = !events[dateKey][eventIndex].completed;
    saveEvents();
    
    // Refresh calendar
    if (calendarMode === 'lunar') {
        renderCalendar();
    } else {
        renderSolarCalendar();
    }
}

function closeEventsModal() {
    document.getElementById('eventsModal').classList.remove('show');
}

// Modal de Eclipse
function showEclipseModal(type, name, dateTime) {
    const date = new Date(parseInt(dateTime));
    const eclipseData = eclipses2026.find(e => e.date.toDateString() === date.toDateString());
    
    if (!eclipseData) return;
    
    document.getElementById('eclipseModalTitle').textContent = name;
    document.getElementById('eclipseModalBody').innerHTML = `
        <div style="text-align: center; margin-bottom: 20px;">
            <div style="font-size: 3em; margin-bottom: 10px;">${type === 'solar' ? '‚òÄÔ∏è' : 'üåï'}</div>
            <h3>${name}</h3>
            <p style="color: rgba(255,255,255,0.7);">${formatLongDate(date)}</p>
        </div>
        
        <!-- Grado y signo -->
        <div style="background: linear-gradient(135deg, rgba(240,230,140,0.2), rgba(240,230,140,0.1)); padding: 12px; border-radius: 8px; margin-bottom: 15px; border-left: 3px solid #f0e68c;">
            <div style="font-size: 1.2em; font-weight: bold; color: #f0e68c; text-align: center;">
                ${eclipseData.degree}
            </div>
        </div>
        
        <!-- Significado -->
        <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
            <p style="color: rgba(255,255,255,0.9); line-height: 1.6;">
                ${type === 'solar' ? 
                    '‚òÄÔ∏è Los eclipses solares marcan <strong>nuevos comienzos</strong>, cierres de ciclos y oportunidades para resetear intenciones. Momento de plantar semillas.' : 
                    'üåï Los eclipses lunares revelan <strong>verdades ocultas</strong>, traen culminaciones y liberaci√≥n emocional. Momento de soltar y cerrar ciclos.'}
            </p>
        </div>
        
        <!-- Visibilidad -->
        <div style="background: rgba(0,0,0,0.2); padding: 12px; border-radius: 8px; margin-bottom: 15px;">
            <p style="font-size: 0.9em; color: rgba(255,255,255,0.7);">
                <strong>üìç Visibilidad:</strong> ${eclipseData.visibility}
            </p>
        </div>
        
        <!-- Aspectos planetarios -->
        ${eclipseData.aspects && eclipseData.aspects.length > 0 ? `
        <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px;">
            <h4 style="margin-top: 0; color: #f0e68c; font-size: 1em;">‚≠ê Aspectos Planetarios</h4>
            ${eclipseData.aspects.map(asp => `
                <div style="padding: 8px; background: rgba(0,0,0,0.2); border-radius: 6px; margin-bottom: 8px; border-left: 2px solid rgba(240,230,140,0.5);">
                    <div style="font-weight: bold; margin-bottom: 4px;">${asp.planet} - ${asp.aspect}</div>
                    <div style="font-size: 0.9em; color: rgba(255,255,255,0.7);">${asp.description}</div>
                </div>
            `).join('')}
        </div>
        ` : ''}
    `;
    
    document.getElementById('eclipseModal').classList.add('show');
}

function closeEclipseModal() {
    document.getElementById('eclipseModal').classList.remove('show');
}

// Modal de Retrogradaci√≥n
function showRetrogradeModal(planet, symbol, isStart, dateStr) {
    // Buscar tanto por fecha de inicio como de fin
    let retroData = retrogrades2026.find(r => {
        const startMatch = r.start.toDateString() === dateStr;
        const endMatch = r.end.toDateString() === dateStr;
        return r.planet === planet && (startMatch || endMatch);
    });
    
    if (!retroData) {
        console.error('No se encontr√≥ data de retrogradaci√≥n para', planet, dateStr);
        return;
    }
    
    const isStarting = isStart;
    
    document.getElementById('retrogradeModalTitle').textContent = `${planet} ${isStarting ? 'Retr√≥grado' : 'Directo'}`;
    document.getElementById('retrogradeModalBody').innerHTML = `
        <div style="text-align: center; margin-bottom: 20px;">
            <div style="font-size: 3em; margin-bottom: 10px; color: #f0e68c;">${symbol}‚Ñû</div>
            <h3>${planet} ${isStarting ? 'Inicia Retrogradaci√≥n' : 'Vuelve Directo'}</h3>
            <p style="color: rgba(255,255,255,0.7);">${dateStr}</p>
        </div>
        
        <!-- Per√≠odo y signo -->
        <div style="background: linear-gradient(135deg, rgba(240,230,140,0.2), rgba(240,230,140,0.1)); padding: 12px; border-radius: 8px; margin-bottom: 15px; border-left: 3px solid #f0e68c;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                <span style="font-size: 0.9em; color: rgba(255,255,255,0.7);">Per√≠odo:</span>
                <span style="font-weight: bold;">${formatDate(retroData.start)} - ${formatDate(retroData.end)}</span>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <span style="font-size: 0.9em; color: rgba(255,255,255,0.7);">En:</span>
                <span style="font-weight: bold; color: #f0e68c;">${retroData.sign}</span>
            </div>
        </div>
        
        <!-- Estado -->
        <div style="background: ${isStarting ? 'rgba(255,107,107,0.2)' : 'rgba(78,205,196,0.2)'}; padding: 12px; border-radius: 8px; margin-bottom: 15px; border-left: 3px solid ${isStarting ? '#ff6b6b' : '#4ecdc4'};">
            <p style="margin: 0; font-weight: bold;">${isStarting ? 'üîÑ INICIA Retrogradaci√≥n' : '‚úÖ TERMINA Retrogradaci√≥n'}</p>
        </div>
        
        <!-- Significado -->
        <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
            <h4 style="margin-top: 0; color: #f0e68c; font-size: 1em;">üí´ Significado</h4>
            <p style="color: rgba(255,255,255,0.9); line-height: 1.6; margin: 0;">
                ${retroData.meaning}
            </p>
        </div>
        
        <!-- √Åreas afectadas -->
        <div style="background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px;">
            <h4 style="margin-top: 0; color: #f0e68c; font-size: 1em;">üéØ √Åreas Afectadas</h4>
            <p style="color: rgba(255,255,255,0.8); margin: 0;">
                ${retroData.areas}
            </p>
        </div>
    `;
    
    document.getElementById('retrogradeModal').classList.add('show');
}

function closeRetrogradeModal() {
    document.getElementById('retrogradeModal').classList.remove('show');
}

// Modal de Cambio de Signo
function showSignChangeModal(planet, symbol, toSign, meaning, dateTime) {
    const date = new Date(parseInt(dateTime));
    
    document.getElementById('signChangeModalTitle').textContent = `${planet} Cambia de Signo`;
    document.getElementById('signChangeModalBody').innerHTML = `
        <div style="text-align: center; margin-bottom: 20px;">
            <div style="font-size: 3em; margin-bottom: 10px;">${symbol} ‚Üí ${toSign}</div>
            <h3>${planet} entra en ${toSign}</h3>
            <p style="color: rgba(255,255,255,0.7);">${formatLongDate(date)}</p>
        </div>
        
        <!-- Significado -->
        <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
            <h4 style="margin-top: 0; color: #f0e68c; font-size: 1em;">üí´ Significado</h4>
            <p style="color: rgba(255,255,255,0.9); line-height: 1.6; margin: 0;">
                ${meaning}
            </p>
        </div>
    `;
    
    document.getElementById('signChangeModal').classList.add('show');
}

function closeSignChangeModal() {
    document.getElementById('signChangeModal').classList.remove('show');
}

// Modal de Stellium
function showStelliumModal(sign, planetsStr, count, dateTime) {
    const date = new Date(parseInt(dateTime));
    const planets = planetsStr.split('|');
    
    const colorMap = {
        3: { color: '#FFD700', name: 'Dorado' },
        4: { color: '#f39c12', name: 'Naranja' },
        5: { color: '#e74c3c', name: 'Rojo' }
    };
    
    const colorInfo = colorMap[count] || colorMap[5];
    
    document.getElementById('stelliumModalTitle').textContent = `Stellium en ${sign}`;
    document.getElementById('stelliumModalBody').innerHTML = `
        <div style="text-align: center; margin-bottom: 20px;">
            <div style="font-size: 3em; margin-bottom: 10px; color: ${colorInfo.color};">‚òÖ</div>
            <h3>Stellium en ${sign}</h3>
            <p style="color: rgba(255,255,255,0.7);">${formatLongDate(date)}</p>
        </div>
        
        <!-- Planetas -->
        <div style="background: linear-gradient(135deg, rgba(240,230,140,0.2), rgba(240,230,140,0.1)); padding: 12px; border-radius: 8px; margin-bottom: 15px; border-left: 3px solid ${colorInfo.color};">
            <h4 style="margin-top: 0; color: ${colorInfo.color}; font-size: 1em;">${count} Planetas en ${sign}:</h4>
            <div style="display: flex; flex-direction: column; gap: 5px;">
                ${planets.map(p => `<div style="color: rgba(255,255,255,0.9);">‚Ä¢ ${p}</div>`).join('')}
            </div>
        </div>
        
        <!-- Significado -->
        <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
            <h4 style="margin-top: 0; color: #f0e68c; font-size: 1em;">üí´ Significado</h4>
            <p style="color: rgba(255,255,255,0.9); line-height: 1.6; margin: 0;">
                Concentraci√≥n intensa de energ√≠a planetaria en ${sign}. Los stelliums amplifican las cualidades del signo, creando un foco poderoso de manifestaci√≥n.
            </p>
        </div>
        
        <!-- Impacto -->
        <div style="background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px;">
            <h4 style="margin-top: 0; color: #f0e68c; font-size: 1em;">‚ö° Impacto</h4>
            <p style="color: rgba(255,255,255,0.8); margin: 0;">
                Momento de gran potencial para trabajar con las energ√≠as de ${sign}. Los temas de este signo estar√°n muy activos y presentes.
            </p>
        </div>
    `;
    
    document.getElementById('stelliumModal').classList.add('show');
}

function closeStelliumModal() {
    document.getElementById('stelliumModal').classList.remove('show');
}

// Modal de Aspecto Mayor
function showMajorAspectModal(type, planetsStr, meaning, impact, dateTime) {
    const date = new Date(parseInt(dateTime));
    const planets = planetsStr.split('|');
    
    const symbols = {
        'T-Square': { symbol: '‚ä§', color: '#ff6b6b', name: 'T-Cuadrada' },
        'Kite': { symbol: 'ü™Å', color: '#9b59b6', name: 'Cometa' },
        'Mystic Rectangle': { symbol: '‚ñ≠', color: '#4ecdc4', name: 'Rect√°ngulo M√≠stico' },
        'Grand Cross': { symbol: '‚úö', color: '#e74c3c', name: 'Gran Cruz' }
    };
    
    const info = symbols[type] || { symbol: '‚óÜ', color: '#f39c12', name: type };
    
    document.getElementById('majorAspectModalTitle').textContent = info.name;
    document.getElementById('majorAspectModalBody').innerHTML = `
        <div style="text-align: center; margin-bottom: 20px;">
            <div style="font-size: 3em; margin-bottom: 10px;">${info.symbol}</div>
            <h3>${info.name}</h3>
            <p style="color: rgba(255,255,255,0.7);">${formatLongDate(date)}</p>
        </div>
        
        <!-- Planetas Involucrados -->
        <div style="background: linear-gradient(135deg, rgba(${info.color === '#ff6b6b' ? '255,107,107' : info.color === '#9b59b6' ? '155,89,182' : '78,205,196'},0.2), rgba(${info.color === '#ff6b6b' ? '255,107,107' : info.color === '#9b59b6' ? '155,89,182' : '78,205,196'},0.1)); padding: 12px; border-radius: 8px; margin-bottom: 15px; border-left: 3px solid ${info.color};">
            <h4 style="margin-top: 0; color: ${info.color}; font-size: 1em;">üåü Planetas Involucrados:</h4>
            <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                ${planets.map(p => `<span style="background: rgba(0,0,0,0.3); padding: 5px 10px; border-radius: 15px; color: rgba(255,255,255,0.9);">${p}</span>`).join('')}
            </div>
        </div>
        
        <!-- Significado -->
        <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
            <h4 style="margin-top: 0; color: #f0e68c; font-size: 1em;">üí´ Significado</h4>
            <p style="color: rgba(255,255,255,0.9); line-height: 1.6; margin: 0;">
                ${meaning}
            </p>
        </div>
        
        <!-- Impacto -->
        <div style="background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px;">
            <h4 style="margin-top: 0; color: #f0e68c; font-size: 1em;">‚ö° Impacto</h4>
            <p style="color: rgba(255,255,255,0.8); margin: 0;">
                ${impact}
            </p>
        </div>
    `;
    
    document.getElementById('majorAspectModal').classList.add('show');
}

function closeMajorAspectModal() {
    document.getElementById('majorAspectModal').classList.remove('show');
}

// ==============================================
// ASPECTOS POR PLANETA 2026
// ==============================================

function showPlanetAspects(planetName, planetSymbol, planetColor) {
    const modal = document.getElementById('planetAspectsModal');
    const title = document.getElementById('planetAspectsTitle');
    const body = document.getElementById('planetAspectsBody');
    
    const translatedPlanet = tp(planetName);
    title.innerHTML = `${planetSymbol} ${translatedPlanet} ‚Ä¢ ${currentLang === 'es' ? 'Aspectos' : 'Aspects'} 2026`;
    title.style.color = planetColor;
    
    const planetAspects = getAllAspectsForPlanet(planetName);
    
    if (planetAspects.length === 0) {
        body.innerHTML = `
            <div style="text-align: center; padding: 40px; color: #a8b2d1;">
                <p style="font-size: 1.2em;">${currentLang === 'es' ? 'Pr√≥ximamente aspectos de' : 'Coming soon aspects of'} ${translatedPlanet}</p>
            </div>
        `;
    } else {
        body.innerHTML = `
            <div style="margin-bottom: 15px; padding: 15px; background: rgba(0,0,0,0.2); border-left: 4px solid ${planetColor}; border-radius: 8px;">
                <strong style="color: ${planetColor}; font-size: 1.1em;">${planetSymbol} ${translatedPlanet}</strong>
                <p style="margin-top: 5px; color: #a8b2d1; font-size: 0.9em;">
                    ${planetAspects.length} ${t('importantEvents')}
                </p>
            </div>
            
            <div style="display: flex; flex-direction: column; gap: 12px;">
                ${planetAspects.map(aspect => {
                    const aspectColor = getAspectColor(aspect.type);
                    const translatedType = translateAspectType(aspect.type);
                    const translatedWith = ts(aspect.with) || tp(aspect.with) || aspect.with;
                    const timeStr = aspect.time ? `<span style="font-weight: bold; color: #f0e68c;">${aspect.time}</span> - ` : '';
                    const degreeStr = aspect.degree ? `<div style="font-size: 0.8em; color: #a8b2d1; margin-top: 2px;">(${aspect.degree})</div>` : '';
                    const symbolStr = aspect.symbol ? `${aspect.symbol} ` : '';
                    
                    return `
                    <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 10px; border-left: 3px solid ${aspectColor};">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; flex-wrap: wrap; gap: 8px;">
                            <div style="font-size: 1.05em; flex: 1;">
                                <div>${timeStr}<strong style="color: ${planetColor};">${translatedPlanet}</strong>
                                <strong style="color: ${aspectColor}; margin: 0 8px;">${symbolStr}${translatedType}</strong>
                                <strong style="color: #a8b2d1;">${translatedWith}</strong></div>
                                ${degreeStr}
                            </div>
                            <div style="text-align: right; font-size: 0.85em; color: #f0e68c;">
                                ${formatShortDate(aspect.date)}
                            </div>
                        </div>
                        <p style="color: rgba(255,255,255,0.8); font-size: 0.9em; margin: 0;">
                            ${aspect.meaning}
                        </p>
                    </div>
                `;
                }).join('')}
            </div>
        `;
    }
    
    modal.classList.add('show');
}

function closePlanetAspectsModal() {
    document.getElementById('planetAspectsModal').classList.remove('show');
}

function getPlanetSymbol(planetOrSign) {
    const symbols = {
        // Planetas
        'Sol': '‚òâ',
        'Mercurio': '‚òø',
        'Venus': '‚ôÄ',
        'Marte': '‚ôÇ',
        'J√∫piter': '‚ôÉ',
        'Saturno': '‚ôÑ',
        'Urano': '‚ôÖ',
        'Neptuno': '‚ôÜ',
        'Plut√≥n': '‚ôá',
        // Signos
        'Aries': '‚ôà',
        'Tauro': '‚ôâ',
        'G√©minis': '‚ôä',
        'C√°ncer': '‚ôã',
        'Leo': '‚ôå',
        'Virgo': '‚ôç',
        'Libra': '‚ôé',
        'Escorpio': '‚ôè',
        'Sagitario': '‚ôê',
        'Capricornio': '‚ôë',
        'Acuario': '‚ôí',
        'Piscis': '‚ôì'
    };
    return symbols[planetOrSign] || planetOrSign;
}

function closePlanetAspectsModal() {
    document.getElementById('planetAspectsModal').classList.remove('show');
}

function getPlanetSymbol(planetOrSign) {
    const symbols = {
        // Planetas
        'Sol': '‚òâ',
        'Mercurio': '‚òø',
        'Venus': '‚ôÄ',
        'Marte': '‚ôÇ',
        'J√∫piter': '‚ôÉ',
        'Saturno': '‚ôÑ',
        'Urano': '‚ôÖ',
        'Neptuno': '‚ôÜ',
        'Plut√≥n': '‚ôá',
        // Signos
        'Aries': '‚ôà',
        'Tauro': '‚ôâ',
        'G√©minis': '‚ôä',
        'C√°ncer': '‚ôã',
        'Leo': '‚ôå',
        'Virgo': '‚ôç',
        'Libra': '‚ôé',
        'Escorpio': '‚ôè',
        'Sagitario': '‚ôê',
        'Capricornio': '‚ôë',
        'Acuario': '‚ôí',
        'Piscis': '‚ôì'
    };
    return symbols[planetOrSign] || planetOrSign;
}

function getAspectSymbol(type) {
    const symbols = {
        'Conjunci√≥n': '‚òå',
        'Sextil': '‚öπ',
        'Cuadratura': '‚ñ°',
        'Tr√≠gono': '‚ñ≥',
        'Oposici√≥n': '‚òç',
        'Retr√≥grado INICIA': 'R',
        'Directo': 'D',
        'Entra en Leo': '‚Üí',
        'Entra en Aries': '‚Üí',
        'Entra en G√©minis': '‚Üí',
        'Equinoccio Primavera': '‚öñ',
        'Solsticio Verano': '‚òÄ',
        'Equinoccio Oto√±o': '‚öñ',
        'Solsticio Invierno': '‚ùÑ'
    };
    return symbols[type] || type;
}

function getAspectColor(type) {
    const colors = {
        'Conjunci√≥n': '#ff6b6b',
        'Sextil': '#4ecdc4',
        'Cuadratura': '#ff9f43',
        'Tr√≠gono': '#5f27cd',
        'Oposici√≥n': '#ee5a6f',
        'Retr√≥grado INICIA': '#ff6b6b',
        'Directo': '#4ecdc4',
        'Entra en Leo': '#9b59b6',
        'Entra en Aries': '#ff6b6b',
        'Entra en G√©minis': '#1abc9c',
        'Equinoccio Primavera': '#FFD700',
        'Solsticio Verano': '#FFD700',
        'Equinoccio Oto√±o': '#FFD700',
        'Solsticio Invierno': '#FFD700'
    };
    return colors[type] || '#a8b2d1';
}

function getAllAspectsForPlanet(planetName) {
    const allEvents = [];
    
    // 1. Agregar cambios de signo del planeta
    signChanges2026.forEach(change => {
        if (change.planet === planetName) {
            allEvents.push({
                date: change.date,
                time: change.time,
                type: 'Entra en ' + change.toSign,
                with: change.toSign,
                meaning: change.meaning
            });
        }
    });
    
    // 2. Agregar retrogradaciones del planeta
    retrogrades2026.forEach(retro => {
        if (retro.planet === planetName) {
            allEvents.push({
                date: retro.start,
                type: retro.isStart !== false ? 'Retr√≥grado INICIA' : 'Retr√≥grado',
                with: retro.sign,
                meaning: retro.meaning
            });
            if (retro.end) {
                allEvents.push({
                    date: retro.end,
                    type: 'Directo',
                    with: retro.sign,
                    meaning: retro.meaning
                });
            }
        }
    });
    
    // 3. Agregar aspectos entre planetas (de interPlanetaryAspects2026)
    interPlanetaryAspects2026.forEach(asp => {
        if (asp.planet1 === planetName || asp.planet2 === planetName) {
            const otherPlanet = asp.planet1 === planetName ? asp.planet2 : asp.planet1;
            allEvents.push({
                date: asp.date,
                time: asp.time,
                type: asp.aspect,
                with: otherPlanet,
                meaning: asp.meaning,
                degree: asp.degree,
                symbol: asp.symbol
            });
        }
    });
    
    // Ordenar por fecha
    allEvents.sort((a, b) => new Date(a.date) - new Date(b.date));
    
    return allEvents;
}

// ==============================================
// CALENDARIO SOLAR
// ==============================================

// Definici√≥n de signos solares 2026
const solarSigns2026 = [
    { name: 'Aries', symbol: '‚ôà', start: new Date('2026-03-20'), end: new Date('2026-04-19'), color: '#ff6b6b' },
    { name: 'Tauro', symbol: '‚ôâ', start: new Date('2026-04-20'), end: new Date('2026-05-20'), color: '#51cf66' },
    { name: 'G√©minis', symbol: '‚ôä', start: new Date('2026-05-21'), end: new Date('2026-06-20'), color: '#ffd43b' },
    { name: 'C√°ncer', symbol: '‚ôã', start: new Date('2026-06-21'), end: new Date('2026-07-22'), color: '#74c0fc' },
    { name: 'Leo', symbol: '‚ôå', start: new Date('2026-07-23'), end: new Date('2026-08-22'), color: '#ff922b' },
    { name: 'Virgo', symbol: '‚ôç', start: new Date('2026-08-23'), end: new Date('2026-09-22'), color: '#94d82d' },
    { name: 'Libra', symbol: '‚ôé', start: new Date('2026-09-23'), end: new Date('2026-10-22'), color: '#da77f2' },
    { name: 'Escorpio', symbol: '‚ôè', start: new Date('2026-10-23'), end: new Date('2026-11-21'), color: '#e64980' },
    { name: 'Sagitario', symbol: '‚ôê', start: new Date('2026-11-22'), end: new Date('2026-12-21'), color: '#7950f2' },
    { name: 'Capricornio', symbol: '‚ôë', start: new Date('2026-12-22'), end: new Date('2027-01-19'), color: '#4c6ef5' },
    { name: 'Acuario', symbol: '‚ôí', start: new Date('2026-01-20'), end: new Date('2026-02-18'), color: '#15aabf' },
    { name: 'Piscis', symbol: '‚ôì', start: new Date('2026-02-19'), end: new Date('2026-03-19'), color: '#339af0' }
];

function getCurrentSign() {
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    for (let i = 0; i < solarSigns2026.length; i++) {
        const sign = solarSigns2026[i];
        const start = new Date(sign.start);
        const end = new Date(sign.end);
        start.setHours(0, 0, 0, 0);
        end.setHours(23, 59, 59, 999);
        
        if (today >= start && today <= end) {
            return i;
        }
    }
    return 0; // Default to first sign
}

function switchToSolarMode() {
    calendarMode = 'solar';
    localStorage.setItem('calendarMode', 'solar');
    currentSignIndex = getCurrentSign();
    
    // Apply solar theme
    document.body.classList.add('solar-mode');
    
    updateModeButtons();
    renderSolarCalendar();
}

function switchToLunarMode() {
    calendarMode = 'lunar';
    localStorage.setItem('calendarMode', 'lunar');
    
    // Remove solar theme
    document.body.classList.remove('solar-mode');
    
    // Show lunar calendar
    const lunarWeeks = document.getElementById('lunarWeeks');
    if (lunarWeeks) lunarWeeks.style.display = 'block';
    
    // Hide solar calendar
    const solarWeeks = document.getElementById('solarWeeks');
    if (solarWeeks) solarWeeks.style.display = 'none';
    
    // Update title
    document.getElementById('calendarTitle').innerHTML = t('lunarCalendar');
    
    // RESTORE LUNAR NAVIGATION
    const nav = document.querySelector('.navigation');
    nav.innerHTML = `
        <button class="nav-btn" onclick="previousCycle()">‚Üê Ciclo Anterior</button>
        <div class="cycle-info">
            <div class="cycle-number" id="cycleNumber">Ciclo Lunar</div>
            <div class="cycle-dates" id="cycleDates"></div>
        </div>
        <button class="nav-btn" onclick="nextCycle()">Ciclo Siguiente ‚Üí</button>
    `;
    
    updateModeButtons();
    renderCalendar();
}

function updateModeButtons() {
    const lunarBtn = document.getElementById('lunarModeBtn');
    const solarBtn = document.getElementById('solarModeBtn');
    
    if (calendarMode === 'lunar') {
        lunarBtn.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
        lunarBtn.style.color = 'white';
        lunarBtn.style.boxShadow = '0 4px 15px rgba(102,126,234,0.4)';
        
        solarBtn.style.background = 'rgba(255,255,255,0.1)';
        solarBtn.style.color = 'rgba(255,255,255,0.6)';
        solarBtn.style.boxShadow = 'none';
    } else {
        solarBtn.style.background = 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)';
        solarBtn.style.color = 'white';
        solarBtn.style.boxShadow = '0 4px 15px rgba(245,87,108,0.4)';
        
        lunarBtn.style.background = 'rgba(255,255,255,0.1)';
        lunarBtn.style.color = 'rgba(255,255,255,0.6)';
        lunarBtn.style.boxShadow = 'none';
    }
}

function renderSolarCalendar() {
    const sign = solarSigns2026[currentSignIndex];
    
    // Hide lunar calendar
    const lunarWeeks = document.getElementById('lunarWeeks');
    if (lunarWeeks) lunarWeeks.style.display = 'none';
    
    // Show solar calendar container
    let solarWeeks = document.getElementById('solarWeeks');
    if (!solarWeeks) {
        solarWeeks = document.createElement('div');
        solarWeeks.id = 'solarWeeks';
        lunarWeeks.parentNode.insertBefore(solarWeeks, lunarWeeks.nextSibling);
    }
    solarWeeks.style.display = 'block';
    
    // Update title
    document.getElementById('calendarTitle').innerHTML = currentLang === 'es' ? `‚òâ Calendario Solar Astrol√≥gico` : `‚òâ Astrological Solar Calendar`;
    
    // Update navigation
    const nav = document.querySelector('.navigation');
    nav.innerHTML = `
        <button class="nav-btn" onclick="previousSign()">${t('previousSign')}</button>
        <div class="cycle-info">
            <div class="cycle-number" style="color: ${sign.color}; font-size: 1.5em;">${sign.symbol} ${ts(sign.name)}</div>
            <div class="cycle-dates">${formatDate(sign.start)} - ${formatDate(sign.end)}</div>
        </div>
        <button class="nav-btn" onclick="nextSign()">${t('nextSign')}</button>
    `;
    
    // Generate solar calendar
    solarWeeks.innerHTML = generateSolarWeeks(sign);
}

function previousSign() {
    currentSignIndex = (currentSignIndex - 1 + solarSigns2026.length) % solarSigns2026.length;
    renderSolarCalendar();
}

function nextSign() {
    currentSignIndex = (currentSignIndex + 1) % solarSigns2026.length;
    renderSolarCalendar();
}

function generateSolarWeeks(sign) {
    const startDate = new Date(sign.start);
    const endDate = new Date(sign.end);
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    const totalDays = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;
    
    // DECANOS: 3 divisiones de ~10 d√≠as cada una
    const decanNames = currentLang === 'es' ? 
        ['Primer Decan', 'Segundo Decan', 'Tercer Decan'] :
        ['First Decan', 'Second Decan', 'Third Decan'];
    const decanSubtitles = currentLang === 'es' ?
        ['Iniciaci√≥n', 'Manifestaci√≥n', 'Culminaci√≥n'] :
        ['Initiation', 'Manifestation', 'Culmination'];
    
    const decans = [
        { name: decanNames[0], subtitle: decanSubtitles[0], days: 10 },
        { name: decanNames[1], subtitle: decanSubtitles[1], days: 10 },
        { name: decanNames[2], subtitle: decanSubtitles[2], days: totalDays - 20 } // Los d√≠as restantes
    ];
    
    let html = '';
    let currentDate = new Date(startDate);
    let dayCounter = 1;
    
    decans.forEach((decan, decanIndex) => {
        // Start decan div
        html += `<div class="lunar-week">`;
        
        // Decan header
        html += `
            <div class="week-header">
                <div class="moon-icon">${sign.symbol}</div>
                <div class="week-info">
                    <div style="display: flex; align-items: center; gap: 3px; flex-wrap: nowrap; font-size: 0.65em; width: 100%; overflow: hidden;">
                        <span style="font-weight: bold; white-space: nowrap; color: ${sign.color};">${sign.name}</span>
                        <span style="opacity: 0.6;">‚Ä¢</span>
                        <span style="white-space: nowrap;">${decan.name}</span>
                        <span style="opacity: 0.6;">‚Ä¢</span>
                        <span style="white-space: nowrap; font-style: italic;">${decan.subtitle}</span>
                    </div>
                </div>
            </div>
        `;
        
        // Days container
        html += `<div class="days-container">`;
        
        // Generate days for this decan
        let renderedDays = 0;
        for (let i = 0; i < decan.days && currentDate <= endDate; i++) {
            const dayDate = new Date(currentDate);
            const isToday = isSameDay(dayDate, today);
            const dayEvents = getEventsForDate(dayDate);
            const weekday = ['DOM', 'LUN', 'MAR', 'MI√â', 'JUE', 'VIE', 'S√ÅB'][dayDate.getDay()];
            const eclipse = getEclipseInfo(dayDate);
            const retrogrades = getRetrogrades(dayDate);
            const signChanges = getSignChanges(dayDate);
            const interAspects = getInterPlanetaryAspects(dayDate);
            const stellium = getStellium(dayDate);
            const majorAspect = getMajorAspect(dayDate);
            
            // Events HTML
            const eventsHTML = dayEvents.slice(0, 3).map(event => `
                <div class="day-event-item type-${event.type}">
                    ${event.time ? `<span class="event-time-badge">${event.time}</span> ` : ''}${event.title}
                </div>
            `).join('');
            
            const moreEvents = dayEvents.length > 3 ? `
                <div style="text-align: center; font-style: italic; font-size: 0.85em; margin-top: 2px; color: #a8b2d1;">
                    +${dayEvents.length - 3} m√°s
                </div>
            ` : '';
            
            const dayDataStr = JSON.stringify({date: dayDate, lunarDay: dayCounter, aspects: []}).replace(/'/g, "\\'").replace(/"/g, '&quot;');
            
            html += `
                <div class="day-cell ${isToday ? 'today' : ''}" 
                     data-date="${dayDate.getTime()}"
                     data-lunar-day="${dayCounter}"
                     data-has-aspects="false"
                     data-day-data='${dayDataStr}'
                     onclick="handleDayClick(this)">
                    
                    <div class="day-header">
                        <div style="display: flex; align-items: center; justify-content: space-between; width: 100%; gap: 4px;">
                            <div style="display: flex; align-items: baseline; gap: 4px;">
                                <div class="day-number">${dayCounter}</div>
                                <div class="day-date" style="font-size: 0.65em; color: rgba(255, 255, 255, 0.6);">${formatShortDate(dayDate)}</div>
                                <div class="day-weekday" style="font-size: 0.55em; color: rgba(255, 255, 255, 0.5); text-transform: uppercase; font-weight: 600;">${weekday}</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="day-content">
                        <!-- Izquierda: Eventos -->
                        <div style="flex: 1; min-width: 0; display: flex; flex-direction: column; gap: 1px;">
                            ${eventsHTML}
                            ${moreEvents}
                        </div>
                        
                        <!-- Derecha: S√≠mbolos astron√≥micos -->
                        ${(eclipse || retrogrades.length > 0 || signChanges.length > 0 || interAspects.length > 0 || stellium || majorAspect) ? `
                        <div style="display: flex; flex-direction: column; gap: 2px; font-size: 1.2em; flex-shrink: 0;">
                            ${eclipse ? `<div onclick="event.stopPropagation(); showEclipseModal('${eclipse.type}', '${eclipse.name}', '${dayDate.getTime()}')" style="cursor: pointer; line-height: 1;" title="${eclipse.name}">${eclipse.type === 'solar' ? '‚òÄÔ∏è' : 'üåï'}</div>` : ''}
                            ${interAspects.map(asp => {
                                return `<div onclick="event.stopPropagation(); handleInterAspectClick(${dayDate.getTime()}, ${dayCounter})" style="color: ${asp.color}; font-weight: bold; cursor: pointer; line-height: 1; font-size: 1.3em;" title="${asp.planet1} ${asp.symbol} ${asp.planet2}">${asp.symbol}</div>`;
                            }).join('')}
                            ${retrogrades.map(r => `<div onclick="event.stopPropagation(); showRetrogradeModal('${r.planet}', '${r.symbol}', ${r.isStart}, '${dayDate.toDateString()}')" style="color: ${r.isStart ? '#ff6b6b' : '#4ecdc4'}; font-weight: bold; cursor: pointer; line-height: 1; font-size: 1.5em;" title="${r.planet} ${r.isStart ? 'inicia retrogradaci√≥n' : 'vuelve directo'}">${r.isStart ? 'R' : 'D'}</div>`).join('')}
                            ${signChanges.map(sc => `<div onclick="event.stopPropagation(); showSignChangeModal('${sc.planet}', '${sc.symbol}', '${sc.toSign}', '${sc.meaning}', '${dayDate.getTime()}')" style="color: ${sc.color}; font-weight: bold; cursor: pointer; line-height: 1; font-size: 1em;" title="${sc.planet} ‚Üí ${sc.toSign}">C</div>`).join('')}
                            ${stellium ? `<div onclick="event.stopPropagation(); showStelliumModal('${stellium.sign}', '${stellium.planets.join('|')}', ${stellium.count}, '${dayDate.getTime()}')" style="color: ${stellium.count === 3 ? '#FFD700' : stellium.count === 4 ? '#f39c12' : '#e74c3c'}; font-weight: bold; cursor: pointer; line-height: 1; font-size: 1.1em;" title="Stellium en ${stellium.sign}">‚òÖ</div>` : ''}
                            ${majorAspect ? `<div onclick="event.stopPropagation(); showMajorAspectModal('${majorAspect.type}', '${majorAspect.planets.join('|')}', '${majorAspect.meaning}', '${majorAspect.impact}', '${dayDate.getTime()}')" style="color: ${majorAspect.type === 'T-Square' ? '#ff6b6b' : majorAspect.type === 'Kite' ? '#9b59b6' : '#4ecdc4'}; font-weight: bold; cursor: pointer; line-height: 1; font-size: 1.5em;" title="${majorAspect.type}">${majorAspect.type === 'T-Square' ? '‚ä•' : majorAspect.type === 'Kite' ? 'ü™Å' : '‚ñ≠'}</div>` : ''}
                        </div>
                        ` : ''}
                    </div>
                </div>
            `;
            
            currentDate.setDate(currentDate.getDate() + 1);
            dayCounter++;
            renderedDays++;
        }
        
        html += `</div></div>`; // Close days-container and lunar-week
    });
    
    return html;
}

// Remove old generateSolarDayCard - not needed anymore

// Cerrar modales al hacer clic fuera
window.onclick = function(event) {
    const aspectsModal = document.getElementById('aspectsModal');
    const eventsModal = document.getElementById('eventsModal');
    const dayOptionsModal = document.getElementById('dayOptionsModal');
    const eclipseModal = document.getElementById('eclipseModal');
    const retrogradeModal = document.getElementById('retrogradeModal');
    const signChangeModal = document.getElementById('signChangeModal');
    const stelliumModal = document.getElementById('stelliumModal');
    const diarioModal = document.getElementById('diarioModal');
    const majorAspectModal = document.getElementById('majorAspectModal');
    const planetAspectsModal = document.getElementById('planetAspectsModal');
    
    if (event.target === aspectsModal) {
        closeAspectsModal();
    }
    if (event.target === eventsModal) {
        closeEventsModal();
    }
    if (event.target === dayOptionsModal) {
        closeDayOptionsModal();
    }
    if (event.target === eclipseModal) {
        closeEclipseModal();
    }
    if (event.target === retrogradeModal) {
        closeRetrogradeModal();
    }
    if (event.target === signChangeModal) {
        closeSignChangeModal();
    }
    if (event.target === stelliumModal) {
        closeStelliumModal();
    }
    if (event.target === diarioModal) {
        closeDiarioModal();
    }
    if (event.target === majorAspectModal) {
        closeMajorAspectModal();
    }
    if (event.target === planetAspectsModal) {
        closePlanetAspectsModal();
    }
}

// ==============================================
// ==============================================
// SISTEMA CENTRALIZADO DE DATOS
// ==============================================

/**
 * CORE DATA LAYER - Single source of truth
 * Ambos calendarios (lunar y solar) usan estas funciones
 */

// Get all planetary events for a specific date
function getAllPlanetaryEvents(date) {
    const aspects = getAspects(date);
    const signChanges = getSignChanges(date);
    const retrogrades = getRetrogrades(date);
    const interAspects = getInterPlanetaryAspects(date);
    const eclipse = getEclipseInfo(date);
    
    return {
        aspects: aspects,
        signChanges: signChanges,
        retrogrades: retrogrades,
        interPlanetaryAspects: interAspects,
        eclipse: eclipse,
        totalCount: aspects.length + signChanges.length + retrogrades.length + interAspects.length + (eclipse ? 1 : 0)
    };
}

// Get complete day data (unified for both calendars)
function getDayData(date) {
    const events = getAllPlanetaryEvents(date);
    const userEvents = getEventsForDate(date);
    const journal = getJournalForDate(date);
    
    return {
        date: date,
        planetaryEvents: events,
        userEvents: userEvents,
        journal: journal,
        hasActivity: events.totalCount > 0 || userEvents.length > 0 || journal.length > 0
    };
}

// Unified function to render a day cell (used by both lunar and solar calendars)
function renderDayCell(date, dayNumber, displayInfo, additionalClasses = '') {
    const dayData = getDayData(date);
    const isToday = isSameDay(date, new Date());
    const hasEvents = dayData.userEvents.length > 0;
    const hasAspects = dayData.planetaryEvents.totalCount > 0;
    
    // Build classes
    let classes = 'calendar-day';
    if (isToday) classes += ' today';
    if (hasEvents) classes += ' has-events';
    if (hasAspects) classes += ' has-aspects';
    if (additionalClasses) classes += ' ' + additionalClasses;
    
    // Event indicators
    let indicators = '';
    if (hasEvents) {
        indicators += `<div class="event-indicator" title="${dayData.userEvents.length} evento(s)">üìÖ ${dayData.userEvents.length}</div>`;
    }
    if (hasAspects) {
        indicators += `<div class="aspect-indicator" title="${dayData.planetaryEvents.totalCount} aspecto(s)">‚≠ê ${dayData.planetaryEvents.totalCount}</div>`;
    }
    
    // Build day data for click handler
    const dayDataStr = JSON.stringify({
        lunarDay: dayNumber,
        aspects: dayData.planetaryEvents.aspects,
        date: date.toISOString()
    }).replace(/'/g, "\\'").replace(/"/g, '&quot;');
    
    return `
        <div class="${classes}"
             data-date="${date.getTime()}"
             data-lunar-day="${dayNumber}"
             data-has-aspects="${hasAspects}"
             data-day-data='${dayDataStr}'
             onclick="handleDayClick(this)">
            <div class="day-number">${dayNumber}</div>
            <div class="day-date">${date.getDate()} ${t('months')[date.getMonth()]}</div>
            ${displayInfo}
            ${indicators}
        </div>
    `;
}

// ==============================================
// RENDERIZADO DEL CALENDARIO
// ==============================================

function renderCalendar() {
    const weeks = calculateLunarCycle(currentCycleStart);
    const container = document.getElementById('lunarWeeks');
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    const cycleEnd = weeks[weeks.length - 1].endDate;
    document.getElementById('cycleNumber').textContent = 'Ciclo Lunar Completo';
    document.getElementById('cycleDates').textContent = 
        `${formatLongDate(weeks[0].startDate)} - ${formatLongDate(cycleEnd)}`;
    
    // SIEMPRE mostrar informaci√≥n del d√≠a actual, independiente del ciclo mostrado
    const todayNewMoon = findNearestNewMoon(today);
    const todayWeeks = calculateLunarCycle(todayNewMoon);
    
    let currentWeekIndex = -1;
    let currentDayInCycle = null;
    
    todayWeeks.forEach((week, index) => {
        week.days.forEach(day => {
            if (day.date.toDateString() === today.toDateString()) {
                currentWeekIndex = index;
                currentDayInCycle = day;
            }
        });
    });
    
    // Si no se encontr√≥ el d√≠a de hoy en el ciclo calculado, intentar con fecha m√°s precisa
    if (!currentDayInCycle) {
        console.log('D√≠a de hoy no encontrado en primer intento, buscando en lista completa...');
        // Buscar el ciclo que contiene hoy
        for (const newMoon of newMoonsLocal) {
            const testWeeks = calculateLunarCycle(newMoon);
            let found = false;
            testWeeks.forEach((week, index) => {
                week.days.forEach(day => {
                    if (day.date.toDateString() === today.toDateString()) {
                        currentWeekIndex = index;
                        currentDayInCycle = day;
                        found = true;
                    }
                });
            });
            if (found) break;
        }
    }
    
    // Mostrar t√≠tulo "Hoy" siempre (incluso si no se encuentra, mostrar info b√°sica)
    if (currentDayInCycle) {
        const elongation = calculateLunarPhase(new Date());
        const emoji = getMoonEmoji(elongation);
        const moonLongitude = getMoonPosition(today);
        const moonSignData = getZodiacSignWithDegree(moonLongitude);
        const moonSign = moonSignData.formatted; // Ahora incluye grado
        
        const weekDayNumber = (() => {
            console.log('=== CALCULANDO D√çA DE SEMANA ===');
            console.log('Hoy:', today.toDateString());
            console.log('todayWeeks length:', todayWeeks.length);
            console.log('currentWeekIndex:', currentWeekIndex);
            
            // Buscar en TODAS las semanas hasta encontrar hoy
            for (let weekIdx = 0; weekIdx < todayWeeks.length; weekIdx++) {
                const week = todayWeeks[weekIdx];
                console.log(`Semana ${weekIdx + 1}:`, week.name, 'd√≠as:', week.days.length);
                
                for (let dayIdx = 0; dayIdx < week.days.length; dayIdx++) {
                    const dayDate = new Date(week.days[dayIdx].date);
                    dayDate.setHours(0, 0, 0, 0);
                    const todayClean = new Date(today);
                    todayClean.setHours(0, 0, 0, 0);
                    
                    if (dayIdx === 0 || dayIdx === week.days.length - 1) {
                        console.log(`  D√≠a ${dayIdx + 1}:`, dayDate.toDateString());
                    }
                    
                    if (dayDate.getTime() === todayClean.getTime()) {
                        console.log('‚úÖ ENCONTRADO! Semana', weekIdx + 1, 'D√≠a', dayIdx + 1);
                        return dayIdx + 1; // Base-1: primer d√≠a = 1
                    }
                }
            }
            console.log('‚ùå NO ENCONTRADO');
            return 0; // No encontrado
        })();
        
        const todayAspects = currentDayInCycle.aspects;
        const todayEvents = getEventsForDate(today);
        const todaySignChanges = getSignChanges(today);
        const todayRetrogrades = getRetrogrades(today);
        const todayInterAspects = getInterPlanetaryAspects(today);
        
        // Combinar TODOS los eventos planetarios del d√≠a
        const allPlanetaryEvents = [
            ...todayInterAspects.map(asp => ({ type: 'interPlanetaryAspect', data: asp })),
            ...todayAspects.map(asp => ({ type: 'aspect', data: asp })),
            ...todaySignChanges.map(ch => ({ type: 'signChange', data: ch })),
            ...todayRetrogrades.map(ret => ({ type: 'retrograde', data: ret }))
        ];
        
        document.getElementById('currentDayInfo').style.display = 'block';
        document.getElementById('currentDayInfo').innerHTML = `
            <div style="display: grid; grid-template-columns: auto 1fr auto; gap: 6px; align-items: center; font-size: 0.7em;">
                
                <!-- Izquierda: Eventos/Agenda -->
                <div style="background: rgba(0,0,0,0.15); padding: 4px 6px; border-radius: 4px; border-left: 2px solid #4ecdc4; min-width: 0; max-width: 150px;">
                    <div style="font-size: 0.6em; color: #4ecdc4; font-weight: bold; margin-bottom: 2px; text-transform: uppercase;">
                        üìÖ ${currentLang === 'es' ? 'Eventos' : 'Events'}${todayEvents.length > 0 ? ` (${todayEvents.length})` : ''}
                    </div>
                    ${todayEvents.length > 0 ? `
                    <div style="display: flex; flex-direction: column; gap: 2px;">
                        ${todayEvents.slice(0, 2).map((evt, idx) => {
                            const eventKey = getDateKey(today);
                            const isCompleted = evt.completed || false;
                            return `
                            <div style="font-size: 0.65em; padding: 2px 3px; background: rgba(78,205,196,0.2); border-radius: 3px; display: flex; align-items: center; gap: 4px; border-left: 2px solid ${evt.type === 'reminder' ? '#f5576c' : evt.type === 'appointment' ? '#f0e68c' : '#4ecdc4'};">
                                <input type="checkbox" ${isCompleted ? 'checked' : ''} 
                                       onclick="toggleEventComplete('${eventKey}', ${idx}); event.stopPropagation();"
                                       style="cursor: pointer; width: 12px; height: 12px; flex-shrink: 0;">
                                <span style="cursor: pointer; flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; ${isCompleted ? 'text-decoration: line-through; opacity: 0.6;' : ''}"
                                      onclick="openEventsModal(new Date(${today.getTime()}), ${currentDayInCycle.lunarDay})">
                                    ${evt.time ? `<span style="font-weight: bold; color: #f0e68c;">${evt.time}</span> ` : ''}${evt.title}
                                </span>
                            </div>`;
                        }).join('')}
                        ${todayEvents.length > 2 ? `<div style="font-size: 0.6em; text-align: center; color: #4ecdc4;">+${todayEvents.length - 2}</div>` : ''}
                    </div>
                    ` : `
                    <div style="font-size: 0.6em; color: rgba(78,205,196,0.5); font-style: italic; padding: 4px 0;">
                        ${currentLang === 'es' ? 'Sin eventos' : 'No events'}
                    </div>
                    `}
                </div>
                
                <!-- Centro: Info del d√≠a - TODO CLICKABLE -->
                <div onclick="goToCurrentCycle()" style="text-align: center; cursor: pointer; transition: all 0.2s; padding: 4px; border-radius: 6px;"
                     onmouseover="this.style.background='rgba(240,230,140,0.1)'; this.style.transform='scale(1.02)';" 
                     onmouseout="this.style.background='transparent'; this.style.transform='scale(1)';"
                     title="${currentLang === 'es' ? 'Click para ir al d√≠a actual' : 'Click to go to current day'}">
                    <div style="font-size: 2em; font-weight: bold; margin-bottom: 2px; display: inline-block; line-height: 1;">
                        ${currentDayInCycle.lunarDay}
                    </div>
                    <div style="font-size: 1.4em; margin: 2px 0;">${emoji}</div>
                    <div style="font-size: 0.6em; margin: 2px 0;">
                        ${currentLang === 'es' ? 'Semana' : 'Week'} ${currentWeekIndex + 1} ‚Ä¢ ${currentLang === 'es' ? 'D√≠a' : 'Day'} ${weekDayNumber}
                    </div>
                    <div style="font-size: 0.55em; margin: 2px 0;">
                        ${todayWeeks[currentWeekIndex].name}
                    </div>
                    <div style="font-size: 0.5em; opacity: 0.7; margin-top: 2px;">
                        ${moonSign}
                    </div>
                    <div style="font-size: 0.6em; font-weight: 600; margin-top: 2px; color: rgba(255, 255, 255, 0.95);">
                        ${formatLongDate(today)}
                    </div>
                </div>
                
                <!-- Derecha: TODOS los Eventos Planetarios -->
                <div style="background: rgba(0,0,0,0.25); padding: 4px 6px; border-radius: 4px; border-left: 2px solid #f0e68c; min-width: 0; max-width: 150px;">
                    <div style="font-size: 0.6em; color: #f0e68c; font-weight: bold; margin-bottom: 2px; text-transform: uppercase;">
                        üåô ${currentLang === 'es' ? 'Luna Hoy' : 'Moon Today'}${allPlanetaryEvents.length > 0 ? ` (${allPlanetaryEvents.length})` : ''}
                    </div>
                    ${allPlanetaryEvents.length > 0 ? `
                    <div style="display: flex; flex-direction: column; gap: 2px;">
                        ${allPlanetaryEvents.slice(0, 3).map(event => {
                            if (event.type === 'aspect') {
                                const asp = event.data;
                                const color = asp.class === 'conjunction' ? '#ff6b6b' : 
                                             asp.class === 'sextile' ? '#4ecdc4' :
                                             asp.class === 'square' ? '#ff9f43' :
                                             asp.class === 'trine' ? '#5f27cd' : '#ee5a6f';
                                const dayDataStr = JSON.stringify(currentDayInCycle).replace(/'/g, "\\'").replace(/"/g, '&quot;');
                                return `
                                <div onclick="openAspectsModal(new Date(${today.getTime()}), ${currentDayInCycle.lunarDay}, JSON.parse('${dayDataStr}'))" 
                                     style="font-size: 0.65em; padding: 2px 3px; background: rgba(0,0,0,0.3); border-radius: 3px; cursor: pointer; display: flex; align-items: center; gap: 2px; border-left: 2px solid ${color};">
                                    <span style="color: #fff;">${tp('Luna')} ${asp.symbol} ${tp(asp.planetName)}</span>
                                </div>
                            `;
                            } else if (event.type === 'interPlanetaryAspect') {
                                const asp = event.data;
                                const timeStr = asp.time ? `<span style="font-weight: bold; color: #f0e68c;">${asp.time}</span> ` : '';
                                return `
                                <div onclick="openAspectsModal(new Date(${today.getTime()}), ${currentDayInCycle.lunarDay}, JSON.parse('${JSON.stringify(currentDayInCycle).replace(/'/g, "\\'").replace(/"/g, '&quot;')}'))" 
                                     style="font-size: 0.65em; padding: 2px 3px; background: rgba(0,0,0,0.3); border-radius: 3px; cursor: pointer; display: flex; align-items: center; gap: 2px; border-left: 2px solid ${asp.color};">
                                    <span style="color: #fff;">${timeStr}${tp(asp.planet1)} ${asp.symbol} ${tp(asp.planet2)}</span>
                                </div>
                            `;
                            } else if (event.type === 'signChange') {
                                const ch = event.data;
                                const timeStr = ch.time ? `<span style="font-weight: bold; color: #f0e68c;">${ch.time}</span> ` : '';
                                return `
                                <div onclick="openAspectsModal(new Date(${today.getTime()}), ${currentDayInCycle.lunarDay}, JSON.parse('${JSON.stringify(currentDayInCycle).replace(/'/g, "\\'").replace(/"/g, '&quot;')}'))" 
                                     style="font-size: 0.65em; padding: 2px 3px; background: rgba(0,0,0,0.3); border-radius: 3px; cursor: pointer; display: flex; align-items: center; gap: 2px; border-left: 2px solid ${ch.color};">
                                    <span style="color: #fff;">${timeStr}${tp(ch.planet)} ‚Üí ${ts(ch.toSign)}</span>
                                </div>
                            `;
                            } else if (event.type === 'retrograde') {
                                const ret = event.data;
                                return `
                                <div onclick="openAspectsModal(new Date(${today.getTime()}), ${currentDayInCycle.lunarDay}, JSON.parse('${JSON.stringify(currentDayInCycle).replace(/'/g, "\\'").replace(/"/g, '&quot;')}'))" 
                                     style="font-size: 0.65em; padding: 2px 3px; background: rgba(0,0,0,0.3); border-radius: 3px; cursor: pointer; display: flex; align-items: center; gap: 2px; border-left: 2px solid #ff6b6b;">
                                    <span style="color: #fff;">${tp(ret.planet)} ${ret.isStart ? 'R' : 'D'}</span>
                                </div>
                            `;
                            }
                        }).join('')}
                        ${allPlanetaryEvents.length > 3 ? `<div style="font-size: 0.6em; text-align: center; color: #a8b2d1;">+${allPlanetaryEvents.length - 3}</div>` : ''}
                    </div>
                    ` : `
                    <div style="font-size: 0.6em; color: rgba(240,230,140,0.5); font-style: italic; padding: 4px 0;">
                        ${currentLang === 'es' ? 'Sin aspectos' : 'No aspects'}
                    </div>
                    `}
                </div>
            </div>
        `;
    }
    
    // Renderizar el ciclo mostrado (puede ser diferente al actual)
    let displayWeekIndex = -1;
    weeks.forEach((week, index) => {
        week.days.forEach(day => {
            if (day.date.getTime() === today.getTime()) {
                displayWeekIndex = index;
            }
        });
    });
    
    container.innerHTML = '';
    
    weeks.forEach((week, index) => {
        const weekDiv = document.createElement('div');
        weekDiv.className = 'lunar-week' + (index === currentWeekIndex ? ' active' : '');
        
        const daysHTML = week.days.map(day => {
            const isToday = day.date.getTime() === today.getTime();
            const dayEvents = getEventsForDate(day.date);
            const hasEvents = dayEvents.length > 0;
            const hasAspects = day.aspects.length > 0;
            const weekend = isWeekend(day.date);
            const weekday = getWeekdayName(day.date);
            const eclipse = getEclipseInfo(day.date);
            const retrogrades = getRetrogrades(day.date);
            const signChanges = getSignChanges(day.date);
            const interAspects = getInterPlanetaryAspects(day.date);
            const stellium = getStellium(day.date);
            const majorAspect = getMajorAspect(day.date);
            
            // Solo mostrar eventos del usuario
            const eventsHTML = dayEvents.slice(0, 3).map(event => `
                <div class="day-event-item type-${event.type}">
                    ${event.time ? `<span class="event-time-badge">${event.time}</span> ` : ''}${event.title}
                </div>
            `).join('');
            
            const moreEvents = dayEvents.length > 3 ? `
                <div style="text-align: center; font-style: italic; font-size: 0.85em; margin-top: 2px; color: #a8b2d1;">
                    +${dayEvents.length - 3} m√°s
                </div>
            ` : '';
            
            const dayDataStr = JSON.stringify(day).replace(/'/g, "\\'").replace(/"/g, '&quot;');
            
            return `
                <div class="day-cell ${isToday ? 'today' : ''} ${weekend ? 'weekend' : ''}" 
                     data-date="${day.date.getTime()}"
                     data-lunar-day="${day.lunarDay}"
                     data-has-aspects="${hasAspects}"
                     data-day-data='${dayDataStr}'
                     onclick="handleDayClick(this)">
                    
                    <div class="day-header">
                        <div style="display: flex; align-items: center; justify-content: space-between; width: 100%; gap: 4px;">
                            <div style="display: flex; align-items: baseline; gap: 4px;">
                                <div class="day-number">${day.lunarDay}</div>
                                <div class="day-date" style="font-size: 0.65em; color: rgba(255, 255, 255, 0.6);">${formatShortDate(day.date)}</div>
                                <div class="day-weekday" style="font-size: 0.55em; color: rgba(255, 255, 255, 0.5); text-transform: uppercase; font-weight: 600;">${weekday}</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="day-content">
                        <!-- Izquierda: Eventos -->
                        <div style="flex: 1; min-width: 0; display: flex; flex-direction: column; gap: 1px;">
                            ${eventsHTML}
                            ${moreEvents}
                        </div>
                        
                        <!-- Derecha: S√≠mbolos astron√≥micos -->
                        ${(eclipse || retrogrades.length > 0 || signChanges.length > 0 || interAspects.length > 0 || stellium || majorAspect) ? `
                        <div style="display: flex; flex-direction: column; gap: 2px; font-size: 1.2em; flex-shrink: 0;">
                            ${eclipse ? `<div onclick="event.stopPropagation(); showEclipseModal('${eclipse.type}', '${eclipse.name}', '${day.date.getTime()}')" style="cursor: pointer; line-height: 1;" title="${eclipse.name}">${eclipse.type === 'solar' ? '‚òÄÔ∏è' : 'üåï'}</div>` : ''}
                            ${interAspects.map(asp => {
                                return `<div onclick="event.stopPropagation(); handleInterAspectClick(${day.date.getTime()}, ${day.lunarDay})" style="color: ${asp.color}; font-weight: bold; cursor: pointer; line-height: 1; font-size: 1.3em;" title="${asp.planet1} ${asp.symbol} ${asp.planet2}">${asp.symbol}</div>`;
                            }).join('')}
                            ${retrogrades.map(r => `<div onclick="event.stopPropagation(); showRetrogradeModal('${r.planet}', '${r.symbol}', ${r.isStart}, '${day.date.toDateString()}')" style="color: ${r.isStart ? '#ff6b6b' : '#4ecdc4'}; font-weight: bold; cursor: pointer; line-height: 1; font-size: 1.1em;" title="${r.planet} ${r.isStart ? 'inicia retrogradaci√≥n' : 'vuelve directo'}">${r.isStart ? 'R' : 'D'}</div>`).join('')}
                            ${signChanges.map(sc => `<div onclick="event.stopPropagation(); showSignChangeModal('${sc.planet}', '${sc.symbol}', '${sc.toSign}', '${sc.meaning}', '${day.date.getTime()}')" style="color: ${sc.color}; font-weight: bold; cursor: pointer; line-height: 1; font-size: 1em;" title="${sc.planet} ‚Üí ${sc.toSign}">C</div>`).join('')}
                            ${stellium ? `<div onclick="event.stopPropagation(); showStelliumModal('${stellium.sign}', '${stellium.planets.join('|')}', ${stellium.count}, '${day.date.getTime()}')" style="color: ${stellium.count === 3 ? '#FFD700' : stellium.count === 4 ? '#f39c12' : '#e74c3c'}; font-weight: bold; cursor: pointer; line-height: 1; font-size: 1.1em;" title="Stellium en ${stellium.sign}">‚òÖ</div>` : ''}
                            ${majorAspect ? `<div onclick="event.stopPropagation(); showMajorAspectModal('${majorAspect.type}', '${majorAspect.planets.join('|')}', '${majorAspect.meaning}', '${majorAspect.impact}', '${day.date.getTime()}')" style="color: ${majorAspect.type === 'T-Square' ? '#ff6b6b' : majorAspect.type === 'Kite' ? '#9b59b6' : '#4ecdc4'}; font-weight: bold; cursor: pointer; line-height: 1; font-size: 1.5em;" title="${majorAspect.type}">${majorAspect.type === 'T-Square' ? '‚ä•' : majorAspect.type === 'Kite' ? 'ü™Å' : '‚ñ≠'}</div>` : ''}
                        </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }).join('');
        
        weekDiv.innerHTML = `
            <div class="week-header">
                <div class="moon-icon">${week.emoji}</div>
                <div class="week-info">
                    <div style="display: flex; align-items: center; gap: 3px; flex-wrap: nowrap; font-size: 0.65em; width: 100%; overflow: hidden;">
                        <span style="font-weight: bold; white-space: nowrap;">${week.name}</span>
                        <span style="opacity: 0.6;">‚Ä¢</span>
                        <span style="white-space: nowrap;">${week.days.length}d</span>
                        <span style="opacity: 0.6;">‚Ä¢</span>
                        <span style="white-space: nowrap; font-size: 0.95em;">${formatDate(week.startDate)} - ${formatDate(week.endDate)}</span>
                        <span style="opacity: 0.6;">‚Ä¢</span>
                        <span style="color: #f0e68c; white-space: nowrap; font-size: 0.95em;">${week.zodiacSign}</span>
                    </div>
                </div>
            </div>
            <div class="days-container">${daysHTML}${(() => {
                // Fill empty cells at the END to complete 8 columns (lunar week = 8 days)
                const emptyCellsNeeded = 8 - week.days.length;
                let emptyCells = '';
                for (let i = 0; i < emptyCellsNeeded; i++) {
                    emptyCells += '<div class="day-cell" style="visibility: hidden; pointer-events: none;"></div>';
                }
                return emptyCells;
            })()}</div>
        `;
        
        container.appendChild(weekDiv);
    });
}

function nextCycle() {
    currentCycleStart = getNextNewMoon(currentCycleStart);
    renderCalendar();
    window.scrollTo(0, 0);
}

function previousCycle() {
    currentCycleStart = getPreviousNewMoon(currentCycleStart);
    renderCalendar();
    window.scrollTo(0, 0);
}

function goToCurrentCycle() {
    console.log('üìç Navegando al d√≠a actual...');
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    if (calendarMode === 'solar') {
        // Para calendario solar: ir al signo actual
        currentSignIndex = getCurrentSign();
        renderSolarCalendar();
    } else {
        // Para calendario lunar: buscar el ciclo que contiene HOY
        let foundNewMoon = null;
        
        for (const newMoon of newMoonsLocal) {
            const cycleStart = new Date(newMoon);
            cycleStart.setHours(0, 0, 0, 0);
            
            // Calcular el final aproximado del ciclo (29 d√≠as despu√©s)
            const cycleEnd = new Date(cycleStart);
            cycleEnd.setDate(cycleEnd.getDate() + 29);
            
            // Si hoy est√° entre el inicio y fin de este ciclo
            if (today >= cycleStart && today <= cycleEnd) {
                foundNewMoon = new Date(newMoon);
                console.log(`‚úÖ Ciclo actual encontrado: ${foundNewMoon.toLocaleDateString()}`);
                break;
            }
        }
        
        if (foundNewMoon) {
            currentCycleStart = foundNewMoon;
        } else {
            console.log('‚ö†Ô∏è No se encontr√≥ ciclo exacto, usando el m√°s cercano');
            currentCycleStart = findNearestNewMoon(today);
        }
        
        renderCalendar();
    }
    
    window.scrollTo(0, 0);
}

// ==============================================
// INICIALIZACI√ìN
// ==============================================

loadEvents();
loadJournals();

// Initialize language
updateLanguageButtons();
updateUILanguage();

// Add language button event listeners
document.getElementById('langES').addEventListener('click', function() {
    changeLanguage('es');
});
document.getElementById('langEN').addEventListener('click', function() {
    changeLanguage('en');
});

// Initialize calendar based on saved mode
updateModeButtons();
if (calendarMode === 'solar') {
    document.body.classList.add('solar-mode');
    currentSignIndex = getCurrentSign();
    renderSolarCalendar();
} else {
    renderCalendar();
}

// Update planet button counters
updatePlanetButtonCounters();

// Update notification button status
updateNotificationButton();

// ==============================================
// NOTIFICATION SYSTEM
// ==============================================

// Request notification permission on load
if ('Notification' in window && Notification.permission === 'default') {
    Notification.requestPermission().then(permission => {
        console.log('üì¢ Notification permission:', permission);
    });
}

// Check for events/aspects that need notifications
function checkNotifications() {
    // Check if notifications are enabled by user
    const notificationsEnabled = localStorage.getItem('notificationsEnabled') !== 'false';
    
    if (!notificationsEnabled || !('Notification' in window) || Notification.permission !== 'granted') {
        return;
    }
    
    const now = new Date();
    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    const todayKey = getDateKey(today);
    
    // Check user events
    const todayEvents = events[todayKey] || [];
    todayEvents.forEach(event => {
        if (event.time && !event.notified) {
            const [hours, minutes] = event.time.split(':');
            const eventTime = new Date(today);
            eventTime.setHours(parseInt(hours), parseInt(minutes), 0, 0);
            
            // Notify 15 minutes before
            const notifyTime = new Date(eventTime.getTime() - 15 * 60 * 1000);
            
            if (now >= notifyTime && now < eventTime) {
                new Notification('üìÖ ' + (currentLang === 'es' ? 'Evento pr√≥ximo' : 'Upcoming Event'), {
                    body: `${event.time} - ${event.title}`,
                    icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y="75" font-size="75">üìÖ</text></svg>',
                    tag: `event-${todayKey}-${event.title}`,
                    requireInteraction: false
                });
                
                event.notified = true;
                saveEvents();
            }
        }
    });
    
    // Check planetary events (once per day)
    const notifiedKey = `notified-${todayKey}`;
    if (!localStorage.getItem(notifiedKey)) {
        const planetaryEvents = getAllPlanetaryEvents(today);
        
        // Check if today is start of a lunar phase
        const lunarPhaseNotified = checkLunarPhaseStart(today);
        
        if (planetaryEvents.totalCount > 0 || lunarPhaseNotified) {
            const messages = [];
            
            // Eclipses
            if (planetaryEvents.eclipse) {
                messages.push(`${planetaryEvents.eclipse.type === 'solar' ? '‚òÄÔ∏è' : 'üåï'} ${planetaryEvents.eclipse.name}`);
            }
            
            // Inter-planetary aspects (major ones)
            planetaryEvents.interPlanetaryAspects.forEach(asp => {
                if (asp.isGenerational || asp.isImportant) {
                    messages.push(`${asp.planet1} ${asp.symbol} ${asp.planet2}`);
                }
            });
            
            // Sign changes (only important ones)
            planetaryEvents.signChanges.forEach(change => {
                if (change.isGenerational || change.isCritical || change.isImportant) {
                    messages.push(`${change.planet} ‚Üí ${change.toSign}`);
                }
            });
            
            if (messages.length > 0) {
                new Notification('‚≠ê ' + (currentLang === 'es' ? 'Eventos Astrol√≥gicos Hoy' : 'Astrological Events Today'), {
                    body: messages.slice(0, 3).join('\n'),
                    icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y="75" font-size="75">‚≠ê</text></svg>',
                    tag: `astro-${todayKey}`,
                    requireInteraction: false
                });
                
                localStorage.setItem(notifiedKey, 'true');
            }
        }
    }
}

// Check if today is the start of a lunar phase
function checkLunarPhaseStart(date) {
    const dateKey = getDateKey(date);
    const phaseKey = `lunar-phase-${dateKey}`;
    
    // Check if already notified today
    if (localStorage.getItem(phaseKey)) {
        return false;
    }
    
    // Find current cycle
    const cycle = getCurrentLunarCycle(date);
    if (!cycle) return false;
    
    // Check if this is day 1 of any phase
    const lunarDay = getLunarDayNumber(date, cycle);
    
    let phaseName = '';
    let phaseIcon = '';
    
    if (lunarDay === 1) {
        phaseName = currentLang === 'es' ? 'Luna Nueva' : 'New Moon';
        phaseIcon = 'üåë';
    } else if (lunarDay === 8) {
        phaseName = currentLang === 'es' ? 'Cuarto Creciente' : 'First Quarter';
        phaseIcon = 'üåì';
    } else if (lunarDay === 15) {
        phaseName = currentLang === 'es' ? 'Luna Llena' : 'Full Moon';
        phaseIcon = 'üåï';
    } else if (lunarDay === 23) {
        phaseName = currentLang === 'es' ? 'Cuarto Menguante' : 'Last Quarter';
        phaseIcon = 'üåó';
    }
    
    if (phaseName) {
        new Notification(`${phaseIcon} ${phaseName}`, {
            body: currentLang === 'es' ? 
                `Hoy inicia la fase de ${phaseName}` : 
                `${phaseName} phase begins today`,
            icon: `data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y="75" font-size="75">${phaseIcon}</text></svg>`,
            tag: `lunar-${dateKey}`,
            requireInteraction: false
        });
        
        localStorage.setItem(phaseKey, 'true');
        return true;
    }
    
    return false;
}

// Check notifications every 5 minutes
setInterval(checkNotifications, 5 * 60 * 1000);

// Initial check 2 seconds after page load
setTimeout(checkNotifications, 2000);

// CRITICAL: Expose functions to window for onclick handlers
window.deleteEventByIndex = deleteEvent;
window.handleInterAspectClick = handleInterAspectClick;
window.handleDayClick = handleDayClick;
window.toggleEventComplete = toggleEventComplete;

console.log('‚úÖ Window functions exposed:', {
    deleteEventByIndex: typeof window.deleteEventByIndex,
    handleInterAspectClick: typeof window.handleInterAspectClick,
    handleDayClick: typeof window.handleDayClick,
    toggleEventComplete: typeof window.toggleEventComplete
});

// Register Service Worker for offline support
if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/service-worker.js')
        .then(registration => {
            console.log('‚úÖ Service Worker registered:', registration.scope);
        })
        .catch(error => {
            console.log('‚ùå Service Worker registration failed:', error);
        });
}
    </script>
</body>
</html>
