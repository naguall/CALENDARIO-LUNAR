<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üåô Calendario Lunar Astrol√≥gico</title>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="Calendario lunar completo con fases exactas, aspectos planetarios, diario personal y agenda. Para Costa Rica UTC-6.">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Luna üåô">
    
    <!-- Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- iOS Icons -->
    <link rel="apple-touch-icon" href="icon-152.png">
    <link rel="apple-touch-icon" sizes="72x72" href="icon-72.png">
    <link rel="apple-touch-icon" sizes="192x192" href="icon-192.png">
    <link rel="apple-touch-icon" sizes="512x512" href="icon-512.png">
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="icon-72.png">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #fff;
            min-height: 100vh;
            padding: 8px;
            overflow-x: hidden;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 10px;
        }

        h1 {
            font-size: 1.4em;
            margin-bottom: 3px;
            background: linear-gradient(45deg, #f0e68c, #fff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            color: #a8b2d1;
            font-size: 0.75em;
        }

        .navigation {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 6px;
            background: rgba(255, 255, 255, 0.05);
            padding: 8px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
            gap: 8px;
            flex-wrap: nowrap;
        }

        .nav-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            padding: 6px 12px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 0.7em;
            transition: transform 0.2s;
            white-space: nowrap;
        }

        .nav-btn:hover {
            transform: scale(1.05);
        }

        .cycle-info {
            text-align: center;
            flex: 1;
            min-width: 0;
        }

        .cycle-number {
            font-size: 0.9em;
            font-weight: bold;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .cycle-dates {
            color: #a8b2d1;
            font-size: 0.7em;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .current-day-info {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            padding: 6px;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 6px;
        }

        .lunar-weeks {
            display: flex;
            flex-direction: column;
            gap: 3px;
            margin-bottom: 10px;
        }

        .lunar-week {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 5px;
            padding: 3px 5px;
            backdrop-filter: blur(10px);
            border: 1px solid transparent;
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .lunar-week:hover {
            border-color: rgba(255, 255, 255, 0.2);
        }

        .lunar-week.active {
            border-color: #f0e68c;
            box-shadow: 0 0 10px rgba(240, 230, 140, 0.3);
        }

        .week-header {
            display: flex;
            align-items: center;
            gap: 3px;
            flex-wrap: nowrap;
        }

        .moon-icon {
            font-size: 0.85em;
            filter: drop-shadow(0 0 5px rgba(240, 230, 140, 0.5));
        }

        .week-info {
            display: flex;
            align-items: center;
            gap: 4px;
            flex: 1;
            flex-wrap: nowrap;
            overflow: hidden;
        }

        .week-title-group {
            display: flex;
            align-items: center;
            gap: 3px;
        }

        .week-title {
            font-size: 0.7em;
            font-weight: bold;
            white-space: nowrap;
        }

        .week-duration {
            background: rgba(255, 255, 255, 0.1);
            padding: 1px 4px;
            border-radius: 8px;
            font-size: 0.6em;
            white-space: nowrap;
        }

        .week-details {
            display: none; /* Ocultar detalles para ahorrar espacio */
        }

        .week-dates {
            white-space: nowrap;
        }

        .perfection-time {
            color: #f0e68c;
            font-style: italic;
            white-space: nowrap;
        }

        .zodiac-sign {
            color: #f0e68c;
            white-space: nowrap;
        }

        .days-container {
            display: flex;
            gap: 2px;
            overflow-x: auto;
            padding: 2px 0;
            -webkit-overflow-scrolling: touch;
        }

        .days-container::-webkit-scrollbar {
            height: 3px;
        }

        .days-container::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 2px;
        }

        .days-container::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 2px;
        }

        .day-cell {
            min-width: 42px;
            max-width: 42px;
            min-height: 40px;
            max-height: 40px;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            justify-content: flex-start;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
            font-size: 0.6em;
            transition: all 0.2s;
            cursor: pointer;
            padding: 2px;
            flex-shrink: 0;
            position: relative;
            overflow: hidden;
        }

        .day-cell:hover {
            background: rgba(255, 255, 255, 0.12);
            transform: scale(1.02);
        }

        .day-cell.today {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-weight: bold;
            box-shadow: 0 0 8px rgba(102, 126, 234, 0.5);
        }

        .day-cell.weekend {
            background: rgba(102, 126, 234, 0.15);
            border: 1px solid rgba(102, 126, 234, 0.3);
        }

        .day-cell.weekend:hover {
            background: rgba(102, 126, 234, 0.25);
        }

        .day-cell.weekend.today {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
        }

        .day-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            width: 100%;
            margin-bottom: 1px;
            padding-bottom: 1px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .day-number {
            font-size: 0.95em;
            font-weight: bold;
            line-height: 1;
            flex: 0 0 auto;
        }

        .day-right {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            flex: 0 0 auto;
        }

        .day-date {
            font-size: 0.55em;
            color: rgba(255, 255, 255, 0.6);
            text-align: right;
            line-height: 1;
        }

        .day-weekday {
            font-size: 0.5em;
            color: rgba(255, 255, 255, 0.5);
            margin-top: 0px;
            text-transform: uppercase;
            font-weight: 600;
            letter-spacing: 0.1px;
            line-height: 1;
        }

        .day-cell.weekend .day-weekday {
            color: #667eea;
            font-weight: bold;
        }

        .day-cell.today .day-date,
        .day-cell.today .day-weekday {
            color: rgba(255, 255, 255, 0.9);
        }

        .day-content {
            width: 100%;
            font-size: 0.5em;
            display: flex;
            flex-direction: column;
            gap: 1px;
            overflow: hidden;
            max-height: 16px;
        }

        .day-event-item {
            background: rgba(0, 0, 0, 0.2);
            padding: 0px 2px;
            border-radius: 2px;
            border-left: 2px solid #667eea;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 1.1;
            font-size: 0.9em;
        }

        .day-event-item.type-reminder {
            border-left-color: #f5576c;
        }

        .day-event-item.type-appointment {
            border-left-color: #f0e68c;
        }

        .day-cell.today .day-event-item {
            background: rgba(255, 255, 255, 0.15);
        }

        .event-time-badge {
            font-size: 0.9em;
            margin-right: 4px;
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
        }

        .modal.show {
            display: block;
        }

        .modal-content {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            margin: 5% auto;
            padding: 30px;
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            width: 90%;
            max-width: 700px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            max-height: 85vh;
            overflow-y: auto;
        }

        .modal-content::-webkit-scrollbar {
            width: 8px;
        }

        .modal-content::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
        }

        .modal-content::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .modal-header h2 {
            font-size: 1.5em;
            color: #f0e68c;
        }

        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s;
        }

        .close:hover {
            color: #fff;
        }

        /* Aspects modal specific */
        .aspects-section {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .aspects-section h3 {
            color: #f0e68c;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .aspect-detail {
            background: rgba(0, 0, 0, 0.2);
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 10px;
            border-left: 4px solid;
        }

        .aspect-detail.conjunction {
            border-left-color: #ff6b6b;
        }

        .aspect-detail.sextile {
            border-left-color: #4ecdc4;
        }

        .aspect-detail.square {
            border-left-color: #ff9f43;
        }

        .aspect-detail.trine {
            border-left-color: #5f27cd;
        }

        .aspect-detail.opposition {
            border-left-color: #ee5a6f;
        }

        .aspect-planets {
            font-size: 1.1em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .aspect-description {
            font-size: 0.9em;
            color: #a8b2d1;
        }

        .journal-section {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 10px;
        }

        .journal-section h3 {
            color: #f0e68c;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .journal-textarea {
            width: 100%;
            min-height: 150px;
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 12px;
            color: #fff;
            font-family: inherit;
            font-size: 0.95em;
            resize: vertical;
            line-height: 1.6;
        }

        .journal-textarea:focus {
            outline: none;
            border-color: #667eea;
            background: rgba(0, 0, 0, 0.3);
        }

        .journal-textarea::placeholder {
            color: rgba(255, 255, 255, 0.4);
        }

        .journal-meta {
            margin-top: 10px;
            font-size: 0.85em;
            color: #a8b2d1;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .auto-save-indicator {
            color: #4ecdc4;
        }

        /* Events modal specific */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #a8b2d1;
            font-size: 0.9em;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: #fff;
            font-size: 1em;
            font-family: inherit;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            background: rgba(255, 255, 255, 0.08);
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 25px;
        }

        .btn {
            flex: 1;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s;
            font-weight: 600;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .btn-danger {
            background: linear-gradient(135deg, #f5576c 0%, #f093fb 100%);
            color: white;
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(245, 87, 108, 0.4);
        }

        .events-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .event-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #667eea;
        }

        .event-item.type-reminder {
            border-left-color: #f5576c;
        }

        .event-item.type-appointment {
            border-left-color: #f0e68c;
        }

        .event-title {
            font-weight: bold;
            font-size: 1.1em;
            margin-bottom: 5px;
        }

        .event-time {
            color: #a8b2d1;
            font-size: 0.85em;
            margin-bottom: 5px;
        }

        .event-description {
            color: #ccc;
            font-size: 0.9em;
            margin-top: 5px;
        }

        .event-actions {
            margin-top: 10px;
            display: flex;
            gap: 10px;
        }

        .event-actions button {
            padding: 5px 12px;
            font-size: 0.85em;
        }

        .no-events, .no-aspects {
            text-align: center;
            color: #a8b2d1;
            padding: 30px;
            font-style: italic;
        }

        .legend {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 15px;
            margin-top: 30px;
        }

        .legend h3 {
            margin-bottom: 15px;
        }

        .legend-items {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .legend-icon {
            font-size: 1.5em;
        }

        .aspects-legend {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .aspect-legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(255, 255, 255, 0.05);
            padding: 8px;
            border-radius: 6px;
            font-size: 0.85em;
        }

        .aspect-color-bar {
            width: 3px;
            height: 30px;
            border-radius: 2px;
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 1.8em;
            }

            .navigation {
                flex-direction: column;
                gap: 15px;
            }

            .week-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .week-info {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }

            .week-title {
                font-size: 1.1em;
            }

            .week-details {
                flex-direction: column;
                align-items: flex-start;
                gap: 5px;
            }

            .days-container {
                gap: 4px;
            }

            .day-cell {
                min-width: 130px;
                min-height: 110px;
                font-size: 0.95em;
            }

            .modal-content {
                width: 95%;
                margin: 10% auto;
                max-height: 90vh;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üåô Calendario Lunar Astrol√≥gico</h1>
            <p class="subtitle">Ciclo natural de la Luna ‚Ä¢ Aspectos Planetarios ‚Ä¢ Diario Personal</p>
        </header>

        <div class="navigation">
            <button class="nav-btn" onclick="previousCycle()">‚Üê Ciclo Anterior</button>
            <div class="cycle-info">
                <div class="cycle-number" id="cycleNumber">Ciclo Lunar</div>
                <div class="cycle-dates" id="cycleDates"></div>
            </div>
            <button class="nav-btn" onclick="nextCycle()">Ciclo Siguiente ‚Üí</button>
        </div>

        <div class="current-day-info" id="currentDayInfo"></div>

        <div class="lunar-weeks" id="lunarWeeks"></div>

        <div class="legend">
            <h3>üåô Fases Lunares</h3>
            <div class="legend-items">
                <div class="legend-item">
                    <span class="legend-icon">üåë</span>
                    <span>Luna Nueva - Conjunci√≥n exacta (0¬∞)</span>
                </div>
                <div class="legend-item">
                    <span class="legend-icon">üåì</span>
                    <span>Cuarto Creciente - 90¬∞ exacto</span>
                </div>
                <div class="legend-item">
                    <span class="legend-icon">üåï</span>
                    <span>Luna Llena - Oposici√≥n exacta (180¬∞)</span>
                </div>
                <div class="legend-item">
                    <span class="legend-icon">üåó</span>
                    <span>Cuarto Menguante - 270¬∞ exacto</span>
                </div>
            </div>
            
            <h3 style="margin-top: 25px;">‚≠ê Aspectos Planetarios</h3>
            <p style="font-size: 0.9em; color: #a8b2d1; margin-bottom: 15px;">
                Click en el bot√≥n <strong style="background: linear-gradient(135deg, #f0e68c 0%, #f5c563 100%); color: #1a1a2e; padding: 2px 8px; border-radius: 50%; font-weight: 900;">A</strong> dorado para ver aspectos del d√≠a y escribir en tu diario
            </p>
            <div class="aspects-legend">
                <div class="aspect-legend-item">
                    <div class="aspect-color-bar" style="background: #ff6b6b;"></div>
                    <span>‚òå Conjunci√≥n (0¬∞)</span>
                </div>
                <div class="aspect-legend-item">
                    <div class="aspect-color-bar" style="background: #4ecdc4;"></div>
                    <span>‚öπ Sextil (60¬∞)</span>
                </div>
                <div class="aspect-legend-item">
                    <div class="aspect-color-bar" style="background: #ff9f43;"></div>
                    <span>‚ñ° Cuadratura (90¬∞)</span>
                </div>
                <div class="aspect-legend-item">
                    <div class="aspect-color-bar" style="background: #5f27cd;"></div>
                    <span>‚ñ≥ Tr√≠gono (120¬∞)</span>
                </div>
                <div class="aspect-legend-item">
                    <div class="aspect-color-bar" style="background: #ee5a6f;"></div>
                    <span>‚òç Oposici√≥n (180¬∞)</span>
                </div>
            </div>
            
            <p style="margin-top: 15px; font-size: 0.85em; color: #a8b2d1;">
                <strong>Planetas:</strong> ‚òâ Sol, ‚òø Mercurio, ‚ôÄ Venus, ‚ôÇ Marte, ‚ôÉ J√∫piter, ‚ôÑ Saturno, ‚ôÖ Urano, ‚ôÜ Neptuno, ‚ôá Plut√≥n, ‚ö∑ Quir√≥n, ‚ö∏ Lilith<br>
                <strong>Uso:</strong> Click en el d√≠a para eventos/agenda ‚Ä¢ Click en bot√≥n <strong style="background: linear-gradient(135deg, #f0e68c 0%, #f5c563 100%); color: #1a1a2e; padding: 2px 8px; border-radius: 50%; font-weight: 900;">A</strong> para aspectos y diario
            </p>
        </div>
    </div>

    <!-- Modal de Aspectos y Diario -->
    <div id="aspectsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="aspectsModalTitle">Aspectos y Diario</h2>
                <span class="close" onclick="closeAspectsModal()">&times;</span>
            </div>
            <div id="aspectsModalBody">
                <!-- Aspectos -->
                <div class="aspects-section">
                    <h3>‚≠ê Aspectos Planetarios</h3>
                    <div id="aspectsDetails"></div>
                </div>

                <!-- Diario Personal -->
                <div class="journal-section">
                    <h3>üìì Diario Personal y Reflexiones</h3>
                    <textarea 
                        class="journal-textarea" 
                        id="journalText"
                        placeholder="Escribe tus reflexiones del d√≠a, c√≥mo te sientes, qu√© observas con los aspectos actuales...

Ejemplos:
‚Ä¢ Hoy me sent√≠ m√°s optimista (tr√≠gono Luna-J√∫piter)
‚Ä¢ Not√© mucha energ√≠a f√≠sica (conjunci√≥n Luna-Marte)
‚Ä¢ Conversaci√≥n importante en relaciones (sextil Luna-Venus)
‚Ä¢ Reflexiones sobre...
‚Ä¢ Sue√±os y observaciones..."></textarea>
                    <div class="journal-meta">
                        <div id="journalSaveStatus" class="auto-save-indicator"></div>
                        <div id="journalWordCount" style="color: #a8b2d1;"></div>
                    </div>
                </div>

                <div class="button-group">
                    <button class="btn btn-secondary" onclick="closeAspectsModal()">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Eventos/Agenda -->
    <div id="eventsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="eventsModalTitle">Eventos y Agenda</h2>
                <span class="close" onclick="closeEventsModal()">&times;</span>
            </div>
            <div id="eventsModalBody">
                <!-- Formulario para nuevo evento -->
                <div id="eventForm">
                    <h3 style="color: #f0e68c; margin-bottom: 15px;">Agregar Evento</h3>
                    <div class="form-group">
                        <label>Tipo de Evento</label>
                        <select id="eventType">
                            <option value="event">Evento</option>
                            <option value="appointment">Cita</option>
                            <option value="reminder">Recordatorio</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>T√≠tulo *</label>
                        <input type="text" id="eventTitle" placeholder="Nombre del evento" required>
                    </div>
                    <div class="form-group">
                        <label>Hora (opcional)</label>
                        <input type="time" id="eventTime">
                    </div>
                    <div class="form-group">
                        <label>Descripci√≥n</label>
                        <textarea id="eventDescription" placeholder="Detalles adicionales..."></textarea>
                    </div>
                    <div class="button-group">
                        <button class="btn btn-secondary" onclick="closeEventsModal()">Cancelar</button>
                        <button class="btn btn-primary" onclick="saveEvent()">Guardar Evento</button>
                    </div>
                </div>

                <!-- Lista de eventos del d√≠a -->
                <div id="eventsList" style="display: none;">
                    <h3 style="color: #f0e68c; margin-bottom: 15px;">Eventos Agendados</h3>
                    <div class="events-list" id="eventsContainer"></div>
                    <div class="button-group">
                        <button class="btn btn-secondary" onclick="closeEventsModal()">Cerrar</button>
                        <button class="btn btn-primary" onclick="showEventForm()">Agregar Evento</button>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <script>
// ==============================================
// C√ÅLCULOS ASTRON√ìMICOS Y LUNARES
// ==============================================

// S√≠mbolos planetarios
const planetSymbols = {
    sun: '‚òâ',
    mercury: '‚òø',
    venus: '‚ôÄ',
    mars: '‚ôÇ',
    jupiter: '‚ôÉ',
    saturn: '‚ôÑ',
    uranus: '‚ôÖ',
    neptune: '‚ôÜ',
    pluto: '‚ôá',
    chiron: '‚ö∑',
    lilith: '‚ö∏'
};

const planetNames = {
    sun: 'Sol',
    mercury: 'Mercurio',
    venus: 'Venus',
    mars: 'Marte',
    jupiter: 'J√∫piter',
    saturn: 'Saturno',
    uranus: 'Urano',
    neptune: 'Neptuno',
    pluto: 'Plut√≥n',
    chiron: 'Quir√≥n',
    lilith: 'Lilith'
};

const aspectDescriptions = {
    conjunction: 'Uni√≥n de energ√≠as, intensificaci√≥n',
    sextile: 'Oportunidad, flujo armonioso',
    square: 'Tensi√≥n creativa, desaf√≠o',
    trine: 'Armon√≠a natural, facilidad',
    opposition: 'Polaridad, integraci√≥n de opuestos'
};

// Nombres tradicionales de las lunas llenas
function getFullMoonName(date) {
    const month = date.getMonth();
    const names = [
        'Luna del Lobo', 'Luna de Nieve', 'Luna del Gusano', 'Luna Rosa',
        'Luna de Flores', 'Luna de Fresa', 'Luna del Ciervo', 'Luna del Esturi√≥n',
        'Luna de Cosecha', 'Luna del Cazador', 'Luna del Castor', 'Luna Fr√≠a'
    ];
    return names[month];
}

// Calcular Julian Day
function getJulianDay(date) {
    const year = date.getFullYear();
    const month = date.getMonth() + 1;
    const day = date.getDate() + date.getHours() / 24;
    
    let a = Math.floor((14 - month) / 12);
    let y = year + 4800 - a;
    let m = month + 12 * a - 3;
    
    return day + Math.floor((153 * m + 2) / 5) + 365 * y + 
           Math.floor(y / 4) - Math.floor(y / 100) + 
           Math.floor(y / 400) - 32045;
}

// Calcular posici√≥n de la Luna
function getMoonPosition(date) {
    const jd = getJulianDay(date);
    const T = (jd - 2451545.0) / 36525;
    let L = 218.3165 + 481267.8813 * T;
    
    let moonLongitude = L % 360;
    if (moonLongitude < 0) moonLongitude += 360;
    
    return moonLongitude;
}

// Calcular posici√≥n planetaria (simplificado)
function getPlanetPosition(planet, date) {
    if (planet === 'moon') {
        return getMoonPosition(date);
    }
    
    const jd = getJulianDay(date);
    const T = (jd - 2451545.0) / 36525;
    
    const positions = {
        sun: 280.46646 + 36000.76983 * T,
        mercury: 252.25 + 149472.51529 * T,
        venus: 181.98 + 58517.81539 * T,
        mars: 355.43 + 19140.30268 * T,
        jupiter: 34.35 + 3034.74612 * T,
        saturn: 50.08 + 1222.49362 * T,
        uranus: 314.05 + 428.48202 * T,
        neptune: 304.35 + 218.48600 * T,
        pluto: 238.93 + 145.20780 * T,
        chiron: 139.52 + 15.09376 * T,
        lilith: 83.35 + 40.66246 * T
    };
    
    let longitude = positions[planet] % 360;
    if (longitude < 0) longitude += 360;
    
    return longitude;
}

// Obtener signo zodiacal desde longitud
function getZodiacSignFromLongitude(longitude) {
    const signs = [
        '‚ôà Aries', '‚ôâ Tauro', '‚ôä G√©minis', '‚ôã C√°ncer', 
        '‚ôå Leo', '‚ôç Virgo', '‚ôé Libra', '‚ôè Escorpio', 
        '‚ôê Sagitario', '‚ôë Capricornio', '‚ôí Acuario', '‚ôì Piscis'
    ];
    const signIndex = Math.floor(longitude / 30);
    return signs[signIndex];
}

// Calcular signo zodiacal de la Luna
function getMoonZodiacSign(date) {
    const moonLongitude = getMoonPosition(date);
    return getZodiacSignFromLongitude(moonLongitude);
}

// Calcular aspectos planetarios
function calculateAspects(date) {
    const aspects = [];
    const moonLongitude = getMoonPosition(date);
    
    const aspectTypes = [
        { name: 'conjunction', symbol: '‚òå', angle: 0, orb: 8, class: 'conjunction' },
        { name: 'sextile', symbol: '‚öπ', angle: 60, orb: 4, class: 'sextile' },
        { name: 'square', symbol: '‚ñ°', angle: 90, orb: 8, class: 'square' },
        { name: 'trine', symbol: '‚ñ≥', angle: 120, orb: 8, class: 'trine' },
        { name: 'opposition', symbol: '‚òç', angle: 180, orb: 8, class: 'opposition' }
    ];
    
    const planets = ['sun', 'mercury', 'venus', 'mars', 'jupiter', 'saturn', 'uranus', 'neptune', 'pluto', 'chiron', 'lilith'];
    
    for (const planet of planets) {
        const planetLongitude = getPlanetPosition(planet, date);
        let diff = Math.abs(moonLongitude - planetLongitude);
        
        if (diff > 180) diff = 360 - diff;
        
        for (const aspect of aspectTypes) {
            const aspectDiff = Math.abs(diff - aspect.angle);
            
            if (aspectDiff <= aspect.orb) {
                const planetSign = getZodiacSignFromLongitude(planetLongitude);
                
                aspects.push({
                    type: aspect.name,
                    symbol: aspect.symbol,
                    planet: planet,
                    planetSymbol: planetSymbols[planet],
                    planetName: planetNames[planet],
                    planetSign: planetSign,
                    exactness: aspect.orb - aspectDiff,
                    class: aspect.class,
                    description: aspectDescriptions[aspect.name]
                });
            }
        }
    }
    
    aspects.sort((a, b) => b.exactness - a.exactness);
    
    return aspects;
}

// C√°lculo de fase lunar (elongaci√≥n)
function calculateLunarPhase(date) {
    const jd = getJulianDay(date);
    const T = (jd - 2451545.0) / 36525;
    const L0 = 280.46646 + 36000.76983 * T;
    const L = 218.3165 + 481267.8813 * T;
    
    let elongation = (L - L0) % 360;
    if (elongation < 0) elongation += 360;
    
    return elongation;
}

function getMoonEmoji(elongation) {
    if (elongation < 22.5 || elongation >= 337.5) return 'üåë';
    if (elongation < 67.5) return 'üåí';
    if (elongation < 112.5) return 'üåì';
    if (elongation < 157.5) return 'üåî';
    if (elongation < 202.5) return 'üåï';
    if (elongation < 247.5) return 'üåñ';
    if (elongation < 292.5) return 'üåó';
    return 'üåò';
}

function getPhaseData(date) {
    const phase = calculateLunarPhase(date);
    let phaseName, weekIndex;
    
    if (phase < 0.05 || phase >= 0.95) {
        phaseName = 'Luna Nueva';
        weekIndex = 0;
    } else if (phase < 0.275) {
        phaseName = 'Cuarto Creciente';
        weekIndex = 1;
    } else if (phase < 0.525) {
        phaseName = 'Luna Llena';
        weekIndex = 2;
    } else if (phase < 0.775) {
        phaseName = 'Cuarto Menguante';
        weekIndex = 3;
    } else {
        phaseName = 'Luna Nueva';
        weekIndex = 0;
    }
    
    return { phase, phaseName, weekIndex, emoji: getMoonEmoji(phase) };
}

function findExactPerfection(startDate, targetDegree) {
    let date = new Date(startDate);
    let minDiff = 360;
    let bestDate = new Date(date);
    
    for (let day = 0; day < 10; day++) {
        for (let hour = 0; hour < 24; hour++) {
            let testDate = new Date(startDate);
            testDate.setDate(testDate.getDate() + day);
            testDate.setHours(hour, 0, 0, 0);
            
            let elongation = calculateLunarPhase(testDate);
            let diff = Math.abs(elongation - targetDegree);
            
            if (diff > 180) diff = 360 - diff;
            
            if (diff < minDiff) {
                minDiff = diff;
                bestDate = new Date(testDate);
            }
        }
    }
    
    return bestDate;
}

function findLunarPerfections(startDate) {
    const perfections = [];
    const phases = [
        { name: 'Luna Nueva', degree: 0, emoji: 'üåë' },
        { name: 'Cuarto Creciente', degree: 90, emoji: 'üåì' },
        { name: 'Luna Llena', degree: 180, emoji: 'üåï' },
        { name: 'Cuarto Menguante', degree: 270, emoji: 'üåó' }
    ];
    
    let searchDate = new Date(startDate);
    
    for (let i = 0; i < phases.length; i++) {
        const phase = phases[i];
        const perfectionDate = findExactPerfection(searchDate, phase.degree);
        const zodiacSign = getMoonZodiacSign(perfectionDate);
        
        let fullName = phase.name;
        if (phase.name === 'Luna Llena') {
            fullName = getFullMoonName(perfectionDate);
        }
        
        perfections.push({
            name: fullName,
            emoji: phase.emoji,
            date: perfectionDate,
            degree: phase.degree,
            zodiacSign: zodiacSign
        });
        
        searchDate = new Date(perfectionDate);
        searchDate.setDate(searchDate.getDate() + 1);
    }
    
    return perfections;
}

// Fechas exactas de Lunas Nuevas (datos astron√≥micos reales)
// Fuente: NASA/Observatorio Naval de EE.UU. + CHANI Astrology
const newMoonDates = [
    // 2024
    new Date('2024-12-01T06:21:00Z'),
    new Date('2024-12-30T22:27:00Z'),
    
    // 2025
    new Date('2025-01-29T12:36:00Z'),
    new Date('2025-02-27T20:45:00Z'),
    new Date('2025-03-29T10:58:00Z'),
    new Date('2025-04-27T19:31:00Z'),
    new Date('2025-05-27T03:02:00Z'),
    new Date('2025-06-25T10:32:00Z'),
    new Date('2025-07-24T19:11:00Z'),
    new Date('2025-08-23T06:06:00Z'),
    new Date('2025-09-21T19:54:00Z'),
    new Date('2025-10-21T12:25:00Z'),
    new Date('2025-11-20T06:47:00Z'),
    new Date('2025-12-20T01:43:00Z'),
    
    // 2026 - VERIFICADO con m√∫ltiples fuentes
    new Date('2026-01-18T19:52:00Z'),
    new Date('2026-02-17T12:11:00Z'),  // CORREGIDO: era 12:01
    new Date('2026-03-18T02:23:00Z'),  // CORREGIDO: era 03-19 01:23
    new Date('2026-04-17T11:52:00Z'),
    new Date('2026-05-16T20:01:00Z'),
    new Date('2026-06-15T02:54:00Z'),
    new Date('2026-07-14T09:44:00Z'),
    new Date('2026-08-12T17:37:00Z'),
    new Date('2026-09-11T03:27:00Z'),
    new Date('2026-10-10T16:00:00Z'),
    new Date('2026-11-09T07:02:00Z'),
    new Date('2026-12-09T00:52:00Z'),
    
    // 2027
    new Date('2027-01-07T19:24:00Z'),
    new Date('2027-02-06T13:56:00Z'),
    new Date('2027-03-08T06:29:00Z'),
    new Date('2027-04-06T19:51:00Z'),
    new Date('2027-05-06T06:58:00Z'),
    new Date('2027-06-04T16:10:00Z'),
    new Date('2027-07-03T23:02:00Z'),
    new Date('2027-08-02T04:45:00Z'),
    new Date('2027-08-31T10:41:00Z'),
    new Date('2027-09-29T18:36:00Z'),
    new Date('2027-10-29T05:36:00Z'),
    new Date('2027-11-27T20:25:00Z'),
    new Date('2027-12-27T13:13:00Z')
];

// Convertir fechas UTC a hora local (Costa Rica UTC-6)
const newMoonsLocal = newMoonDates.map(date => {
    const localDate = new Date(date);
    localDate.setHours(localDate.getHours() - 6);
    return localDate;
});

function findNearestNewMoon(date) {
    const searchDate = new Date(date);
    searchDate.setHours(0, 0, 0, 0);
    
    let closestMoon = newMoonsLocal[0];
    let minDiff = Math.abs(searchDate - closestMoon);
    
    for (const moonDate of newMoonsLocal) {
        const diff = Math.abs(searchDate - moonDate);
        if (diff < minDiff) {
            minDiff = diff;
            closestMoon = moonDate;
        }
    }
    
    return new Date(closestMoon);
}

function getNextNewMoon(currentNewMoon) {
    const currentTime = currentNewMoon.getTime();
    
    for (const moonDate of newMoonsLocal) {
        if (moonDate.getTime() > currentTime) {
            return new Date(moonDate);
        }
    }
    
    // Si no hay m√°s en la lista, estimar siguiente (29.53 d√≠as despu√©s)
    const nextMoon = new Date(currentNewMoon);
    nextMoon.setDate(nextMoon.getDate() + 30);
    return nextMoon;
}

function getPreviousNewMoon(currentNewMoon) {
    const currentTime = currentNewMoon.getTime();
    
    for (let i = newMoonsLocal.length - 1; i >= 0; i--) {
        if (newMoonsLocal[i].getTime() < currentTime) {
            return new Date(newMoonsLocal[i]);
        }
    }
    
    // Si no hay m√°s en la lista, estimar anterior (29.53 d√≠as antes)
    const prevMoon = new Date(currentNewMoon);
    prevMoon.setDate(prevMoon.getDate() - 30);
    return prevMoon;
}

function calculateLunarCycle(startDate) {
    const perfections = findLunarPerfections(startDate);
    const weeks = [];
    
    let nextNewMoonDate = new Date(perfections[3].date);
    nextNewMoonDate.setDate(nextNewMoonDate.getDate() + 1);
    const nextNewMoon = findExactPerfection(nextNewMoonDate, 0);
    
    let lunarDayCounter = 1;
    
    for (let i = 0; i < perfections.length; i++) {
        const currentPerfection = perfections[i];
        let nextPerfection;
        
        if (i < 3) {
            nextPerfection = perfections[i + 1];
        } else {
            nextPerfection = { date: nextNewMoon };
        }
        
        const startDate = new Date(currentPerfection.date);
        startDate.setHours(0, 0, 0, 0);
        
        const endDate = new Date(nextPerfection.date);
        endDate.setHours(0, 0, 0, 0);
        endDate.setDate(endDate.getDate() - 1);
        
        const days = [];
        let dayDate = new Date(startDate);
        
        while (dayDate <= endDate) {
            const isPerfectionDay = dayDate.getTime() === new Date(currentPerfection.date).setHours(0,0,0,0);
            const dayAspects = calculateAspects(dayDate);
            
            days.push({
                date: new Date(dayDate),
                dayNumber: dayDate.getDate(),
                month: dayDate.getMonth(),
                year: dayDate.getFullYear(),
                isPerfectionDay: isPerfectionDay,
                lunarDay: lunarDayCounter,
                aspects: dayAspects
            });
            
            lunarDayCounter++;
            dayDate.setDate(dayDate.getDate() + 1);
        }
        
        weeks.push({
            name: currentPerfection.name,
            emoji: currentPerfection.emoji,
            startDate: new Date(startDate),
            endDate: new Date(endDate),
            perfectionDate: currentPerfection.date,
            zodiacSign: currentPerfection.zodiacSign,
            days: days
        });
    }
    
    return weeks;
}

// ==============================================
// CALENDARIO LUNAR - L√ìGICA PRINCIPAL
// ==============================================

let currentCycleStart = findNearestNewMoon(new Date());
let selectedDate = null;
let selectedDayData = null;
let events = {};
let journals = {};
let autoSaveTimeout = null;

// ==============================================
// GESTI√ìN DE ALMACENAMIENTO
// ==============================================

function loadEvents() {
    const saved = localStorage.getItem('lunarCalendarEvents');
    if (saved) {
        events = JSON.parse(saved);
    }
}

function saveEvents() {
    localStorage.setItem('lunarCalendarEvents', JSON.stringify(events));
}

function loadJournals() {
    const saved = localStorage.getItem('lunarCalendarJournals');
    if (saved) {
        journals = JSON.parse(saved);
    }
}

function saveJournals() {
    localStorage.setItem('lunarCalendarJournals', JSON.stringify(journals));
}

function getDateKey(date) {
    return date.toISOString().split('T')[0];
}

function getEventsForDate(date) {
    const key = getDateKey(date);
    return events[key] || [];
}

function getJournalForDate(date) {
    const key = getDateKey(date);
    return journals[key] || '';
}

function saveJournalForDate(date, text) {
    const key = getDateKey(date);
    if (text.trim()) {
        journals[key] = text;
    } else {
        delete journals[key];
    }
    saveJournals();
}

// ==============================================
// UTILIDADES DE FORMATO
// ==============================================

function formatDate(date) {
    const months = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 
                  'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
    return `${date.getDate()} ${months[date.getMonth()]}`;
}

function formatShortDate(date) {
    const day = date.getDate();
    const month = date.getMonth() + 1;
    return `${day}/${month}`;
}

function formatLongDate(date) {
    const months = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 
                  'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
    return `${date.getDate()} ${months[date.getMonth()]} ${date.getFullYear()}`;
}

function formatTime(date) {
    const hours = date.getHours();
    const minutes = date.getMinutes();
    const ampm = hours >= 12 ? 'PM' : 'AM';
    const displayHours = hours % 12 || 12;
    return `${displayHours}:${minutes.toString().padStart(2, '0')} ${ampm}`;
}

function getWeekdayName(date) {
    const days = ['Dom', 'Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b'];
    return days[date.getDay()];
}

function isWeekend(date) {
    const day = date.getDay();
    return day === 0 || day === 6;
}

// ==============================================
// MODAL DE ASPECTOS Y DIARIO
// ==============================================

function openAspectsModal(date, lunarDay, dayData) {
    selectedDate = date;
    selectedDayData = dayData;
    const modal = document.getElementById('aspectsModal');
    
    document.getElementById('aspectsModalTitle').textContent = 
        `D√≠a ${lunarDay} - ${formatLongDate(date)} - Aspectos y Diario`;
    
    // Mostrar aspectos
    const aspectsDetails = document.getElementById('aspectsDetails');
    
    if (dayData.aspects && dayData.aspects.length > 0) {
        aspectsDetails.innerHTML = dayData.aspects.map(aspect => `
            <div class="aspect-detail ${aspect.class}">
                <div class="aspect-planets">
                    ${aspect.symbol} ‚òΩ-${aspect.planetSymbol} ${aspect.planetSign.split(' ')[1]}
                </div>
                <div class="aspect-description">
                    Luna en ${aspect.type} con ${aspect.planetName} - ${aspect.description}
                </div>
            </div>
        `).join('');
    } else {
        aspectsDetails.innerHTML = '<div class="no-aspects">No hay aspectos exactos para este d√≠a</div>';
    }
    
    // Cargar diario
    const journalText = document.getElementById('journalText');
    journalText.value = getJournalForDate(date);
    updateJournalWordCount();
    
    // Limpiar indicador de guardado
    document.getElementById('journalSaveStatus').textContent = '';
    
    // Event listener para auto-guardado
    journalText.oninput = function() {
        updateJournalWordCount();
        
        if (autoSaveTimeout) {
            clearTimeout(autoSaveTimeout);
        }
        
        document.getElementById('journalSaveStatus').innerHTML = 'üíæ Guardando...';
        
        autoSaveTimeout = setTimeout(() => {
            saveJournalForDate(selectedDate, journalText.value);
            document.getElementById('journalSaveStatus').innerHTML = '‚úì Guardado';
            setTimeout(() => {
                document.getElementById('journalSaveStatus').textContent = '';
            }, 2000);
        }, 1000);
    };
    
    modal.classList.add('show');
}

function updateJournalWordCount() {
    const text = document.getElementById('journalText').value;
    const words = text.trim() ? text.trim().split(/\s+/).length : 0;
    const chars = text.length;
    document.getElementById('journalWordCount').textContent = 
        `${words} palabra${words !== 1 ? 's' : ''} ‚Ä¢ ${chars} caracter${chars !== 1 ? 'es' : ''}`;
}

function closeAspectsModal() {
    // Guardar antes de cerrar
    if (selectedDate) {
        const journalText = document.getElementById('journalText').value;
        saveJournalForDate(selectedDate, journalText);
    }
    document.getElementById('aspectsModal').classList.remove('show');
}

// ==============================================
// MODAL DE EVENTOS/AGENDA
// ==============================================

function openEventsModal(date, lunarDay) {
    selectedDate = date;
    const modal = document.getElementById('eventsModal');
    const dayEvents = getEventsForDate(date);
    
    document.getElementById('eventsModalTitle').textContent = 
        `D√≠a ${lunarDay} - ${formatLongDate(date)} - Agenda`;
    
    if (dayEvents.length > 0) {
        showEventsList(dayEvents);
    } else {
        showEventForm();
    }
    
    modal.classList.add('show');
}

function showEventForm() {
    document.getElementById('eventForm').style.display = 'block';
    document.getElementById('eventsList').style.display = 'none';
    document.getElementById('eventTitle').value = '';
    document.getElementById('eventTime').value = '';
    document.getElementById('eventDescription').value = '';
    document.getElementById('eventType').value = 'event';
}

function showEventsList(dayEvents) {
    document.getElementById('eventForm').style.display = 'none';
    document.getElementById('eventsList').style.display = 'block';
    
    const container = document.getElementById('eventsContainer');
    
    if (dayEvents.length === 0) {
        container.innerHTML = '<div class="no-events">No hay eventos para este d√≠a</div>';
        return;
    }
    
    container.innerHTML = dayEvents.map((event, index) => `
        <div class="event-item type-${event.type}">
            <div class="event-title">${event.title}</div>
            ${event.time ? `<div class="event-time">‚è∞ ${event.time}</div>` : ''}
            ${event.description ? `<div class="event-description">${event.description}</div>` : ''}
            <div class="event-actions">
                <button class="btn btn-danger" onclick="deleteEvent(${index})">Eliminar</button>
            </div>
        </div>
    `).join('');
}

function saveEvent() {
    const title = document.getElementById('eventTitle').value.trim();
    if (!title) {
        alert('Por favor ingresa un t√≠tulo para el evento');
        return;
    }
    
    const event = {
        title: title,
        type: document.getElementById('eventType').value,
        time: document.getElementById('eventTime').value,
        description: document.getElementById('eventDescription').value.trim(),
        created: new Date().toISOString()
    };
    
    const key = getDateKey(selectedDate);
    if (!events[key]) {
        events[key] = [];
    }
    events[key].push(event);
    
    saveEvents();
    showEventsList(events[key]);
    renderCalendar();
}

function deleteEvent(index) {
    if (confirm('¬øEst√°s seguro de eliminar este evento?')) {
        const key = getDateKey(selectedDate);
        events[key].splice(index, 1);
        
        if (events[key].length === 0) {
            delete events[key];
        }
        
        saveEvents();
        showEventsList(events[key] || []);
        renderCalendar();
    }
}

function closeEventsModal() {
    document.getElementById('eventsModal').classList.remove('show');
}

// Cerrar modales al hacer clic fuera
window.onclick = function(event) {
    const aspectsModal = document.getElementById('aspectsModal');
    const eventsModal = document.getElementById('eventsModal');
    
    if (event.target === aspectsModal) {
        closeAspectsModal();
    }
    if (event.target === eventsModal) {
        closeEventsModal();
    }
}

// ==============================================
// RENDERIZADO DEL CALENDARIO
// ==============================================

function renderCalendar() {
    const weeks = calculateLunarCycle(currentCycleStart);
    const container = document.getElementById('lunarWeeks');
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    const cycleEnd = weeks[weeks.length - 1].endDate;
    document.getElementById('cycleNumber').textContent = 'Ciclo Lunar Completo';
    document.getElementById('cycleDates').textContent = 
        `${formatLongDate(weeks[0].startDate)} - ${formatLongDate(cycleEnd)}`;
    
    // SIEMPRE mostrar informaci√≥n del d√≠a actual, independiente del ciclo mostrado
    const todayNewMoon = findNearestNewMoon(today);
    const todayWeeks = calculateLunarCycle(todayNewMoon);
    
    let currentWeekIndex = -1;
    let currentDayInCycle = null;
    
    todayWeeks.forEach((week, index) => {
        week.days.forEach(day => {
            if (day.date.getTime() === today.getTime()) {
                currentWeekIndex = index;
                currentDayInCycle = day;
            }
        });
    });
    
    // Si no se encontr√≥ el d√≠a de hoy en el ciclo calculado, intentar con fecha m√°s precisa
    if (!currentDayInCycle) {
        console.log('D√≠a de hoy no encontrado en primer intento, buscando en lista completa...');
        // Buscar el ciclo que contiene hoy
        for (const newMoon of newMoonsLocal) {
            const testWeeks = calculateLunarCycle(newMoon);
            let found = false;
            testWeeks.forEach((week, index) => {
                week.days.forEach(day => {
                    if (day.date.getTime() === today.getTime()) {
                        currentWeekIndex = index;
                        currentDayInCycle = day;
                        found = true;
                    }
                });
            });
            if (found) break;
        }
    }
    
    // Mostrar t√≠tulo "Hoy" siempre (incluso si no se encuentra, mostrar info b√°sica)
    if (currentDayInCycle) {
        const elongation = calculateLunarPhase(new Date());
        const emoji = getMoonEmoji(elongation);
        const moonSign = getMoonZodiacSign(today);
        
        const weekDayNumber = todayWeeks[currentWeekIndex].days.findIndex(d => 
            d.date.getTime() === today.getTime()
        ) + 1;
        
        const todayAspects = currentDayInCycle.aspects;
        const todayEvents = getEventsForDate(today);
        
        document.getElementById('currentDayInfo').style.display = 'block';
        document.getElementById('currentDayInfo').innerHTML = `
            <div style="display: grid; grid-template-columns: ${todayEvents.length > 0 ? '1fr 1fr 1fr' : todayAspects.length > 0 ? '1fr 1fr' : '1fr'}; gap: 4px; align-items: start; font-size: 0.75em;">
                
                <!-- Izquierda: Eventos/Agenda -->
                ${todayEvents.length > 0 ? `
                <div style="background: rgba(0,0,0,0.15); padding: 4px 6px; border-radius: 4px; border-left: 2px solid #4ecdc4; min-width: 0;">
                    <div style="font-size: 0.65em; color: #4ecdc4; font-weight: bold; margin-bottom: 3px; text-transform: uppercase;">
                        <span>üìÖ Agenda</span>
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 2px;">
                        ${todayEvents.slice(0, 1).map(evt => `
                            <div style="font-size: 0.7em; padding: 2px 3px; background: rgba(78,205,196,0.2); border-radius: 3px; cursor: pointer; border-left: 2px solid ${evt.type === 'reminder' ? '#f5576c' : evt.type === 'appointment' ? '#f0e68c' : '#4ecdc4'}; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;"
                                 onclick="openEventsModal(new Date(${today.getTime()}), ${currentDayInCycle.lunarDay})">
                                <span style="overflow: hidden; text-overflow: ellipsis;">${evt.title}</span>
                            </div>
                        `).join('')}
                        ${todayEvents.length > 1 ? `<div style="font-size: 0.6em; text-align: center; color: #4ecdc4;">+${todayEvents.length - 1}</div>` : ''}
                    </div>
                </div>
                ` : ''}
                
                <!-- Centro: Info del d√≠a -->
                <div style="text-align: center;">
                    <div onclick="goToCurrentCycle()" style="font-size: 2.2em; font-weight: bold; margin-bottom: 2px; cursor: pointer; transition: all 0.2s; display: inline-block; line-height: 1;" 
                         onmouseover="this.style.transform='scale(1.05)'; this.style.color='#f0e68c';" 
                         onmouseout="this.style.transform='scale(1)'; this.style.color='inherit';"
                         title="Click para ir al ciclo actual">
                        ${currentDayInCycle.lunarDay}
                    </div>
                    <div style="font-size: 1.5em; margin: 2px 0;">${emoji}</div>
                    <div style="font-size: 0.65em; margin: 2px 0;">
                        S${currentWeekIndex + 1} ‚Ä¢ D${weekDayNumber}
                    </div>
                    <div style="font-size: 0.6em; margin: 2px 0;">
                        ${todayWeeks[currentWeekIndex].name}
                    </div>
                    <div style="font-size: 0.55em; opacity: 0.7; margin-top: 2px;">
                        ${moonSign}
                    </div>
                    <div style="font-size: 0.65em; font-weight: 600; margin-top: 3px; color: rgba(255, 255, 255, 0.95);">
                        ${formatLongDate(today)}
                    </div>
                </div>
                
                <!-- Derecha: Aspectos -->
                ${todayAspects.length > 0 ? `
                <div style="background: rgba(0,0,0,0.25); padding: 4px 6px; border-radius: 4px; border-left: 2px solid #f0e68c; min-width: 0;">
                    <div style="font-size: 0.65em; color: #f0e68c; font-weight: bold; margin-bottom: 3px; text-transform: uppercase;">
                        <span>‚≠ê Aspectos</span>
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 2px;">
                        ${todayAspects.slice(0, 2).map(asp => {
                            const color = asp.class === 'conjunction' ? '#ff6b6b' : 
                                         asp.class === 'sextile' ? '#4ecdc4' :
                                         asp.class === 'square' ? '#ff9f43' :
                                         asp.class === 'trine' ? '#5f27cd' : '#ee5a6f';
                            const dayDataStr = JSON.stringify(currentDayInCycle).replace(/'/g, "\\'").replace(/"/g, '&quot;');
                            return `
                            <div onclick="openAspectsModal(new Date(${today.getTime()}), ${currentDayInCycle.lunarDay}, JSON.parse('${dayDataStr}'))" 
                                 style="font-size: 0.7em; padding: 2px 3px; background: rgba(0,0,0,0.3); border-radius: 3px; cursor: pointer; display: flex; align-items: center; gap: 3px; border-left: 2px solid ${color};">
                                <span style="font-weight: bold; font-size: 1em; color: ${color};">${asp.symbol}</span>
                                <span style="color: #fff; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">‚òΩ-${asp.planetSymbol}</span>
                            </div>
                        `}).join('')}
                        ${todayAspects.length > 2 ? `<div style="font-size: 0.6em; text-align: center; color: #a8b2d1;">+${todayAspects.length - 2}</div>` : ''}
                    </div>
                </div>
                ` : ''}
            </div>
        `;
    }
    
    // Renderizar el ciclo mostrado (puede ser diferente al actual)
    let displayWeekIndex = -1;
    weeks.forEach((week, index) => {
        week.days.forEach(day => {
            if (day.date.getTime() === today.getTime()) {
                displayWeekIndex = index;
            }
        });
    });
    
    container.innerHTML = '';
    
    weeks.forEach((week, index) => {
        const weekDiv = document.createElement('div');
        weekDiv.className = 'lunar-week' + (index === currentWeekIndex ? ' active' : '');
        
        const daysHTML = week.days.map(day => {
            const isToday = day.date.getTime() === today.getTime();
            const dayEvents = getEventsForDate(day.date);
            const hasEvents = dayEvents.length > 0;
            const hasAspects = day.aspects.length > 0;
            const weekend = isWeekend(day.date);
            const weekday = getWeekdayName(day.date);
            
            // Solo mostrar eventos del usuario
            const eventsHTML = dayEvents.slice(0, 3).map(event => `
                <div class="day-event-item type-${event.type}">
                    ${event.time ? `<span class="event-time-badge">‚è∞</span>` : ''}${event.title}
                </div>
            `).join('');
            
            const moreEvents = dayEvents.length > 3 ? `
                <div style="text-align: center; font-style: italic; font-size: 0.85em; margin-top: 2px; color: #a8b2d1;">
                    +${dayEvents.length - 3} m√°s
                </div>
            ` : '';
            
            const dayDataStr = JSON.stringify(day).replace(/'/g, "\\'").replace(/"/g, '&quot;');
            
            return `
                <div class="day-cell ${isToday ? 'today' : ''} ${weekend ? 'weekend' : ''}" 
                     onclick="openEventsModal(new Date(${day.date.getTime()}), ${day.lunarDay})">
                    
                    <div class="day-header">
                        <div style="display: flex; align-items: flex-start; gap: 10px;">
                            <div class="day-number">${day.lunarDay}</div>
                            <div style="display: flex; flex-direction: column; align-items: flex-start; padding-top: 2px;">
                                <div class="day-date" style="font-size: 0.7em; color: rgba(255, 255, 255, 0.6); line-height: 1.2;">${formatShortDate(day.date)}</div>
                                <div class="day-weekday" style="font-size: 0.6em; color: rgba(255, 255, 255, 0.5); text-transform: uppercase; font-weight: 600; line-height: 1.2;">${weekday}</div>
                            </div>
                        </div>
                        ${hasAspects ? `
                            <div onclick="event.stopPropagation(); openAspectsModal(new Date(${day.date.getTime()}), ${day.lunarDay}, JSON.parse('${dayDataStr}'))"
                                 title="${day.aspects.length} aspecto${day.aspects.length > 1 ? 's' : ''}"
                                 style="background: linear-gradient(135deg, #f0e68c 0%, #f5c563 100%); color: #1a1a2e; width: 12px; height: 12px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.55em; font-weight: 900; cursor: pointer; transition: all 0.2s; box-shadow: 0 1px 2px rgba(240, 230, 140, 0.3); flex-shrink: 0;">
                                A
                            </div>
                        ` : ''}
                    </div>
                    
                    <div class="day-content">
                        ${eventsHTML}
                        ${moreEvents}
                    </div>
                </div>
            `;
        }).join('');
        
        weekDiv.innerHTML = `
            <div class="week-header">
                <div class="moon-icon">${week.emoji}</div>
                <div class="week-info">
                    <div style="display: flex; align-items: center; gap: 3px; flex-wrap: nowrap; font-size: 0.65em; width: 100%; overflow: hidden;">
                        <span style="font-weight: bold; white-space: nowrap;">${week.name}</span>
                        <span style="opacity: 0.6;">‚Ä¢</span>
                        <span style="white-space: nowrap;">${week.days.length}d</span>
                        <span style="opacity: 0.6;">‚Ä¢</span>
                        <span style="white-space: nowrap; font-size: 0.95em;">${formatDate(week.startDate).split(' ')[0]}-${formatDate(week.endDate).split(' ')[0]}</span>
                        <span style="opacity: 0.6;">‚Ä¢</span>
                        <span style="color: #f0e68c; white-space: nowrap; font-size: 0.95em;">${week.zodiacSign}</span>
                    </div>
                </div>
            </div>
            <div class="days-container">${daysHTML}</div>
        `;
        
        container.appendChild(weekDiv);
    });
}

function nextCycle() {
    currentCycleStart = getNextNewMoon(currentCycleStart);
    renderCalendar();
    window.scrollTo(0, 0);
}

function previousCycle() {
    currentCycleStart = getPreviousNewMoon(currentCycleStart);
    renderCalendar();
    window.scrollTo(0, 0);
}

function goToCurrentCycle() {
    console.log('üìç Navegando al ciclo actual...');
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    // Buscar el ciclo que contiene HOY
    let foundNewMoon = null;
    
    for (const newMoon of newMoonsLocal) {
        const cycleStart = new Date(newMoon);
        cycleStart.setHours(0, 0, 0, 0);
        
        // Calcular el final aproximado del ciclo (29 d√≠as despu√©s)
        const cycleEnd = new Date(cycleStart);
        cycleEnd.setDate(cycleEnd.getDate() + 29);
        
        // Si hoy est√° entre el inicio y fin de este ciclo
        if (today >= cycleStart && today <= cycleEnd) {
            foundNewMoon = new Date(newMoon);
            console.log(`‚úÖ Ciclo actual encontrado: ${foundNewMoon.toLocaleDateString()}`);
            break;
        }
    }
    
    if (foundNewMoon) {
        currentCycleStart = foundNewMoon;
    } else {
        console.log('‚ö†Ô∏è No se encontr√≥ ciclo exacto, usando el m√°s cercano');
        currentCycleStart = findNearestNewMoon(today);
    }
    
    renderCalendar();
    window.scrollTo(0, 0);
}

// ==============================================
// INICIALIZACI√ìN
// ==============================================

loadEvents();
loadJournals();
renderCalendar();
    </script>
</body>
</html>
